{% extends "layout.html" %}
{%load static%}

{%block css%}
<style>
    .network-collection-container {
        padding: 20px;
        background: #f5f5f5;
        min-height: 100vh;
        color: #333;
    }

    .network-collection-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }

    .control-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-label {
        font-size: 18px;
        color: #333;
        white-space: nowrap;
    }

    .control-select {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 120px;
    }

    #refreshIpBtn {
        background: #6c757d;
        color: white;
        border: 1px solid #6c757d;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
        transition: background-color 0.2s;
    }

    #refreshIpBtn:hover {
        background: #5a6268;
        border-color: #545b62;
    }

    #refreshIpBtn:disabled {
        background: #e9ecef;
        color: #6c757d;
        border-color: #dee2e6;
        cursor: not-allowed;
    }

    /* ç»Ÿä¸€æŒ‰é’®æ ·å¼è®¾è®¡ */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* å¼€å§‹é‡‡é›†æŒ‰é’® - ç»¿è‰²ç³» */
    #startBtn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: 1px solid #28a745;
    }

    #startBtn:hover {
        background: linear-gradient(135deg, #218838, #1ea080);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transform: translateY(-1px);
    }

    #startBtn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    /* åœæ­¢é‡‡é›†æŒ‰é’® - çº¢è‰²ç³» */
    #overBtn {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
        border: 1px solid #dc3545;
    }

    #overBtn:hover {
        background: linear-gradient(135deg, #c82333, #d62c1a);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        transform: translateY(-1px);
    }

    #overBtn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    /* å‘é€æŒ‡ä»¤æŒ‰é’® - è“è‰²ç³» */
    #sendCustomCmdBtn, #sendDefaultCmdBtn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: 1px solid #007bff;
        margin: 5px;
    }

    #sendCustomCmdBtn:hover, #sendDefaultCmdBtn:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        transform: translateY(-1px);
    }

    /* é‡ç½®æŒ‰é’® - æ©™è‰²ç³» */
    .btn-reset {
        background: linear-gradient(135deg, #fd7e14, #e55a00);
        color: white;
        border: 1px solid #fd7e14;
    }

    .btn-reset:hover {
        background: linear-gradient(135deg, #e55a00, #cc4900);
        box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3);
        transform: translateY(-1px);
    }

    .btn:disabled {
        background: #e9ecef !important;
        color: #6c757d !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
    }

    /* æŒ‰é’®ç»„é—´è· */
    .control-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-buttons .btn {
        margin: 0;
    }

    /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: white;
        border: 1px solid #6c757d;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268, #495057);
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        transform: translateY(-1px);
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }

    .control-input {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 100px;
    }

    .control-input::placeholder {
        color: #999;
    }

    .control-btn {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 20px;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .control-btn:hover {
        background: #e9ecef;
    }

    .control-btn.primary {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    .control-btn.primary:hover {
        background: #5a6268;
    }

    .control-btn.danger {
        background: #868e96;
        color: white;
        border-color: #868e96;
    }

    .control-btn.danger:hover {
        background: #6c757d;
    }

    .control-btn.ai {
        background: #495057;
        color: white;
        border-color: #495057;
    }

    .control-btn.ai:hover {
        background: #343a40;
    }

    .status-section {
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .status-input {
        width: 100%;
        max-width: 500px;
        height: 40px;
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #333;
        padding: 10px;
        font-size: 16px;
        resize: none;
    }

    .status-input::placeholder {
        color: #999;
    }

    .content-section {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .data-display-panel, .ai-suggestion-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 20px;
        color: #333;
        min-height: 200px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .panel-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }

    .panel-content {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        min-height: 150px;
        border: 1px solid #ddd;
    }

    .manual-optimization-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        color: #333;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .manual-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .manual-input {
        flex: 1;
        min-width: 250px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        background: white;
    }

    .manual-select {
        min-width: 200px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        background: white;
    }

    .manual-btn {
        background: #6c757d;
        color: white;
        border: 1px solid #6c757d;
        padding: 8px 20px;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .manual-btn:hover {
        background: #5a6268;
    }

    .feedback-section {
        margin-top: 15px;
    }

    .feedback-content {
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 15px;
        min-height: 100px;
        font-family: monospace;
        white-space: pre-wrap;
        color: #333;
    }

    .ai-suggestion-textarea {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        font-size: 14px;
        resize: vertical;
        background: white;
        color: #333;
        font-family: 'Courier New', monospace;
        line-height: 1.4;
    }
</style>
{%endblock%}

{%block content%}
<div class="network-collection-container">
    <h1 class="network-collection-title">ç½‘ç»œæ€§èƒ½æŒ‡æ ‡é‡‡é›†</h1>

    <!-- æ§åˆ¶åŒºåŸŸ -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">IPåœ°å€é€‰æ‹©ï¼š</span>
            <select class="control-select" id="ipSelect">
                <option value="">è¯·é€‰æ‹©æœåŠ¡å™¨IPåœ°å€...</option>
            </select>
            <button type="button" class="btn btn-sm btn-secondary" id="refreshIpBtn" title="åˆ·æ–°IPåœ°å€åˆ—è¡¨">
                <i class="fa fa-refresh"></i> åˆ·æ–°
            </button>
        </div>

        <div class="control-group">
            <span class="control-label">é€‰æ‹©ç«¯å£ï¼š</span>
            <input type="text" class="control-input" id="portInput" placeholder="7788" value="7788">
        </div>

        <div class="control-buttons">
            <button class="btn" id="startBtn">
                <i class="fa fa-play"></i> å¼€å§‹é‡‡é›†
            </button>
            <button class="btn" id="overBtn" disabled>
                <i class="fa fa-stop"></i> ç»“æŸé‡‡é›†
            </button>
            <button class="btn btn-reset" id="aiOptimizeBtn">
                <i class="fa fa-magic"></i> AIä¸€é”®è°ƒä¼˜
            </button>
        </div>
    </div>

    <!-- çŠ¶æ€åŒºåŸŸ -->
    <div class="status-section">
        <div class="control-group">
            <span class="control-label">çŠ¶æ€ï¼š</span>
            <textarea class="status-input" id="stateInfo" placeholder="ç­‰å¾…å¼€å§‹é‡‡é›†..." readonly></textarea>
        </div>
    </div>

    <!-- æ•°æ®å±•ç¤ºå’ŒAIå»ºè®®åŒºåŸŸ -->
    <div class="content-section">
        <div class="data-display-panel">
            <h3 class="panel-title">æ•°æ®å±•ç¤º</h3>
            <div class="panel-content xianShiPosition" id="dataDisplay">
                <p>æš‚æ— æ•°æ®ï¼Œè¯·å¼€å§‹é‡‡é›†...</p>
            </div>
        </div>

        <div class="ai-suggestion-panel">
            <h3 class="panel-title">AIè°ƒä¼˜å»ºè®®</h3>
            <div class="panel-content">
                <textarea class="ai-suggestion-textarea" id="aiSuggestionText" placeholder="AIè°ƒä¼˜å»ºè®®å°†åœ¨è¿™é‡Œæ˜¾ç¤º..." readonly></textarea>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨æŒ‡ä»¤è°ƒä¼˜åŒºåŸŸ -->
    <div class="manual-optimization-section">
        <h3 class="panel-title">æ‰‹åŠ¨æŒ‡ä»¤è°ƒä¼˜</h3>

        <div class="manual-controls">
            <input type="text" class="manual-input" id="customCmdInput" placeholder="è¾“å…¥è‡ªå®šä¹‰æŒ‡ä»¤">
            <button class="btn" id="sendCustomCmdBtn">
                <i class="fa fa-paper-plane"></i> å‘é€
            </button>

            <select class="manual-select" id="defaultCmdSelect">
                <option value="">é€‰æ‹©å¸¸ç”¨æŒ‡ä»¤</option>
                <option value="1">æŸ¥çœ‹é˜²ç«å¢™</option>
                <option value="2">å¼€å¯é˜²ç«å¢™</option>
                <option value="3">å…³é—­é˜²ç«å¢™</option>
                <option value="4">ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿ</option>
                <option value="18">æ¸…ç†ç³»ç»Ÿç¼“å­˜</option>
                <option value="19">æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ</option>
                <option value="20">é‡å¯NginxæœåŠ¡</option>
                <option value="26">é‡å¯MySQLæœåŠ¡</option>
                <option value="25">é‡å¯æœåŠ¡å™¨</option>
            </select>
            <button class="btn" id="sendDefaultCmdBtn">
                <i class="fa fa-paper-plane"></i> å‘é€
            </button>
        </div>

        <div class="feedback-section">
            <h4>æŒ‡ä»¤åé¦ˆ</h4>
            <div class="feedback-content" id="cmdFeedback">ç­‰å¾…æŒ‡ä»¤æ‰§è¡Œ...</div>
        </div>
    </div>
</div>
{%endblock%}

  {%block js%}
  <script>



    let hasCollectedData = false;
    let lastCollectedDataStr = null;

    // æŒ‰é’®çŠ¶æ€æ§åˆ¶å‡½æ•°
    function startBtnColorState(startBtn, overBtn) {
        startBtn.prop("disabled", true);
        overBtn.prop("disabled", false);
    }

    function endBtnColorState(startBtn, overBtn) {
        startBtn.prop("disabled", false);
        overBtn.prop("disabled", true);
    }

    // åŠ è½½æœåŠ¡å™¨IPåœ°å€åˆ—è¡¨
    function loadServerIpList() {
        console.log("Loading server IP list...");
        $("#refreshIpBtn").prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> åŠ è½½ä¸­...');

        $.ajax({
            url: "/api/JianKongFuWuQi/select/1-1000/oneModel",
            method: "POST",
            data: "{}",
            contentType: "application/json",
            success: function(response) {
                console.log("Server IP list loaded:", response);
                populateIpSelect(response);
                $("#refreshIpBtn").prop("disabled", false).html('<i class="fa fa-refresh"></i> åˆ·æ–°');
            },
            error: function(xhr, status, error) {
                console.error("Failed to load server IP list:", error);
                alert("è·å–æœåŠ¡å™¨IPåœ°å€åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ä¿¡æ¯ç®¡ç†ä¸­æ˜¯å¦æœ‰æ•°æ®");
                $("#refreshIpBtn").prop("disabled", false).html('<i class="fa fa-refresh"></i> åˆ·æ–°');
            }
        });
    }

    // å¡«å……IPé€‰æ‹©ä¸‹æ‹‰æ¡†
    function populateIpSelect(data) {
        var ipSelect = $("#ipSelect");
        ipSelect.empty();
        ipSelect.append('<option value="">è¯·é€‰æ‹©æœåŠ¡å™¨...</option>');

        if (data && data.all_data && data.all_data.length > 0) {
            data.all_data.forEach(function(server) {
                var displayText = "";
                // ä¼˜å…ˆæ˜¾ç¤ºå¤‡æ³¨åå­—ï¼Œå¦‚æœæ²¡æœ‰å¤‡æ³¨åˆ™æ˜¾ç¤ºIP
                if (server.remarks && server.remarks.trim() !== "") {
                    displayText = server.remarks;
                } else {
                    displayText = server.ip;
                }
                // åœ¨æ˜¾ç¤ºæ–‡æœ¬åé¢æ·»åŠ IPåœ°å€ä¿¡æ¯
                displayText += " (" + server.ip + ")";
                ipSelect.append('<option value="' + server.ip + '">' + displayText + '</option>');
            });
            console.log("Added " + data.all_data.length + " servers to select");
        } else {
            ipSelect.append('<option value="" disabled>æš‚æ— å¯ç”¨çš„æœåŠ¡å™¨</option>');
            console.log("No server data available");
        }
    }

    function caiJiShuJu(tp, model, ipValue) {
      requestTwoModel(tp, model, ipValue)
      paddingInfoStateIng()
    }
    function paddingInfoStateIng() {
      $("#stateInfo").text("æ­£åœ¨é‡‡é›†......")
    }
    function paddingInfoStateEnd() {
      $("#stateInfo").text("é‡‡é›†å®Œæˆ")
    }

    function handleCollectSuccess(data) {
      hasCollectedData = true;
      lastCollectedDataStr = JSON.stringify(data); // è½¬æˆå­—ç¬¦ä¸²
    }

    function onCollectSuccess(data) {
        console.log("é‡‡é›†å›è°ƒæ•°æ®ï¼š", data);
        handleCollectSuccess(data);
        paddingReturnData(data); // ç›´æ¥ä¼ å¯¹è±¡
    }

    function renderNetworkDataCard(data) {
      let info = data.info ? data.info : data;
      console.log("æ¸²æŸ“ info å­—æ®µï¼š", info);
      const netFieldMap = {
        net_in: { label: "å…¥ç½‘æµé‡", icon: "â¬†ï¸" },
        net_out: { label: "å‡ºç½‘æµé‡", icon: "â¬‡ï¸" },
        net_total: { label: "æ€»æµé‡", icon: "ğŸ”„" },
        net_speed: { label: "ç½‘é€Ÿ", icon: "âš¡" },
        host: { label: "ä¸»æœº", icon: "ğŸ–¥ï¸" },
        time: { label: "é‡‡é›†æ—¶é—´", icon: "â°" }
      };
      let html = '<div class="data-card" style="border:1px solid #eee; border-radius:8px; margin:8px 0; padding:10px; background:#fafbfc;">';
      // å…ˆæ¸²æŸ“å·²çŸ¥å­—æ®µ
      for (let key in netFieldMap) {
        if (info[key] !== undefined) {
          html += `<div style="margin:4px 0;">
            <span style="font-size:22px;">${netFieldMap[key].icon}</span>
            <span style="margin-left:8px; color:#333;">${netFieldMap[key].label}ï¼š</span>
            <span style="color:#007bff;">${info[key]}</span>
          </div>`;
        }
      }
      // å†æ¸²æŸ“æœªå®šä¹‰å­—æ®µ
      for (let key in info) {
        if (!netFieldMap[key]) {
          html += `<div style="margin:4px 0;">
            <span style="margin-left:8px; color:#333;">${key}ï¼š</span>
            <span style="color:#007bff;">${info[key]}</span>
          </div>`;
        }
      }
      html += '</div>';
      return html;
    }

    function paddingReturnData(dataObj) {
      var contentTag = $(".xianShiPosition");
      if (!dataObj || typeof dataObj !== 'object') {
        console.error("æ•°æ®å±•ç¤ºå¤±è´¥ï¼ŒdataObjä¸æ˜¯å¯¹è±¡", dataObj);
        return;
      }
      var html = renderNetworkDataCard(dataObj);
      var divTag = $("<div>").html(html);
      contentTag.append(divTag);
      if (contentTag.children().length >= 10) {
        contentTag.children().first().remove();
      }
    }

    function initialazeTwoIndex() {
      var tp = "network"
      var model = "get_ipadress"
      var values = ""
      requestTwoModel(tp, model, values)

      // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
      $("#startBtn").prop("disabled", false);
      $("#overBtn").prop("disabled", true);
    }

    $(document).ready(function () {
      var tp = "network"
      var model = ""
      var startBtn = $("#startBtn")
      var overBtn = $("#overBtn")

      // åˆå§‹åŒ–é¡µé¢
      initialazeTwoIndex()

      // åŠ è½½æœåŠ¡å™¨IPåœ°å€åˆ—è¡¨
      loadServerIpList()

      // åˆ·æ–°IPåœ°å€åˆ—è¡¨æŒ‰é’®äº‹ä»¶
      $("#refreshIpBtn").on("click", function() {
          loadServerIpList();
      });

      // IPåœ°å€é€‰æ‹©å˜åŒ–äº‹ä»¶
      $("#ipSelect").on("change", function() {
          var selectedIp = $(this).val();
          if (selectedIp) {
              console.log("Selected IP:", selectedIp);
          }
      });

      var caiJiState = ""
      var state = true

      startBtn.on("click", function () {
        model = "start_caiji"
        var ipValue = $("#ipSelect").val()
        var portValue = $("#portInput").val()

        // éªŒè¯IPåœ°å€æ˜¯å¦å·²é€‰æ‹©
        if (!ipValue || ipValue === "") {
          alert("è¯·é€‰æ‹©IPåœ°å€")
          return;
        }

        // éªŒè¯ç«¯å£æ˜¯å¦å·²è¾“å…¥
        if (!portValue || portValue === "") {
          alert("è¯·è¾“å…¥ç«¯å£")
          return;
        }

        startBtnColorState(startBtn, overBtn)

        if (state) {
          var values = JSON.stringify({ "ip": ipValue, "port": portValue })
          requestTwoModel(tp, model, values, function(data){
              onCollectSuccess(data);
          });
          paddingInfoStateIng()
          caiJiState = setInterval(function () {
            caiJiShuJu(tp, model, values);
          }, 30000);
          state = false
        }
        else {
          alert("æ­£åœ¨é‡‡é›†...")
        }

      })

      overBtn.on("click", function () {
        clearInterval(caiJiState)
        paddingInfoStateEnd()
        endBtnColorState(startBtn, overBtn)
        state = true
      })

      // IPåœ°å€é€‰æ‹©å˜åŒ–æ—¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„å¤„ç†é€»è¾‘
      $("#ipSelect").on("change", function() {
          var selectedIp = $(this).val();
          if (selectedIp) {
              console.log("Selected IP:", selectedIp);
              // è¿™é‡Œå¯ä»¥æ·»åŠ æ ¹æ®IPåœ°å€è·å–ç«¯å£çš„é€»è¾‘
              // æˆ–è€…å…¶ä»–ç›¸å…³çš„å¤„ç†
          }
      });

      // AIä¸€é”®è°ƒä¼˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      $("#aiOptimizeBtn").off("click").on("click", function () {
        if (!hasCollectedData || !lastCollectedDataStr) {
          alert("è¯·å…ˆé‡‡é›†æ•°æ®ï¼Œå†è¿›è¡ŒAIè°ƒä¼˜ï¼");
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $("#aiSuggestionText").val("AIæ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...");
        
        $.ajax({
          url: "/api/ai_optimize/", // ä½ éœ€è¦åœ¨åç«¯å®ç°è¿™ä¸ªAPI
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ collected_data: lastCollectedDataStr }),
          success: function (res) {
            var suggestionText = "";
            
            if (res.success && res.strategies) {
              // æ ¼å¼åŒ–AIå»ºè®®
              res.strategies.forEach(function(strategy, index) {
                suggestionText += `=== è°ƒä¼˜æ–¹æ¡ˆ ${index + 1} ===\n`;
                
                // éå†ç­–ç•¥å¯¹è±¡çš„æ‰€æœ‰é”®ï¼Œæ‰¾åˆ°è°ƒä¼˜æ–¹æ¡ˆ
                Object.keys(strategy).forEach(function(planKey) {
                  if (planKey.startsWith('è°ƒä¼˜æ–¹æ¡ˆ')) {
                    var plan = strategy[planKey];
                    var strategyName = planKey;
                    var strategyDesc = plan["ç­–ç•¥"] || "";
                    var strategyCmd = plan["å¯æ‰§è¡Œçš„æŒ‡ä»¤"] || "";
                    
                    suggestionText += `æ–¹æ¡ˆåç§°: ${strategyName}\n`;
                    suggestionText += `ç­–ç•¥æè¿°: ${strategyDesc}\n`;
                    if (strategyCmd) {
                      suggestionText += `å¯æ‰§è¡ŒæŒ‡ä»¤: ${strategyCmd}\n`;
                    }
                    suggestionText += "\n";
                  }
                });
                
                // å¦‚æœæ²¡æœ‰è°ƒä¼˜æ–¹æ¡ˆï¼Œä½†æœ‰ç­–ç•¥å­—æ®µï¼Œä¹Ÿæ˜¾ç¤º
                if (!Object.keys(strategy).some(key => key.startsWith('è°ƒä¼˜æ–¹æ¡ˆ')) && strategy["ç­–ç•¥"]) {
                  var strategyName = "ç­–ç•¥æ–¹æ¡ˆ" + (index + 1);
                  var strategyDesc = strategy["ç­–ç•¥"] || "";
                  var strategyCmd = strategy["å¯æ‰§è¡Œçš„æŒ‡ä»¤"] || "";
                  
                  suggestionText += `æ–¹æ¡ˆåç§°: ${strategyName}\n`;
                  suggestionText += `ç­–ç•¥æè¿°: ${strategyDesc}\n`;
                  if (strategyCmd) {
                    suggestionText += `å¯æ‰§è¡ŒæŒ‡ä»¤: ${strategyCmd}\n`;
                  }
                  suggestionText += "\n";
                }
              });
              
              if (suggestionText === "") {
                suggestionText = "AIåˆ†æå®Œæˆï¼Œä½†æœªæ‰¾åˆ°åˆé€‚çš„è°ƒä¼˜æ–¹æ¡ˆã€‚";
              }
            } else {
              suggestionText = res.result || "æ— AIå»ºè®®";
            }
            
            $("#aiSuggestionText").val(suggestionText);
          },
          error: function () {
            $("#aiSuggestionText").val("AIè°ƒä¼˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
          }
        });
      });

      // å‘é€è‡ªå®šä¹‰æŒ‡ä»¤
      $("#sendCustomCmdBtn").on("click", function(){
        var ip = $("#ipSelect").val();
        var port = $("#portInput").val();
        var cmd = $("#customCmdInput").val();
        if(!ip || !port || !cmd){
          $("#cmdFeedback").text("è¯·å¡«å†™IPã€ç«¯å£å’ŒæŒ‡ä»¤");
          return;
        }
        $("#cmdFeedback").text("æ­£åœ¨å‘é€è‡ªå®šä¹‰æŒ‡ä»¤...");
        $.ajax({
          url: "/api/return_cmd_four/",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ip: ip, port: port, cmdString: cmd, defaultCmdString: "0"}),
          success: function(res){
            $("#cmdFeedback").text("æ‰§è¡Œç»“æœï¼š\n" + res);
          },
          error: function(xhr){
            $("#cmdFeedback").text("è‡ªå®šä¹‰æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: " + xhr.responseText);
          }
        });
      });
      // å‘é€é»˜è®¤æŒ‡ä»¤
      $("#sendDefaultCmdBtn").on("click", function(){
        var ip = $("#ipSelect").val();
        var port = $("#portInput").val();
        var cmdId = $("#defaultCmdSelect").val();
        if(!ip || !port || !cmdId){
          $("#cmdFeedback").text("è¯·é€‰æ‹©IPã€ç«¯å£å’Œé»˜è®¤æŒ‡ä»¤");
          return;
        }
        $("#cmdFeedback").text("æ­£åœ¨å‘é€é»˜è®¤æŒ‡ä»¤...");
        $.ajax({
          url: "/api/return_cmd_four/",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ip: ip, port: port, cmdString: "0", defaultCmdString: cmdId}),
          success: function(res){
            $("#cmdFeedback").text("æ‰§è¡Œç»“æœï¼š\n" + res);
          },
          error: function(xhr){
            $("#cmdFeedback").text("é»˜è®¤æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: " + xhr.responseText);
          }
        });
      });
    });


  </script>
  {%endblock%}