{% extends "layout.html" %}
{%load static%}

{%block css%}
<style>
    /* 基础样式重置 */
    * {
        font-size: 16px;
        box-sizing: border-box;
    }

    /* 主容器样式 */
    .analysis-container {
        color: #333;
    }

    .analysis-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
        text-align: left;
    }

    /* 控制区域样式 */
    .control-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }

    .control-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-label {
        font-weight: 600;
        color: #333;
        min-width: 120px;
        font-size: 14px;
    }

    /* 统一按钮样式 */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: 1px solid #007bff;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        transform: translateY(-1px);
    }

    .btn:disabled {
        background: #e9ecef !important;
        color: #6c757d !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* 数据展示区域样式 */
    .data-panel {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        border: 1px solid #e0e0e0;
        width: 100%;
        box-sizing: border-box;
    }

    .panel-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    .panel-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        min-height: 300px;
        border: 1px solid #e9ecef;
        width: 100%;
        box-sizing: border-box;
    }

    /* 代码显示区域 */
    .code-display {
        background: #2d3748;
        color: #e2e8f0;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.5;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
    }

    /* 状态指示器 */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .status-loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

  .spinner {
    position: relative;
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    margin-left: -75px;
  }

  .spinner span {
    position: absolute;
    top: 50%;
    left: var(--left);
    width: 35px;
    height: 7px;
    background: #ffff;
    animation: dominos 1s ease infinite;
    box-shadow: 2px 2px 3px 0px black;
  }

  .spinner span:nth-child(1) {
    --left: 80px;
    animation-delay: 0.125s;
  }

  .spinner span:nth-child(2) {
    --left: 70px;
    animation-delay: 0.3s;
  }

  .spinner span:nth-child(3) {
    left: 60px;
    animation-delay: 0.425s;
  }

  .spinner span:nth-child(4) {
    animation-delay: 0.54s;
    left: 50px;
  }

  .spinner span:nth-child(5) {
    animation-delay: 0.665s;
    left: 40px;
  }

  .spinner span:nth-child(6) {
    animation-delay: 0.79s;
    left: 30px;
  }

  .spinner span:nth-child(7) {
    animation-delay: 0.915s;
    left: 20px;
  }

  .spinner span:nth-child(8) {
    left: 10px;
  }

  @keyframes dominos {
    50% {
      opacity: 0.7;
    }

    75% {
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg);
    }

    80% {
      opacity: 1;
    }
  }

  .spinner {
    position: absolute;
    right: 10%;
    margin-top: -1vh;
    /* width: 40%; */
  }




    /* 自定义下拉框样式 */
    .custom-select {
        position: relative;
        display: inline-block;
        min-width: 200px;
    }

    .select-selected {
        background-color: white;
        color: #333;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: border-color 0.3s ease;
    }

    .select-selected:after {
        content: "";
        position: absolute;
        top: 50%;
        right: 15px;
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-color: #666 transparent transparent transparent;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
        border-color: transparent transparent #666 transparent;
        transform: translateY(-50%) rotate(180deg);
    }

    .select-selected:hover {
        border-color: #007bff;
    }

    .select-items {
        position: absolute;
        background-color: white;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 99;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .select-items div {
        color: #333;
        padding: 10px 15px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .select-items div:hover {
        background-color: #f8f9fa;
    }

    .select-items div.selected {
        background-color: #007bff;
        color: white;
    }

    .select-hide {
        display: none;
    }

    /* 下拉框显示状态 */
    .select-items.show {
        display: block;
    }

    /* 空状态样式 */
    .select-items div.empty {
        color: #999;
        font-style: italic;
        cursor: default;
    }

    .select-items div.empty:hover {
        background-color: transparent;
    }

    /* 代码显示区域优化 */
    #biolatency,
    #ebpfInfoBox {
        width: 100%;
        height: 400px;
        font-size: 12px;
        background: #2d3748;
        color: #e2e8f0;
        font-family: 'Courier New', monospace;
        line-height: 1.5;
        padding: 15px;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 1px solid #4a5568;
    }
</style>
{%endblock%}

{%block content%}
<div class="analysis-container">
    <h1 class="analysis-title">IO栈数据统计分析</h1>

    <!-- 控制区域 -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">IP地址选择：</span>
            <div class="custom-select ip-select">
                <div class="select-selected ip-selected">选择IP</div>
                <div class="select-items ip-items" id="ipSelect">
                    <div>Option 1</div>
                    <div>Option 2</div>
                    <div>Option 3</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">选择端口：</span>
            <div class="custom-select port-select">
                <div class="select-selected port-selected">选择端口</div>
                <div class="select-items port-items" id="portSelect">
                    <div>Option 1</div>
                    <div>Option 2</div>
                    <div>Option 3</div>
                </div>
            </div>
        </div>

        <div class="control-buttons">
            <button class="btn btn-primary" id="sentBtn">
                <i class="fa fa-chart-line"></i> 开始最新分析
            </button>
        </div>

        <div class="control-group">
            <span class="status-indicator status-loading" id="statusIndicator" style="display: none;">
                <div class="spinner">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                正在分析数据...
            </span>
        </div>
    </div>

    <!-- 数据展示区域 -->
    <div class="content-section">
        <div class="data-panel">
            <h3 class="panel-title">biolatency - IO延迟分布分析</h3>
            <div class="panel-content">
                <pre id="biolatency" class="code-display">等待开始分析...</pre>
            </div>
        </div>

        <div class="data-panel">
            <h3 class="panel-title">文件 I/O 事件跟踪</h3>
            <div class="panel-content">
                <pre id="ebpfInfoBox" class="code-display">等待开始分析...</pre>
            </div>
        </div>
    </div>
</div>
{%endblock%}

{%block js%}
<script>
  var clickState = true

  function initialazeTwoIndex() {
    var tp = "disk"
    var model = "get_ipadress"
    var values = ""

    requestTwoModel(tp, model, values)
  }

  // IO数据查询函数
  function requestThreeModel(name, startTime, endTime, numberRange, ipValue) {
    var url = "/api/" + name + "/" + startTime + "/" + endTime + "/" + numberRange + "/" + ipValue + "/threeModel";
    $.ajax({
      url: url,
      method: "GET",
      timeout: 10000,
      success: function(response) {
        console.log("数据查询成功:", response);
        paddingContentThree(response);
      },
      error: function(xhr, status, error) {
        console.error("数据查询失败:", error);
        alert("数据查询失败，请检查网络连接或稍后重试");
      }
    });
  }

  // 填充数据到表格和图表
  function paddingContentThree(data) {
    var tbody = $("#tbodyContent");
    tbody.empty();

    if (data && data.all_data && data.all_data.length > 0) {
      data.all_data.forEach(function(item, index) {
        var row = "<tr>" +
          "<td>" + (index + 1) + "</td>" +
          "<td>" + (item.ipaddress || '-') + "</td>" +
          "<td>" + (item.total || '-') + "</td>" +
          "<td>" + (item.used || '-') + "</td>" +
          "<td>" + (item.free || '-') + "</td>" +
          "<td>" + (item.percent || '-') + "</td>" +
          "<td>" + (item.readCount || '-') + "</td>" +
          "<td>" + (item.writeCount || '-') + "</td>" +
          "<td>" + (item.readBytes || '-') + "</td>" +
          "<td>" + (item.writeBytes || '-') + "</td>" +
          "<td>" + (item.readTime || '-') + "</td>" +
          "<td>" + (item.writeTime || '-') + "</td>" +
          "<td>" + (item.currentTime || '-') + "</td>" +
          "</tr>";
        tbody.append(row);
      });

      // 更新图表
      updateIOChart(data.all_data);
    } else {
      tbody.append('<tr><td colspan="13" style="text-align: center;">暂无数据</td></tr>');
    }
  }

  // 更新IO性能图表
  function updateIOChart(data) {
    var chartDom = document.getElementById('echartsMain');
    var myChart = echarts.init(chartDom);

    var times = data.map(item => item.currentTime);
    var readBytesData = data.map(item => parseFloat(item.readBytes) || 0);
    var writeBytesData = data.map(item => parseFloat(item.writeBytes) || 0);
    var readCountData = data.map(item => parseFloat(item.readCount) || 0);
    var writeCountData = data.map(item => parseFloat(item.writeCount) || 0);

    var option = {
      title: {
        text: 'IO性能趋势'
      },
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['读取字节', '写入字节', '读取次数', '写入次数']
      },
      xAxis: {
        type: 'category',
        data: times
      },
      yAxis: [
        {
          type: 'value',
          name: '字节数'
        },
        {
          type: 'value',
          name: '次数'
        }
      ],
      series: [
        {
          name: '读取字节',
          type: 'line',
          yAxisIndex: 0,
          data: readBytesData
        },
        {
          name: '写入字节',
          type: 'line',
          yAxisIndex: 0,
          data: writeBytesData
        },
        {
          name: '读取次数',
          type: 'line',
          yAxisIndex: 1,
          data: readCountData
        },
        {
          name: '写入次数',
          type: 'line',
          yAxisIndex: 1,
          data: writeCountData
        }
      ]
    };

    myChart.setOption(option);
  }

  // 初始化自定义下拉框功能
  function initCustomSelects() {
    console.log("初始化自定义下拉框...");
    
    // IP选择框点击事件
    $(".ip-selected").on("click", function(e) {
      e.stopPropagation();
      
      // 关闭其他下拉框
      $(".port-items").hide();
      $(".port-selected").removeClass("select-arrow-active");
      
      // 切换当前下拉框
      $(".ip-items").toggle();
      $(this).toggleClass("select-arrow-active");
      
      console.log("IP选择框点击，下拉框显示状态:", $(".ip-items").is(":visible"));
    });

    // 端口选择框点击事件
    $(".port-selected").on("click", function(e) {
      e.stopPropagation();
      
      // 关闭其他下拉框
      $(".ip-items").hide();
      $(".ip-selected").removeClass("select-arrow-active");
      
      // 切换当前下拉框
      $(".port-items").toggle();
      $(this).toggleClass("select-arrow-active");
      
      console.log("端口选择框点击，下拉框显示状态:", $(".port-items").is(":visible"));
    });

    // 点击其他地方关闭下拉框
    $(document).on("click", function(e) {
      if (!$(e.target).closest('.custom-select').length) {
        $(".ip-items, .port-items").hide();
        $(".ip-selected, .port-selected").removeClass("select-arrow-active");
      }
    });
  }

  // 加载服务器IP地址列表
  function loadServerIpList() {
    console.log("Loading server IP list...")

    $.ajax({
      url: "/api/JianKongFuWuQi/select/1-1000/oneModel",
      method: "POST",
      data: "{}",
      contentType: "application/json",
      success: function(response) {
        console.log("Server IP list loaded:", response)
        populateIpSelect(response)
      },
      error: function(xhr, status, error) {
        console.error("Failed to load server IP list:", error)
        // 使用默认IP列表
        populateIpSelect({
          all_data: [
            {ip: "192.168.1.100", port: "7788", remarks: "服务器1"},
            {ip: "192.168.1.101", port: "7789", remarks: "服务器2"},
            {ip: "192.168.1.102", port: "7790", remarks: "服务器3"}
          ]
        })
      }
    })
  }

  // 填充IP选择下拉框
  function populateIpSelect(data) {
    console.log("填充IP下拉框，数据:", data);
    var ipItems = $("#ipSelect");
    ipItems.empty();

    if (data && data.all_data && data.all_data.length > 0) {
      data.all_data.forEach(function(server) {
        var displayText = server.ip;
        if (server.remarks && server.remarks.trim() !== "") {
          displayText += " (" + server.remarks + ")";
        }
        ipItems.append('<div class="ip-option" data-ip="' + server.ip + '" data-port="' + server.port + '">' + displayText + '</div>');
      });
      console.log("添加了 " + data.all_data.length + " 个IP地址选项");
    } else {
      ipItems.append('<div class="empty">暂无可用的服务器IP地址</div>');
      console.log("没有可用的服务器数据");
    }

    // 绑定IP选择事件
    ipItems.find(".ip-option").on("click", function(e) {
      e.stopPropagation(); // 阻止事件冒泡
      var selectedText = $(this).text();
      var selectedIp = $(this).data("ip");
      var selectedPort = $(this).data("port");

      console.log("选择IP:", selectedIp, "端口:", selectedPort);

      // 更新选中的文本
      $(".ip-selected").text(selectedText);
      
      // 隐藏下拉列表
      $(".ip-items").hide();
      $(".ip-selected").removeClass("select-arrow-active");

      // 加载对应的端口
      loadPortsForIp(selectedIp, selectedPort);
    });
  }

  // 为指定IP加载端口列表
  function loadPortsForIp(ip, defaultPort) {
    console.log("加载IP的端口列表:", ip, "默认端口:", defaultPort);
    var portItems = $("#portSelect");
    portItems.empty();

    // 常用端口列表
    var commonPorts = [
      {port: "7788", name: "默认端口"},
      {port: "22", name: "SSH"},
      {port: "80", name: "HTTP"},
      {port: "443", name: "HTTPS"},
      {port: "3306", name: "MySQL"},
      {port: "6379", name: "Redis"},
      {port: "8080", name: "Web服务"}
    ];

    // 如果有默认端口，优先显示
    if (defaultPort) {
      portItems.append('<div class="port-option" data-port="' + defaultPort + '">' + defaultPort + ' (推荐)</div>');
    }

    // 添加常用端口
    commonPorts.forEach(function(portInfo) {
      if (!defaultPort || portInfo.port !== defaultPort) {
        portItems.append('<div class="port-option" data-port="' + portInfo.port + '">' + portInfo.port + ' (' + portInfo.name + ')</div>');
      }
    });

    // 绑定端口选择事件
    portItems.find(".port-option").on("click", function(e) {
      e.stopPropagation(); // 阻止事件冒泡
      var selectedText = $(this).text();
      var selectedPort = $(this).data("port");

      console.log("选择端口:", selectedPort);

      // 更新选中的文本
      $(".port-selected").text(selectedText);
      
      // 隐藏下拉列表
      $(".port-items").hide();
      $(".port-selected").removeClass("select-arrow-active");
    });
  }

  $(document).ready(function () {
    console.log("IO栈数据统计分析页面初始化开始...")

    // 初始化页面
    initialazeTwoIndex()

    // 初始化自定义下拉框
    console.log("初始化自定义下拉框...")
    initCustomSelects()

    // 加载服务器IP地址列表
    console.log("加载服务器IP地址列表...")
    loadServerIpList()

    console.log("页面初始化完成！")

    $("#sentBtn").on("click", function () {
      var sentTag = $("#sentBtn")
      var statusIndicator = $("#statusIndicator")

      var ipText = $(".ip-selected").text()
      var portText = $(".port-selected").text()

      // 验证选择
      if (ipText === "选择IP" || ipText === "") {
        alert("请选择IP地址！")
        return
      }

      if (portText === "选择端口" || portText === "") {
        alert("请选择端口！")
        return
      }

      // 提取实际的IP和端口值
      var ipValue = ipText.split(" ")[0] // 获取IP地址部分（去掉备注）
      var portValue = portText.split(" ")[0] // 获取端口部分（去掉描述）

      // 显示加载状态
      statusIndicator.show().removeClass("status-success status-error").addClass("status-loading")

      // 禁用按钮
      sentTag.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> 分析中...')

      var valuesOne = { "ip": ipValue, "port": portValue, "command": "get_new_io_data" }
      var valuesTwo = { "ip": ipValue, "port": portValue, "command": "get_io_stack" }

      if (clickState) {
        requestfiveModel(valuesOne)
        requestfiveModel(valuesTwo)
        clickState = false
      }
    })
  })
  function requestfiveModel(values) {
    var url = "/api/fiveModel"
    $.ajax({
      url: url, // 替换为实际的服务器端处理程序的URL
      method: "POST", // 使用POST方法发送数据
      data: JSON.stringify(values), // 发送的数据对象
      contentType: "application/json",
      success: function (response) {
        console.log("IO分析响应:", values.command, response)

        if (values.command === "get_new_io_data") {
          // 更新biolatency显示区域
          $("#biolatency").html(response)
          console.log("biolatency数据已更新")
        }

        if (values.command === "get_io_stack") {
          // 更新IO栈显示区域
          $("#ebpfInfoBox").html(response)
          console.log("IO栈数据已更新")

          // 当两个请求都完成后，恢复UI状态
          clickState = true
          $("#statusIndicator").removeClass("status-loading").addClass("status-success")
          $("#statusIndicator span").text("分析完成")
          $("#sentBtn").prop("disabled", false).html('<i class="fa fa-chart-line"></i> 开始最新分析')

          // 3秒后隐藏状态指示器
          setTimeout(function() {
            $("#statusIndicator").hide()
          }, 3000)
        }
      },
      error: function (xhr, status, error) {
        console.error("IO分析失败:", values.command, error)

        // 恢复UI状态
        clickState = true
        $("#statusIndicator").removeClass("status-loading").addClass("status-error")
        $("#statusIndicator span").text("分析失败: " + values.command)
        $("#sentBtn").prop("disabled", false).html('<i class="fa fa-chart-line"></i> 开始最新分析')

        alert("IO栈分析请求失败: " + values.command)
      }
    });
  }
</script>
{%endblock%}