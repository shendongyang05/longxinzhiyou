{% extends "layout.html" %}
{%load static%}

{%block title%}DragonOptimize{%endblock%}

{%block css%}
<style>
    /* 基础样式重置 */
    * {
        font-size: 16px;
        box-sizing: border-box;
    }
    /* 主容器样式 */
    .analysis-container {
        color: #333;
    }
    .analysis-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
        text-align: left;
    }

    /* 控制区域样式 */
    .control-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .control-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-label {
        font-weight: 600;
        color: #333;
        min-width: 120px;
        font-size: 14px;
    }

    .control-select, .control-input {
        background: white;
        color: #333;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        min-width: 200px;
        transition: border-color 0.3s ease;
    }

    .control-select:focus, .control-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* 统一按钮样式 */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: 1px solid #007bff;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        transform: translateY(-1px);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: 1px solid #28a745;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838, #1ea080);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transform: translateY(-1px);
    }

    .btn:disabled {
        background: #e9ecef !important;
        color: #6c757d !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* 加载动画 */
    .spinner {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin: 20px auto;
    }

  .spinner span {
    position: absolute;
    top: 50%;
    left: var(--left);
    width: 35px;
    height: 7px;
    background: #ffff;
    animation: dominos 1s ease infinite;
    box-shadow: 2px 2px 3px 0px black;
  }

  .spinner span:nth-child(1) {
    --left: 80px;
    animation-delay: 0.125s;
  }

  .spinner span:nth-child(2) {
    --left: 70px;
    animation-delay: 0.3s;
  }

  .spinner span:nth-child(3) {
    left: 60px;
    animation-delay: 0.425s;
  }

  .spinner span:nth-child(4) {
    animation-delay: 0.54s;
    left: 50px;
  }

  .spinner span:nth-child(5) {
    animation-delay: 0.665s;
    left: 40px;
  }

  .spinner span:nth-child(6) {
    animation-delay: 0.79s;
    left: 30px;
  }

  .spinner span:nth-child(7) {
    animation-delay: 0.915s;
    left: 20px;
  }

  .spinner span:nth-child(8) {
    left: 10px;
  }

  @keyframes dominos {
    50% {
      opacity: 0.7;
    }

    75% {
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg);
    }

    80% {
      opacity: 1;
    }
  }

    /* 数据展示区域样式 */
    .content-section {
        display: block;
        margin-bottom: 25px;
    }

    .data-panel {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
        width: 100%;
        box-sizing: border-box;
    }

    .panel-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    .panel-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        min-height: 300px;
        border: 1px solid #e9ecef;
        width: 100%;
        box-sizing: border-box;
    }

    /* SVG容器样式 */
    #svgContainer {
        width: 100% !important;
        height: 400px;
        overflow: auto;
        background: white;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    /* 自定义下拉框样式 */
    .custom-select {
        position: relative;
        display: inline-block;
        min-width: 200px;
    }

    .select-selected {
        background-color: white;
        color: #333;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: border-color 0.3s ease;
    }

    .select-selected:after {
        content: "";
        position: absolute;
        top: 50%;
        right: 15px;
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-color: #666 transparent transparent transparent;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
        border-color: transparent transparent #666 transparent;
        transform: translateY(-50%) rotate(180deg);
    }

    .select-selected:hover {
        border-color: #007bff;
    }

    .select-items {
        position: absolute;
        background-color: white;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 99;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .select-items div {
        color: #333;
        padding: 10px 15px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .select-items div:hover {
        background-color: #f8f9fa;
    }

    .select-items div.selected {
        background-color: #007bff;
        color: white;
    }

    .select-hide {
        display: none;
    }

    /* 下拉框显示状态 */
    .select-items.show {
        display: block;
    }

    /* 空状态样式 */
    .select-items div.empty {
        color: #999;
        font-style: italic;
        cursor: default;
    }

    .select-items div.empty:hover {
        background-color: transparent;
    }

    /* 图表容器样式 */
    .chart-container {
        width: 100%;
        height: 400px;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* 状态指示器 */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .status-loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* 数据表格样式 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .data-table th,
    .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .analysis-container {
            padding: 15px;
        }

        .analysis-title {
            font-size: 2rem;
        }

        .control-group {
            flex-direction: column;
            align-items: flex-start;
        }

        .control-label {
            min-width: auto;
        }
    }
</style>
{%endblock%}

{%block content%}
<div class="analysis-container">
    <h1 class="analysis-title">CPU数据统计分析</h1>

    <!-- 控制区域 -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">开始日期：</span>
            <input class="control-input" id="startDate" type="date">
        </div>

        <div class="control-group">
            <span class="control-label">结束日期：</span>
            <input class="control-input" id="endDate" type="date">
        </div>

        <div class="control-group">
            <span class="control-label">IP地址选择：</span>
            <div class="custom-select ip-select">
                <div class="select-selected ip-selected">选择IP</div>
                <div class="select-items ip-items" id="ipSelect">
                    <div>Option 1</div>
                    <div>Option 2</div>
                    <div>Option 3</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">选择端口：</span>
            <div class="custom-select port-select">
                <div class="select-selected port-selected">选择端口</div>
                <div class="select-items port-items" id="portSelect">
                    <div>Option 1</div>
                    <div>Option 2</div>
                    <div>Option 3</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">页数选择：</span>
            <select class="control-select" id="pageRange">
                <option value="1-50">1-50页</option>
                <option value="1-100">1-100页</option>
                <option value="1-200">1-200页</option>
                <option value="1-500">1-500页</option>
            </select>
        </div>

        <div class="control-buttons">
            <button class="btn btn-primary" id="queryBtn">
                <i class="fa fa-search"></i> 查询数据
            </button>
            <button class="btn btn-success" id="exportBtn">
                <i class="fa fa-download"></i> 导出数据
            </button>
            <button class="btn btn-primary" id="sentBtn">
                <i class="fa fa-chart-line"></i> 开始最新分析
            </button>
        </div>

        <div class="control-group">
            <span class="status-indicator status-loading" id="statusIndicator" style="display: none;">
                <div class="spinner">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                正在分析数据...
            </span>
        </div>
    </div>

    <!-- 数据展示区域 -->
    <div class="content-section">
        <div class="data-panel">
            <h3 class="panel-title">性能分析图表</h3>
            <div class="panel-content">
                <div id="svgContainer" style="height: 400px; overflow: auto;"></div>
            </div>
        </div>
    </div>
</div>
{%endblock%}

{%block js%}
<script>
  function setSVGFle(img) {

    $.ajax({
      url: "/no_cache_image/" + img + "/",
      method: "GET",
      cache: false, // 禁用缓存
      success: function (data) {
        // 创建 Blob 对象
        const blob = new Blob([data], { type: 'image/svg+xml' });
        // 使用 URL.createObjectURL() 创建一个 URL
        const url = URL.createObjectURL(blob);
        console.log(url)
        // 创建一个 object 元素来显示 SVG 图像
        const $object = $('<object>').attr({
          type: 'image/svg+xml',
          data: url,
          width: '100%',
        });

        // 将 object 元素添加到页面中的某个容器中，例如 id 为 "svgContainer" 的 div 元素
        $('#svgContainer').empty().append($object);

      },
      error: function (xhr, status, error) {
        console.error("Error:", error);
      }
    });


  }


  function initialazeTwoIndex() {
    var tp = "disk"
    var model = "get_ipadress"
    var values = ""

    requestTwoModel(tp, model, values)
    $(".spinner").css("display", "none")
  }

  // CPU数据查询函数
  function requestThreeModel(name, startTime, endTime, numberRange, ipValue) {
    var url = "/api/" + name + "/" + startTime + "/" + endTime + "/" + numberRange + "/" + ipValue + "/threeModel";
    console.log("查询URL:", url);
    $.ajax({
      url: url,
      method: "GET",
      timeout: 10000,
      success: function(response) {
        console.log("数据查询成功:", response);
        paddingContentThree(response);
        // 隐藏加载状态
        $("#statusIndicator").hide();
      },
      error: function(xhr, status, error) {
        console.error("数据查询失败:", error);
        alert("数据查询失败，请检查网络连接或稍后重试");
        // 隐藏加载状态
        $("#statusIndicator").hide();
      }
    });
  }

  // 填充数据到图表
  function paddingContentThree(data) {
    console.log("处理数据:", data);
    
    if (data && data.all_data && data.all_data.length > 0) {
      console.log("找到数据，数量:", data.all_data.length);
      // 更新图表
      updateCPUChart(data.all_data);
      
      // 显示成功状态
      $("#statusIndicator").removeClass("status-loading status-error").addClass("status-success").show();
      setTimeout(function() {
        $("#statusIndicator").hide();
      }, 3000);
    } else {
      console.log("没有找到数据");
      // 显示错误状态
      $("#statusIndicator").removeClass("status-loading status-success").addClass("status-error").show();
      $("#statusIndicator").html("没有找到数据");
      setTimeout(function() {
        $("#statusIndicator").hide();
      }, 3000);
    }
  }

  // 更新CPU性能图表
  function updateCPUChart(data) {
    console.log("更新图表，数据:", data);
    
    // 创建图表容器
    var chartContainer = '<div id="echartsMain" style="width: 100%; height: 400px;"></div>';
    $('#svgContainer').html(chartContainer);
    
    // 等待DOM更新后初始化图表
    setTimeout(function() {
      var chartDom = document.getElementById('echartsMain');
      if (!chartDom) {
        console.error("图表容器未找到");
        return;
      }
      
      var myChart = echarts.init(chartDom);

      var times = data.map(item => item.currentTime || item.time || '');
      var userTimeData = data.map(item => parseFloat(item.userTime || item.user_time || 0));
      var systemTimeData = data.map(item => parseFloat(item.SystemTime || item.system_time || 0));
      var idleData = data.map(item => parseFloat(item.Idle || item.idle || 0));
      var percentData = data.map(item => parseFloat(item.percent || item.usage_percent || 0));

      var option = {
        title: {
          text: 'CPU使用趋势',
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'cross'
          }
        },
        legend: {
          data: ['用户时间', '系统时间', '空闲时间', '使用率(%)'],
          top: 30
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          top: '15%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: times,
          axisLabel: {
            rotate: 45
          }
        },
        yAxis: [
          {
            type: 'value',
            name: '时间百分比',
            position: 'left'
          },
          {
            type: 'value',
            name: '使用率(%)',
            max: 100,
            position: 'right'
          }
        ],
        series: [
          {
            name: '用户时间',
            type: 'line',
            yAxisIndex: 0,
            data: userTimeData,
            smooth: true,
            symbol: 'circle',
            symbolSize: 4
          },
          {
            name: '系统时间',
            type: 'line',
            yAxisIndex: 0,
            data: systemTimeData,
            smooth: true,
            symbol: 'circle',
            symbolSize: 4
          },
          {
            name: '空闲时间',
            type: 'line',
            yAxisIndex: 0,
            data: idleData,
            smooth: true,
            symbol: 'circle',
            symbolSize: 4
          },
          {
            name: '使用率(%)',
            type: 'line',
            yAxisIndex: 1,
            data: percentData,
            smooth: true,
            symbol: 'circle',
            symbolSize: 4
          }
        ]
      };

      myChart.setOption(option);
      
      // 响应式调整
      window.addEventListener('resize', function() {
        myChart.resize();
      });
      
    }, 100);
  }

  $(document).ready(function () {
    setSVGFle("perf.svg")
    var clickState = true
    var tp = "disk"
    initialazeTwoIndex()

    // 初始化自定义下拉框
    initCustomSelects()

    // 加载服务器IP地址列表
    loadServerIpList()

    // 设置默认日期
    var today = new Date();
    var oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    $("#startDate").val(oneWeekAgo.toISOString().split('T')[0]);
    $("#endDate").val(today.toISOString().split('T')[0]);

    // 查询数据按钮事件
    $("#queryBtn").on("click", function () {
      var startDate = $("#startDate").val();
      var endDate = $("#endDate").val();
      var ipText = $(".ip-selected").text();
      var pageRange = $("#pageRange").val();

      // 验证输入
      if (!startDate || !endDate) {
        alert("请选择开始日期和结束日期！");
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert("开始日期不能晚于结束日期！");
        return;
      }

      if (ipText === "选择IP" || ipText === "") {
        alert("请选择IP地址！");
        return;
      }

      // 提取实际的IP值
      var ipValue = ipText.split(" ")[0]; // 获取IP地址部分（去掉备注）

      // 显示加载状态
      var statusIndicator = $("#statusIndicator");
      statusIndicator.show().removeClass("status-success status-error").addClass("status-loading");

      // 调用查询函数
      requestThreeModel("cpu", startDate, endDate, pageRange, ipValue);
    });

    // 导出数据按钮事件
    $("#exportBtn").on("click", function () {
      alert("导出功能开发中...");
    });

    $("#sentBtn").on("click", function () {
      var sentTag = $("#sentBtn")
      var statusIndicator = $("#statusIndicator")

      var ipText = $(".ip-selected").text()
      var portText = $(".port-selected").text()

      // 验证选择
      if (ipText === "选择IP" || ipText === "") {
        alert("请选择IP地址！")
        return
      }

      if (portText === "选择端口" || portText === "") {
        alert("请选择端口！")
        return
      }

      // 提取实际的IP和端口值
      var ipValue = ipText.split(" ")[0] // 获取IP地址部分（去掉备注）
      var portValue = portText.split(" ")[0] // 获取端口部分（去掉描述）

      // 显示加载状态
      statusIndicator.show().removeClass("status-success status-error").addClass("status-loading")
      statusIndicator.find("span").text("正在分析数据...")

      // 禁用按钮
      sentTag.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> 分析中...')

      var values = JSON.stringify({ "ip": ipValue, "port": portValue, "command": "get_flame_graph" })

      if (clickState) {
        requestfiveModel(values)
      }
      if (clickState) {
        clickState = false
        setTimeout(function () {
          // 在这里执行你想要的操作，例如刷新页面
          $(".spinner").css("display", "none")
          endBtnColorState(sentTag, $("<div>"))

          // 示例中刷新页面，可以根据需要替换为其他操作
          clickState = true
        }, 60000); // 60000毫秒 = 60秒
      }
    })

    // 初始化自定义下拉框功能
    function initCustomSelects() {
      console.log("初始化自定义下拉框...");
      
      // IP选择框点击事件
      $(".ip-selected").on("click", function(e) {
        e.stopPropagation();
        
        // 关闭其他下拉框
        $(".port-items").hide();
        $(".port-selected").removeClass("select-arrow-active");
        
        // 切换当前下拉框
        $(".ip-items").toggle();
        $(this).toggleClass("select-arrow-active");
        
        console.log("IP选择框点击，下拉框显示状态:", $(".ip-items").is(":visible"));
      });

      // 端口选择框点击事件
      $(".port-selected").on("click", function(e) {
        e.stopPropagation();
        
        // 关闭其他下拉框
        $(".ip-items").hide();
        $(".ip-selected").removeClass("select-arrow-active");
        
        // 切换当前下拉框
        $(".port-items").toggle();
        $(this).toggleClass("select-arrow-active");
        
        console.log("端口选择框点击，下拉框显示状态:", $(".port-items").is(":visible"));
      });

      // 点击其他地方关闭下拉框
      $(document).on("click", function(e) {
        if (!$(e.target).closest('.custom-select').length) {
          $(".ip-items, .port-items").hide();
          $(".ip-selected, .port-selected").removeClass("select-arrow-active");
        }
      });
    }

    // 加载服务器IP地址列表
    function loadServerIpList() {
      console.log("Loading server IP list...")

      $.ajax({
        url: "/api/JianKongFuWuQi/select/1-1000/oneModel",
        method: "POST",
        data: "{}",
        contentType: "application/json",
        success: function(response) {
          console.log("Server IP list loaded:", response)
          populateIpSelect(response)
        },
        error: function(xhr, status, error) {
          console.error("Failed to load server IP list:", error)
          // 使用默认IP列表
          populateIpSelect({
            all_data: [
              {ip: "192.168.1.100", port: "7788", remarks: "服务器1"},
              {ip: "192.168.1.101", port: "7789", remarks: "服务器2"},
              {ip: "192.168.1.102", port: "7790", remarks: "服务器3"}
            ]
          })
        }
      })
    }

    // 填充IP选择下拉框
    function populateIpSelect(data) {
      console.log("填充IP下拉框，数据:", data);
      var ipItems = $("#ipSelect");
      ipItems.empty();

      if (data && data.all_data && data.all_data.length > 0) {
        data.all_data.forEach(function(server) {
          var displayText = server.ip;
          if (server.remarks && server.remarks.trim() !== "") {
            displayText += " (" + server.remarks + ")";
          }
          ipItems.append('<div class="ip-option" data-ip="' + server.ip + '" data-port="' + server.port + '">' + displayText + '</div>');
        });
        console.log("添加了 " + data.all_data.length + " 个IP地址选项");
      } else {
        ipItems.append('<div class="empty">暂无可用的服务器IP地址</div>');
        console.log("没有可用的服务器数据");
      }

      // 绑定IP选择事件
      ipItems.find(".ip-option").on("click", function(e) {
        e.stopPropagation(); // 阻止事件冒泡
        var selectedText = $(this).text();
        var selectedIp = $(this).data("ip");
        var selectedPort = $(this).data("port");

        console.log("选择IP:", selectedIp, "端口:", selectedPort);

        // 更新选中的文本
        $(".ip-selected").text(selectedText);
        
        // 隐藏下拉列表
        $(".ip-items").hide();
        $(".ip-selected").removeClass("select-arrow-active");

        // 加载对应的端口
        loadPortsForIp(selectedIp, selectedPort);
      });
    }

    // 为指定IP加载端口列表
    function loadPortsForIp(ip, defaultPort) {
      console.log("加载IP的端口列表:", ip, "默认端口:", defaultPort);
      var portItems = $("#portSelect");
      portItems.empty();

      // 常用端口列表
      var commonPorts = [
        {port: "7788", name: "默认端口"},
        {port: "22", name: "SSH"},
        {port: "80", name: "HTTP"},
        {port: "443", name: "HTTPS"},
        {port: "3306", name: "MySQL"},
        {port: "6379", name: "Redis"},
        {port: "8080", name: "Web服务"}
      ];

      // 如果有默认端口，优先显示
      if (defaultPort) {
        portItems.append('<div class="port-option" data-port="' + defaultPort + '">' + defaultPort + ' (推荐)</div>');
      }

      // 添加常用端口
      commonPorts.forEach(function(portInfo) {
        if (!defaultPort || portInfo.port !== defaultPort) {
          portItems.append('<div class="port-option" data-port="' + portInfo.port + '">' + portInfo.port + ' (' + portInfo.name + ')</div>');
        }
      });

      // 绑定端口选择事件
      portItems.find(".port-option").on("click", function(e) {
        e.stopPropagation(); // 阻止事件冒泡
        var selectedText = $(this).text();
        var selectedPort = $(this).data("port");

        console.log("选择端口:", selectedPort);

        // 更新选中的文本
        $(".port-selected").text(selectedText);
        
        // 隐藏下拉列表
        $(".port-items").hide();
        $(".port-selected").removeClass("select-arrow-active");
      });
    }
  })


  function requestfiveModel(values) {
    var url = "/api/fiveModel"
    $.ajax({
      url: url, // 替换为实际的服务器端处理程序的URL
      method: "POST", // 使用POST方法发送数据
      data: values, // 发送的数据对象
      contentType: "application/json",
      success: function (response) {
        location.reload()
      },
      error: function (xhr, status, error) {
        // 请求失败时执行的操作
        alert("请求失败");
      }
    });
  }
</script>
{%endblock%}