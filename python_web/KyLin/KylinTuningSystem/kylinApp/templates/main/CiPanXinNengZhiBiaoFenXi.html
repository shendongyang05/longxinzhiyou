{%extends "layout.html"%}
{%load static%}

{%block css%}
<style>
    /* 基础样式重置 */
    * {
        font-size: 16px;
        box-sizing: border-box;
    }

    /* 主容器样式 */
    .analysis-container {
        color: #333;
    }

    .analysis-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
        text-align: left;
    }

    /* 控制区域样式 */
    .control-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .control-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-label {
        font-weight: 600;
        color: #333;
        min-width: 120px;
        font-size: 14px;
    }

    .control-select, .control-input {
        background: white;
        color: #333;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        min-width: 200px;
        transition: border-color 0.3s ease;
    }

    .control-select:focus, .control-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* 统一按钮样式 */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: 1px solid #007bff;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        transform: translateY(-1px);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: 1px solid #28a745;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838, #1ea080);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: white;
        border: 1px solid #6c757d;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268, #495057);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        transform: translateY(-1px);
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    /* 控制按钮组 */
    .control-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    /* 数据面板样式 */
    .data-panel {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .panel-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    /* 表格样式 */
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .table th, .table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .table tr:hover {
        background: #f8f9fa;
    }

    /* 自定义下拉框样式 */
    .custom-select {
        position: relative;
        min-width: 200px;
    }

    .select-selected {
        background: white;
        color: #333;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: border-color 0.3s ease;
    }

    .select-selected:after {
        content: "";
        position: absolute;
        top: 50%;
        right: 15px;
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-color: #666 transparent transparent transparent;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
        border-color: transparent transparent #666 transparent;
        transform: translateY(-50%) rotate(180deg);
    }

    .select-selected:hover {
        border-color: #007bff;
    }

    /* 加载状态样式 */
    .select-selected.loading {
        color: #666;
        font-style: italic;
        background-color: #f8f9fa;
    }

    .select-selected.loading:after {
        border-color: #999 transparent transparent transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    .select-items {
        position: absolute;
        background-color: white;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 99;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .select-items div {
        color: #333;
        padding: 10px 15px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .select-items div:hover {
        background-color: #f8f9fa;
    }

    .select-items div.selected {
        background-color: #007bff;
        color: white;
    }

    /* IP选项样式 */
    .ip-option {
        border-bottom: 1px solid #eee;
    }

    .ip-option:last-child {
        border-bottom: none;
    }

    .ip-option:hover {
        background-color: #e3f2fd !important;
        color: #1976d2 !important;
    }

    .empty {
        color: #999;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }

    /* 状态指示器 */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .status-loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{%endblock%}

{%block content%}
<div class="analysis-container">
    <h1 class="analysis-title">磁盘性能指标分析</h1>

    <!-- 控制区域 -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">开始日期：</span>
            <input class="control-input" id="startDate" type="date">
        </div>

        <div class="control-group">
            <span class="control-label">结束日期：</span>
            <input class="control-input" id="endDate" type="date">
        </div>

        <div class="control-group">
            <span class="control-label">IP地址选择：</span>
            <div class="custom-select ip-select">
                <div class="select-selected ip-selected">选择IP</div>
                <div class="select-items ip-items" id="ipSelect" style="display: none;">
                    <div>Option 1</div>
                    <div>Option 2</div>
                    <div>Option 3</div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" id="refreshIpBtn" title="刷新IP地址列表" style="margin-left: 10px;">
                <i class="fa fa-refresh"></i> 刷新
            </button>
        </div>

        <div class="control-group">
            <span class="control-label">页数选择：</span>
            <select class="control-select" id="pageSelect">
                <option value="1-50">1-50页</option>
                <option value="50-100">50-100页</option>
                <option value="100-150">100-150页</option>
            </select>
        </div>

        <div class="control-buttons">
            <button class="btn btn-primary" id="selectTwoModel">
                <i class="fa fa-search"></i> 查询数据
            </button>
            <button class="btn btn-success" id="exportDataBtn">
                <i class="fa fa-download"></i> 导出数据
            </button>
        </div>

        <div class="control-group">
            <span class="status-indicator status-loading" id="statusIndicator" style="display: none;">
                <i class="fa fa-spinner fa-spin"></i>
                正在查询数据...
            </span>
        </div>
    </div>

    <!-- 数据展示区域 -->
    <div class="content-section">
        <div class="data-panel">
            <h3 class="panel-title">磁盘性能数据表格</h3>
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>IP地址</th>
                            <th>总容量</th>
                            <th>已用容量</th>
                            <th>空闲容量</th>
                            <th>使用率</th>
                            <th>当前时间</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyContent">
                        <!-- 动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="data-panel">
            <h3 class="panel-title">磁盘性能趋势图表</h3>
            <div id="echartsMain" style="width: 100%; height: 400px; background: #f8f9fa; border-radius: 4px;"></div>
        </div>
    </div>
</div>
{%endblock%}

{%block js%}
<script>
  // 磁盘性能数据查询函数
  function requestThreeModel(name, startTime, endTime, numberRange, ipValue) {
    // 参数验证
    if (!startTime || !endTime) {
      console.warn("日期参数不完整，跳过查询")
      return
    }
    
    var url = "/api/" + name + "/" + startTime + "/" + endTime + "/" + numberRange + "/" + ipValue + "/threeModel";
    console.log("查询URL:", url)
    console.log("查询参数:", {name, startTime, endTime, numberRange, ipValue})
    
    $.ajax({
      url: url,
      method: "GET",
      timeout: 15000, // 增加超时时间
      success: function(response) {
        console.log("数据查询成功:", response);
        if (response && (response.all_data || response.data)) {
          paddingContentThree(response);
        } else {
          console.warn("查询成功但数据为空:", response);
          paddingContentThree({all_data: []}); // 显示空数据状态
        }
      },
      error: function(xhr, status, error) {
        console.error("数据查询失败:", {xhr, status, error});
        
        // 根据错误类型提供更友好的提示
        var errorMessage = "数据查询失败";
        if (status === "timeout") {
          errorMessage = "查询超时，请稍后重试";
        } else if (xhr.status === 404) {
          errorMessage = "接口不存在，请联系管理员";
        } else if (xhr.status === 500) {
          errorMessage = "服务器内部错误，请稍后重试";
        } else if (xhr.status === 0) {
          errorMessage = "网络连接失败，请检查网络设置";
        }
        
        // 使用更友好的提示方式，而不是alert
        showErrorMessage(errorMessage);
        
        // 显示空数据状态
        paddingContentThree({all_data: []});
      }
    });
  }

  // 填充数据到表格和图表
  function paddingContentThree(data) {
    var tbody = $("#tbodyContent");
    tbody.empty();

    if (data && data.all_data && data.all_data.length > 0) {
      data.all_data.forEach(function(item, index) {
        var row = "<tr>" +
          "<td>" + (index + 1) + "</td>" +
          "<td>" + (item.ipaddress || '-') + "</td>" +
          "<td>" + (item.totalCapacity || '-') + "</td>" +
          "<td>" + (item.usedSpace || '-') + "</td>" +
          "<td>" + (item.availableSpace || '-') + "</td>" +
          "<td>" + (item.usagePercentage || '-') + "</td>" +
          "<td>" + (item.currentTime || '-') + "</td>" +
          "</tr>";
        tbody.append(row);
      });

      // 更新图表
      updateDiskChart(data.all_data);
    } else {
      tbody.append('<tr><td colspan="7" style="text-align: center;">暂无数据</td></tr>');
    }
  }

  // 更新磁盘性能图表
  function updateDiskChart(data) {
    var chartDom = document.getElementById('echartsMain');
    if (!chartDom) {
      console.warn("图表容器不存在");
      return;
    }
    
    var myChart = echarts.init(chartDom);

    // 检查数据是否有效
    if (!data || data.length === 0) {
      // 显示无数据状态
      var option = {
        title: {
          text: '磁盘性能趋势',
          subtext: '暂无数据',
          left: 'center',
          top: 'center'
        },
        graphic: {
          type: 'text',
          left: 'center',
          top: '60%',
          style: {
            text: '请先查询数据',
            fontSize: 16,
            fill: '#999'
          }
        }
      };
      myChart.setOption(option);
      return;
    }

    var times = data.map(item => item.currentTime || '未知时间');
    var usageData = data.map(item => parseFloat(item.usagePercentage) || 0);

    var option = {
      title: {
        text: '磁盘性能趋势'
      },
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['使用率(%)']
      },
      xAxis: {
        type: 'category',
        data: times
      },
      yAxis: {
        type: 'value',
        name: '使用率(%)',
        max: 100
      },
      series: [
        {
          name: '使用率(%)',
          type: 'line',
          data: usageData,
          smooth: true,
          lineStyle: {
            color: '#007bff'
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0, y: 0, x2: 0, y2: 1,
              colorStops: [
                {offset: 0, color: 'rgba(0,123,255,0.3)'},
                {offset: 1, color: 'rgba(0,123,255,0.1)'}
              ]
            }
          }
        }
      ]
    };

    myChart.setOption(option);
  }

  function initialazeTwoIndex() {
    var tp = "disk"
    var model = "get_ipadress"
    var values = ""

    // 设置默认日期为今天
    var today = new Date()
    var todayStr = today.toISOString().split('T')[0]
    
    // 设置开始日期和结束日期为今天
    $("#startDate").val(todayStr)
    $("#endDate").val(todayStr)
    
    console.log("设置默认日期:", todayStr)

    requestTwoModel(tp, model, values)
  }
  // 加载服务器IP地址列表
  function loadServerIpList() {
    return new Promise(function(resolve, reject) {
      console.log("Loading server IP list...")
      
      // 显示加载状态
      $(".ip-selected").text("加载中...").addClass("loading")
      
      $.ajax({
        url: "/api/JianKongFuWuQi/select/1-1000/oneModel",
        method: "POST",
        data: "{}",
        contentType: "application/json",
        timeout: 10000,
        success: function(response) {
          console.log("Server IP list loaded:", response)
          if (response && response.all_data && response.all_data.length > 0) {
            populateIpSelect(response)
            resolve(response)
          } else {
            console.warn("No server data in response:", response)
            // 尝试使用备用接口
            loadBackupServerList().then(resolve).catch(reject)
          }
        },
        error: function(xhr, status, error) {
          console.error("Failed to load server IP list:", error)
          console.error("Status:", status)
          console.error("Response:", xhr.responseText)
          
          // 使用默认IP列表作为备用方案
          populateIpSelect({
            all_data: [
              {ip: "192.168.1.100", port: "7788", remarks: "麒麟服务器1"},
              {ip: "192.168.1.101", port: "7789", remarks: "欧拉服务器"},
              {ip: "192.168.1.102", port: "7790", remarks: "测试服务器"}
            ]
          })
          resolve() // 即使失败也resolve，避免阻塞页面
        }
      })
    })
  }

  // 备用服务器列表加载
  function loadBackupServerList() {
    return new Promise(function(resolve, reject) {
      console.log("Trying backup server list...")
      
      // 尝试从其他接口获取数据
      $.ajax({
        url: "/api/FuWuXinXi/select/1-1000/oneModel",
        method: "POST",
        data: "{}",
        contentType: "application/json",
        timeout: 5000,
        success: function(response) {
          console.log("Backup server list loaded:", response)
          if (response && response.all_data && response.all_data.length > 0) {
            populateIpSelect(response)
            resolve(response)
          } else {
            // 使用硬编码的默认列表
            populateIpSelect({
              all_data: [
                {ip: "192.168.1.100", port: "7788", remarks: "麒麟服务器1"},
                {ip: "192.168.1.101", port: "7789", remarks: "欧拉服务器"},
                {ip: "192.168.1.102", port: "7790", remarks: "测试服务器"}
              ]
            })
            resolve()
          }
        },
        error: function() {
          // 使用硬编码的默认列表
          populateIpSelect({
            all_data: [
              {ip: "192.168.1.100", port: "7788", remarks: "麒麟服务器1"},
              {ip: "192.168.1.101", port: "7789", remarks: "欧拉服务器"},
              {ip: "192.168.1.102", port: "7790", remarks: "测试服务器"}
            ]
          })
          resolve()
        }
      })
    })
  }

  // 显示友好的错误提示
  function showErrorMessage(message) {
    // 移除已存在的错误提示
    $(".error-message").remove();
    
    var errorHtml = `
      <div class="error-message" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 400px;
        text-align: center;
      ">
        <div style="color: #ff6b6b; font-size: 18px; margin-bottom: 10px;">⚠️ 提示</div>
        <div style="color: #333; margin-bottom: 20px;">${message}</div>
        <button onclick="$(this).closest('.error-message').remove()" style="
          background: #007bff;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
        ">确定</button>
      </div>
    `;
    
    $("body").append(errorHtml);
    
    // 3秒后自动消失
    setTimeout(function() {
      $(".error-message").fadeOut(function() {
        $(this).remove();
      });
    }, 3000);
  }

  // 填充IP选择下拉框
  function populateIpSelect(data) {
    var ipItems = $("#ipSelect")
    ipItems.empty()

    if (data && data.all_data && data.all_data.length > 0) {
      data.all_data.forEach(function(server) {
        var displayText = server.ip
        if (server.remarks && server.remarks.trim() !== "") {
          displayText += " (" + server.remarks + ")"
        }
        ipItems.append('<div class="ip-option" data-ip="' + server.ip + '">' + displayText + '</div>')
      })
      console.log("Added " + data.all_data.length + " IP addresses to select")
      
      // 移除加载状态
      $(".ip-selected").removeClass("loading").text("选择IP")
    } else {
      ipItems.append('<div class="empty">暂无可用的服务器IP地址</div>')
      console.log("No server data available")
      
      // 移除加载状态
      $(".ip-selected").removeClass("loading").text("选择IP")
    }

    // 重新绑定IP选择事件
    bindIpSelectEvents()
  }

  // 绑定IP选择事件
  function bindIpSelectEvents() {
    $("#ipSelect .ip-option").off("click").on("click", function(e) {
      e.stopPropagation()
      var selectedText = $(this).text()
      var selectedIp = $(this).data("ip")

      console.log("IP selected:", selectedIp, "Text:", selectedText)

      // 更新选中的文本
      $(".ip-selected").text(selectedText).removeClass("select-arrow-active")

      // 隐藏下拉列表
      $(".ip-items").hide()

      // 触发自定义事件，通知其他组件IP已选择
      $(document).trigger("ipSelected", {ip: selectedIp, text: selectedText})
    })
  }

  // 初始化自定义下拉框功能
  function initCustomSelects() {
    console.log("Initializing custom selects...")
    
    // IP选择框点击事件
    $(".ip-selected").off("click").on("click", function(e) {
      e.stopPropagation()
      console.log("IP selector clicked")
      
      closeAllSelect(this)
      $(".ip-items").toggle()
      $(this).toggleClass("select-arrow-active")
    })

    // 点击其他地方关闭下拉框
    $(document).off("click.selectClose").on("click.selectClose", function(e) {
      if (!$(e.target).closest(".custom-select").length) {
        closeAllSelect()
      }
    })
    
    console.log("Custom selects initialized")
  }

  // 关闭所有下拉框
  function closeAllSelect(elmnt) {
    $(".ip-items").hide()
    $(".ip-selected").removeClass("select-arrow-active")
  }

  $(document).ready(function () {
    console.log("磁盘性能指标分析页面初始化开始...")

    // 初始化页面
    initialazeTwoIndex()

    // 初始化自定义下拉框
    initCustomSelects()

    // 加载服务器IP地址列表，等待完成后再进行初始数据查询
    // 定义页面级别的name变量
    var pageName = "cipanxinnengzhibiao"
    
    loadServerIpList().then(function() {
      // 等待IP列表加载完成后再进行初始数据查询
      setTimeout(function() {
        // 获取表单数据
        var ipValue = $("#ipSelect").val() || "no"
        var sTime = $("#startDate").val()
        var eTime = $("#endDate").val()
        var numberRange = "1-1000"

        // 只有在有有效日期时才进行初始查询
        if (sTime && eTime) {
          console.log("进行初始数据查询:", {name: pageName, sTime, eTime, numberRange, ipValue})
          requestThreeModel(pageName, sTime, eTime, numberRange, ipValue)
        } else {
          console.log("日期未设置，跳过初始数据查询")
        }
      }, 1000) // 等待1秒确保IP列表加载完成
    }).catch(function(error) {
      console.error("IP列表加载失败:", error)
      // 即使IP列表加载失败，也不阻止页面正常显示
    })

    $("#selectTwoModel").on("click", function () {
      var statusIndicator = $("#statusIndicator")
      var selectBtn = $(this)

      var ipText = $(".ip-selected").text()
      var sTime = $("#startDate").val()
      var eTime = $("#endDate").val()
      var pageRange = $("#pageSelect").val()

      // 验证输入
      if (!sTime || !eTime) {
        alert("请选择开始日期和结束日期！")
        return
      }

      if (new Date(sTime) > new Date(eTime)) {
        alert("开始日期不能晚于结束日期！")
        return
      }

      // 提取实际的IP值
      var ipValue = "no"
      if (ipText !== "选择IP" && ipText !== "") {
        ipValue = ipText.split(" ")[0] // 获取IP地址部分（去掉备注）
      }

      // 显示加载状态
      statusIndicator.show()
      selectBtn.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> 查询中...')

      console.log("查询参数:", {name: pageName, sTime, eTime, pageRange, ipValue})

      requestThreeModel(pageName, sTime, eTime, pageRange, ipValue)

      // 恢复按钮状态
      setTimeout(function() {
        statusIndicator.hide()
        selectBtn.prop("disabled", false).html('<i class="fa fa-search"></i> 查询数据')
      }, 2000)
    })

    // 页数选择变化事件
    $("#pageSelect").on("change", function () {
      var sTime = $("#startDate").val()
      var eTime = $("#endDate").val()
      var pageRange = $(this).val()
      var ipText = $(".ip-selected").text()
      var ipValue = (ipText !== "选择IP" && ipText !== "") ? ipText.split(" ")[0] : "no"

      console.log("页数变化查询:", {name: pageName, sTime, eTime, pageRange, ipValue})
      requestThreeModel(pageName, sTime, eTime, pageRange, ipValue)
    })

    // 导出数据功能
    $("#exportDataBtn").on("click", function() {
      var tableData = []
      $("#tbodyContent tr").each(function() {
        var rowData = []
        $(this).find("td").each(function() {
          rowData.push($(this).text())
        })
        if (rowData.length > 0) {
          tableData.push(rowData)
        }
      })

      if (tableData.length === 0) {
        alert("暂无数据可导出！")
        return
      }

      // 这里可以添加实际的导出逻辑
      console.log("导出数据:", tableData)
      alert("磁盘数据导出功能开发中...")
    })

    // 刷新IP地址列表按钮事件
    $("#refreshIpBtn").on("click", function() {
      loadServerIpList();
    });

    console.log("磁盘性能指标分析页面初始化完成！")
  })


</script>
{%endblock%}