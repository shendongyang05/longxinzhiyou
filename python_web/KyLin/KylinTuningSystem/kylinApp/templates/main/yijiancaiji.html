{% extends "layout.html" %}
{% load static %}

{% block title %}一键采集{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script>
// 版本号：2025-07-30-v2.0 - 强制停止轮询修复
console.log('=== 轮询页面加载 v2.0 ===');

// 立即停止所有可能的轮询
(function() {
    console.log('立即停止所有轮询...');
    
    // 清除所有定时器
    for (let i = 1; i <= 10000; i++) {
        clearInterval(i);
        clearTimeout(i);
    }
    
    // 重置全局变量
    if (typeof window.isCollecting !== 'undefined') {
        window.isCollecting = false;
    }
    if (typeof window.currentTaskId !== 'undefined') {
        window.currentTaskId = null;
    }
    if (typeof window.dataTimer !== 'undefined') {
        window.dataTimer = null;
    }
    
    console.log('所有轮询已强制停止');
})();

// 全局变量
var isCollecting = false;
var currentTaskId = null;
var dataTimer = null;
</script>
{% endblock %}

{% block css %}
<style>
    .collection-container {
        padding: 20px;
        background: #f5f5f5;
        min-height: 100vh;
        color: #333;
    }

    .collection-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }

    .control-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-label {
        font-size: 18px;
        color: #333;
        white-space: nowrap;
    }

    .control-select {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 150px;
    }

    .control-input {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 100px;
    }

    .control-input::placeholder {
        color: #999;
    }

    /* 按钮样式 */
    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
    }

    .btn-reset {
        background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
        color: white;
        border: 1px solid #fd7e14;
    }

    .btn-reset:hover {
        background: linear-gradient(135deg, #e55a00, #cc4900);
        box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3);
        transform: translateY(-1px);
    }

    /* 禁用状态 */
    .btn:disabled {
        background: #e9ecef !important;
        color: #6c757d !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
    }

    /* 按钮组间距 */
    .control-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-buttons .btn {
        margin: 0;
    }

    .status-section {
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .content-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .data-display-panel, .ai-suggestion-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .panel-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
    }

    .panel-content {
        color: #333;
    }
    .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .data-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .data-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .data-card .card-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
    }
    .data-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .data-row .icon {
        font-size: 1.2rem;
        margin-right: 8px;
    }
    .data-row .label {
        color: #555;
        min-width: 90px;
    }
    .data-row .value {
        color: #333;
        font-weight: 500;
        margin-left: 6px;
    }
    .data-row .value.over {
        color: #dc3545;
        font-weight: bold;
        background: #ffebee;
        border-radius: 3px;
        padding: 0 4px;
    }
    .data-card .card-time {
        position: absolute;
        right: 18px;
        bottom: 10px;
        color: #666;
        font-size: 0.85em;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #e0e0e0;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    @media (max-width: 900px) {
        .cards-container {
            flex-direction: column;
            gap: 12px;
        }
        .data-card {
            max-width: 100%;
            min-width: 0;
        }
    }
    .param-box label,
    .param-box input,
    .param-box .custom-select,
    .param-box .btn {
        color: #222 !important;
    }
    .param-box label {
        font-weight: 600;
    }

    /* 自定义下拉框样式 */
    .custom-select {
        position: relative;
        display: inline-block;
        min-width: 200px;
    }

    .select-selected {
        background-color: white;
        color: #333;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: border-color 0.3s ease;
    }

    .select-selected:after {
        content: "";
        position: absolute;
        top: 50%;
        right: 15px;
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-color: #666 transparent transparent transparent;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
        border-color: transparent transparent #666 transparent;
        transform: translateY(-50%) rotate(180deg);
    }

    .select-selected:hover {
        border-color: #007bff;
    }

    .select-items {
        position: absolute;
        background-color: white;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 99;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .select-items div {
        color: #333;
        padding: 10px 15px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .select-items div:hover {
        background-color: #f8f9fa;
    }

    .select-items div.selected {
        background-color: #007bff;
        color: white;
    }

    .select-hide {
        display: none;
    }

    /* 下拉框显示状态 */
    .select-items.show {
        display: block;
    }

    /* 空状态样式 */
    .select-items div.empty {
        color: #999;
        font-style: italic;
        cursor: default;
    }

    .select-items div.empty:hover {
        background-color: transparent;
    }
    .task-status {
        background: #ffffff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
        color: #333;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .task-status.starting {
        border-left-color: #ffc107;
        background: #ffffff;
    }
    .task-status.running {
        border-left-color: #28a745;
        background: #ffffff;
    }
    .task-status.error {
        border-left-color: #dc3545;
        background: #ffffff;
    }
    .task-status.stopping {
        border-left-color: #6c757d;
        background: #ffffff;
    }
    .task-status.unknown {
        border-left-color: #6c757d;
        background: #ffffff;
    }
    .task-status strong {
        color: #333;
    }
    .task-status small {
        color: #666;
    }
    .task-status #statusText {
        font-weight: 500;
    }
    .task-status.running #statusText {
        color: #28a745;
    }
    .task-status.error #statusText {
        color: #dc3545;
    }
    .task-status.starting #statusText {
        color: #ffc107;
    }
    .alert {
        padding: 12px 20px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
        transition: all 0.3s ease;
    }
    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }
</style>
{% endblock %}

{% block content %}
<!-- 添加音频元素 -->
<audio id="alertSound" preload="auto" style="display:none;">
    <source src="{% static 'sounds/alert.mp3' %}" type="audio/mpeg">
    <source src="{% static 'sounds/alert.wav' %}" type="audio/wav">
    您的浏览器不支持音频元素
</audio>

<div class="collection-container">
    <h1 class="collection-title">数据轮询采集</h1>

    <!-- 控制区域 -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">IP地址选择：</span>
            <div class="custom-select ip-select">
                <div class="select-selected ip-selected">选择IP</div>
                <div class="select-items ip-items" id="ipSelect" style="display: none;">
                    <div data-value="102.168.46.50">麒麟服务器1 (102.168.46.50)</div>
                    <div data-value="192.168.1.100">测试服务器2 (192.168.1.100)</div>
                    <div data-value="10.0.0.50">本地服务器3 (10.0.0.50)</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">选择端口：</span>
            <div class="custom-select port-select">
                <div class="select-selected port-selected">选择端口</div>
                <div class="select-items port-items" id="portSelect" style="display: none;">
                    <div data-value="22">SSH (22)</div>
                    <div data-value="80">HTTP (80)</div>
                    <div data-value="443">HTTPS (443)</div>
                    <div data-value="3306">MySQL (3306)</div>
                    <div data-value="6379">Redis (6379)</div>
                    <div data-value="8080">应用服务 (8080)</div>
                    <div data-value="9000">监控服务 (9000)</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">轮询间隔(秒)：</span>
            <input type="number" class="control-input" id="pollInterval" min="2" max="3600" value="30">
        </div>

        <div class="control-buttons">
            <button class="btn" id="startBtn">
                <i class="fa fa-play"></i> 开始采集
            </button>
            <button class="btn" id="overBtn" disabled>
                <i class="fa fa-stop"></i> 结束采集
            </button>
            <button class="btn btn-reset" id="cleanupBtn" style="margin-left: 10px;">
                <i class="fa fa-trash"></i> 清理任务
            </button>
            <button class="btn btn-danger" id="forceStopBtn" style="margin-left: 10px; background-color: #dc3545;">
                <i class="fa fa-power-off"></i> 强制停止所有
            </button>


            
        </div>
    </div>

    <!-- 阈值设置区域 -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">CPU使用率(%)：</span>
            <input type="text" class="control-input" id="cpuRange" placeholder="例如: 80">
        </div>

        <div class="control-group">
            <span class="control-label">内存使用率(%)：</span>
            <input type="text" class="control-input" id="memRange" placeholder="例如: 85">
        </div>

        <div class="control-group">
            <span class="control-label">磁盘使用率(%)：</span>
            <input type="text" class="control-input" id="diskRange" placeholder="例如: 90">
        </div>

        <div class="control-group">
            <span class="control-label">网络速率(Mbps)：</span>
            <input type="text" class="control-input" id="netRange" placeholder="例如: 100">
        </div>
    </div>

    <!-- 状态区域 -->
    <div class="status-section">
        <div class="task-status" id="taskStatus" style="display: none;">
            <strong>任务状态：</strong><span id="statusText">未启动</span>
            <br><small>任务ID：<span id="taskId">-</span></small>
            <br><small>后台采集间隔：<span id="backendInterval">-</span>秒</small>
            <br><small>前端刷新间隔：<span id="frontendInterval">-</span>秒</small>
            <br><small>开始时间：<span id="startTime">-</span></small>
            <br><small>最后成功：<span id="lastSuccess">-</span></small>
            <br><small>错误次数：<span id="errorCount">0</span></small>
        </div>
        <div class="alert alert-warning" id="errorAlert" style="display: none;">
            <strong>警告！</strong> <span id="errorMessage"></span>
        </div>
        
        <!-- 调试信息区域 -->
        <div class="alert alert-info" id="debugInfo" style="display: none;">
            <strong>调试信息：</strong> <span id="debugMessage"></span>
        </div>
    </div>

    <!-- 数据展示区域 -->
    <div class="cards-container">
        <div class="data-card" id="cpuCard">
            <div class="card-title">🖥️ CPU性能</div>
            <div class="card-content">
                <p>暂无数据，请开始采集...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="memCard">
            <div class="card-title">💾 内存性能</div>
            <div class="card-content">
                <p>暂无数据，请开始采集...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="diskCard">
            <div class="card-title">💽 磁盘性能</div>
            <div class="card-content">
                <p>暂无数据，请开始采集...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="netCard">
            <div class="card-title">🌐 网络性能</div>
            <div class="card-content">
                <p>暂无数据，请开始采集...</p>
            </div>
            <div class="card-time"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    // 播放警报声音函数
function playAlertSound() {
    console.log('播放警报声音...');
    
    // 如果采集已停止，不播放警报
    if (!isCollecting) {
        console.log('采集已停止，不播放警报');
        return;
    }
    
    // 在HTTP环境下，优先使用Web Audio API
    if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        console.log('检测到HTTP环境，使用Web Audio API');
        playWebAudioFallback();
        return;
    }
    
    try {
        // 创建新的音频元素
        const audio = new Audio("{% static 'sounds/alert.mp3' %}");
        audio.volume = 0.8;
        
        // 添加用户交互来解锁音频
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('警报声音播放成功');
            }).catch(err => {
                console.error('播放音频失败:', err);
                // 备选方案：使用Web Audio API
                playWebAudioFallback();
            });
        }
    } catch (e) {
        console.error('创建音频对象失败:', e);
        // 备选方案：使用Web Audio API
        playWebAudioFallback();
    }
}

function playWebAudioFallback() {
    try {
        // 如果采集已停止，不播放警报
        if (!isCollecting) {
            console.log('采集已停止，不播放Web Audio警报');
            return;
        }
        
        console.log('使用Web Audio API播放警报声音...');
        
        // 检查是否已经有音频上下文
        if (!window.audioContext) {
            window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // 如果音频上下文被暂停，恢复它
        if (window.audioContext.state === 'suspended') {
            window.audioContext.resume();
        }
        
        // 创建振荡器
        const oscillator = window.audioContext.createOscillator();
        const gain = window.audioContext.createGain();
        
        oscillator.connect(gain);
        gain.connect(window.audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.value = 800; // 800Hz
        gain.gain.value = 0.3; // 降低音量
        
        oscillator.start();
        
        // 播放500毫秒后停止
        setTimeout(() => {
            oscillator.stop();
            // 不关闭音频上下文，保持它活跃
        }, 500);
        
        console.log('Web Audio API警报声音播放成功');
    } catch (e) {
        console.error('Web Audio API失败:', e);
        // 最后的备选方案：使用浏览器通知
        showBrowserNotification();
    }
}

function showBrowserNotification() {
    try {
        // 如果采集已停止，不显示通知
        if (!isCollecting) {
            console.log('采集已停止，不显示浏览器通知');
            return;
        }
        
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('系统预警', {
                body: '检测到性能指标超过阈值',
                icon: '/static/img/kylin.ico'
            });
        }
    } catch (e) {
        console.error('浏览器通知失败:', e);
    }
}

// 下拉选择框逻辑（与其他页面一致）
function setupDropdown(selectedClass, itemsClass) {
    console.log('设置下拉框:', selectedClass, itemsClass);
    
    $(document).on("click", "." + selectedClass, function (e) {
        e.stopPropagation();
        console.log('点击下拉框:', selectedClass);
        
        // 切换箭头状态
        $(this).toggleClass("select-arrow-active");
        
        // 切换下拉列表显示
        var items = $(this).siblings("." + itemsClass);
        items.toggle();
        
        // 隐藏其他下拉框
        $("." + itemsClass).not(items).hide();
        $("." + selectedClass).not(this).removeClass("select-arrow-active");
    });
    
    $(document).on("click", "." + itemsClass + " div", function () {
        var selectedText = $(this).text();
        var selectedVal = $(this).attr("data-ip") || $(this).attr("data-port") || selectedText;
        
        console.log('选择项目:', selectedText, selectedVal);
        
        // 更新选中的文本和值
        $(this).parent().siblings(".select-selected").text(selectedText);
        $(this).parent().siblings(".select-selected").attr("data-ip", selectedVal);
        $(this).parent().siblings(".select-selected").attr("data-port", selectedVal);
        
        // 保存到localStorage
        if (itemsClass === "ip-items") {
            localStorage.setItem('selectedIp', selectedVal);
            localStorage.setItem('selectedIpText', selectedText);
            console.log('IP已保存到localStorage:', selectedVal);
        } else if (itemsClass === "port-items") {
            localStorage.setItem('selectedPort', selectedVal);
            localStorage.setItem('selectedPortText', selectedText);
            console.log('端口已保存到localStorage:', selectedVal);
        }
        
        // 隐藏下拉列表
        $(this).parent().hide();
        $(this).parent().siblings(".select-selected").removeClass("select-arrow-active");
        
        // 如果是IP选择，自动加载端口
        if (itemsClass === "ip-items" && selectedVal) {
            console.log('自动加载端口，IP:', selectedVal);
            requestTwoModel("cpu", "get_port", JSON.stringify({ "ip": selectedVal }), function (portData) {
                console.log('端口数据:', portData);
                paddingPortSelectTag(portData);
            }, function(error) {
                console.error('获取端口失败:', error);
                showError('获取端口列表失败');
            });
        }
    });
    
    // 点击外部关闭下拉框
    $(document).click(function (event) {
        if (!$(event.target).closest('.custom-select').length) {
            $(".ip-items, .port-items").hide();
            $(".ip-selected, .port-selected").removeClass("select-arrow-active");
        }
    });
}

// 初始化下拉框
setupDropdown("ip-selected", "ip-items");
setupDropdown("port-selected", "port-items");

// 后台任务管理
let currentTaskId = null;
let dataTimer = null;
let isCollecting = false;

function parseRange(str) {
    // "1~80" => [1,80] 或 "80" => [0,80]
    if (!str) return [null, null];
    if (str.includes("~")) {
        let [min, max] = str.split("~").map(Number);
        return [min, max];
    } else {
        let num = Number(str);
        return [0, num];
    }
}

function highlight(val, min, max) {
    if (min === null || max === null) return '';
    val = parseFloat(val);
    if (isNaN(val)) return '';
    if (val < min || val > max) return 'over';
    return '';
}

function renderCard(cardId, data, range, type) {
    let content = '';
    let time = '';
    
    console.log(`=== 渲染${type}数据 ===`);
    console.log('卡片ID:', cardId);
    console.log('原始数据:', data);
    console.log('数据类型:', typeof data);
    console.log('数据是否为对象:', typeof data === 'object');
    
    if (!data || typeof data !== 'object') {
        console.warn(`${type}数据无效:`, data);
        $(cardId + ' .card-content').html('<span style="color:#aaa;">暂无数据, 请开始采集...</span>');
        $(cardId + ' .card-time').text('');
        return;
    }
    
    // 检查是否有message字段（表示没有数据）
    if (data.message) {
        console.warn(`${type}数据包含错误信息:`, data.message);
        $(cardId + ' .card-content').html(`<span style="color:#ff6b6b;">⚠️ ${data.message}</span>`);
        $(cardId + ' .card-time').text('');
        return;
    }
    
    // 检查数据完整性
    let hasData = false;
    
    // 根据不同类型检查关键字段
    switch(type) {
        case 'cpu':
            hasData = data.cpu_percent !== undefined;
            break;
        case 'mem':
            hasData = data.mem_percent !== undefined;
            break;
        case 'disk':
            hasData = data.disk_percent !== undefined;
            break;
        case 'net':
            hasData = data.net_bytes_sent !== undefined || data.net_bytes_recv !== undefined;
            break;
    }
    
    console.log(`${type}数据完整性检查:`, {
        type: type,
        hasData: hasData,
        key_fields: Object.keys(data)
    });
    
    if (!hasData) {
        console.warn(`${type}数据不完整:`, data);
        $(cardId + ' .card-content').html('<span style="color:#aaa;">数据不完整</span>');
        $(cardId + ' .card-time').text('');
        return;
    }

    let [min, max] = range;
    
    if (type === 'cpu') {
        let percent = data.cpu_percent ?? 0;
        let threshold = parseFloat($("#cpuRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">CPU使用率</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">🖥️</span><span class="label">主机</span><span class="value">${data.host ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">🟢</span><span class="label">cpu核心数</span><span class="value">${data.cpu_count ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⏰</span><span class="label">实际CPU时间</span><span class="value">${data.cpu_user_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⏰</span><span class="label">CPU运行时间</span><span class="value">${data.cpu_system_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⏰</span><span class="label">CPU空闲时间</span><span class="value">${data.cpu_idle_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⏰</span><span class="label">CPU等待时间</span><span class="value">${data.cpu_wait_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">🖥️</span><span class="label">CPU型号</span><span class="value">${data.cpu_model ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'mem') {
        let percent = data.mem_percent ?? 0;
        let threshold = parseFloat($("#memRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">内存使用率</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">💾</span><span class="label">总内存</span><span class="value">${data.mem_total ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">已用内存</span><span class="value">${data.mem_used ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">🟢</span><span class="label">可用内存</span><span class="value">${data.mem_free ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📄</span><span class="label">缓冲区</span><span class="value">${data.mem_buffers ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📦</span><span class="label">缓存</span><span class="value">${data.mem_cached ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">🔄</span><span class="label">交换区</span><span class="value">${data.swap_used ?? '-'}/${data.swap_total ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'disk') {
        let percent = data.disk_percent ?? 0;
        let threshold = parseFloat($("#diskRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">磁盘使用率</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">💾</span><span class="label">总容量</span><span class="value">${data.disk_total ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">已用空间</span><span class="value">${data.disk_used ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">🟢</span><span class="label">可用空间</span><span class="value">${data.disk_free ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⬆️</span><span class="label">读数据量</span><span class="value">${data.disk_read ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⬇️</span><span class="label">写数据量</span><span class="value">${data.disk_write ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'net') {
        let speed = parseFloat(data.net_speed) || 0;
        let threshold = parseFloat($("#netRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">🖥️</span><span class="label">主机</span><span class="value">${data.host ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⬆️</span><span class="label">发送字节</span><span class="value ${highlight(speed, min, max)}">${data.net_bytes_sent ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">⬇️</span><span class="label">接收字节</span><span class="value ${highlight(speed, min, max)}">${data.net_bytes_recv ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">接收包数</span><span class="value">${data.net_packets_recv ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">📊</span><span class="label">发送包数</span><span class="value">${data.net_packets_sent ?? '-'}</span></div>`;
        if (data.net_speed) {
            content += `<div class="data-row"><span class="icon">📶</span><span class="label">网络速率</span><span class="value">${data.net_speed ?? '-'} Mbps</span></div>`;
        }
        time = data.time || '';
    }
    
    $(cardId + ' .card-content').html(content);
    
    // 格式化时间显示
    if (time) {
        let formattedTime = '';
        if (typeof time === 'string') {
            // 如果是字符串，直接使用
            formattedTime = time;
        } else if (time instanceof Date) {
            // 如果是Date对象，格式化
            formattedTime = time.toLocaleString('zh-CN');
        } else {
            // 其他情况，尝试转换
            try {
                formattedTime = new Date(time).toLocaleString('zh-CN');
            } catch (e) {
                formattedTime = time.toString();
            }
        }
        $(cardId + ' .card-time').text(formattedTime);
    } else {
        $(cardId + ' .card-time').text('');
    }
}

// 启动后台采集任务
function startBackgroundCollection() {
    if (isCollecting) return;
    
    let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
    let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
    let interval = parseInt($("#pollInterval").val()) || 30;
    
    if (!ip || ip === "选择IP" || !port || port === "选择端口") {
        alert("请先选择IP和端口");
        return;
    }
    
    // 验证阈值设置
    const cpuThreshold = $("#cpuRange").val();
    const memThreshold = $("#memRange").val();
    const diskThreshold = $("#diskRange").val();
    const netThreshold = $("#netRange").val();
    
    // 提示用户设置阈值
    if (!cpuThreshold && !memThreshold && !diskThreshold && !netThreshold) {
        if (!confirm("您尚未设置任何阈值，这将导致无法收到告警通知。是否继续？")) {
            return;
        }
    }
    
    // 发送启动后台采集任务请求
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'start',
            ip: ip,
            port: port,
            interval: interval
        }),
        success: function(response) {
            if (response.success) {
                currentTaskId = response.task_id;
                isCollecting = true;
                
                // 设置采集状态标记，确保全局监控能够正确工作
                localStorage.setItem('isCollecting', 'true');
                
                // 更新UI状态
                $("#startBtn").prop("disabled", true);
                $("#overBtn").prop("disabled", false);
                
                // 显示任务状态和间隔信息
                $("#taskStatus").show().removeClass('stopped').addClass('running');
                $("#statusText").text("运行中");
                $("#taskId").text(currentTaskId);
                $("#backendInterval").text(interval);
                
                // 开始定时获取数据
                startDataPolling();
                
                // 启动全局监控
                if (window.monitorManager) {
                    window.monitorManager.startChecking();
                    console.log('已启动全局监控');
                }
                
                // 保存任务状态和阈值设置
                saveTaskState();
                
                alert("后台采集任务启动成功！后台采集间隔：" + interval + "秒");
            } else {
                alert("启动失败：" + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert("启动失败：" + error);
        }
    });
}

// 停止后台采集任务
function stopBackgroundCollection() {
    console.log('尝试停止采集任务:', { isCollecting, currentTaskId });
    
    // 先停止前端数据轮询
    stopDataPolling();
    
    // 立即更新前端状态，确保不再触发警报
    isCollecting = false;
    localStorage.removeItem('isCollecting');
    
    // 清除所有现有预警（使用静默模式）
    clearAllAlerts(true);
    
    // 停止全局监控
    if (window.monitorManager) {
        window.monitorManager.stopChecking();
        console.log('已停止全局监控');
        
        // 清除所有预警记录
        if (typeof window.monitorManager.clearAllAlerts === 'function') {
            window.monitorManager.clearAllAlerts();
            console.log('已清除所有预警记录');
        }
    }
    
    // 如果没有任务ID，直接更新UI状态
    if (!currentTaskId) {
        console.warn('没有任务ID，直接更新UI状态');
        $("#startBtn").prop("disabled", false);
        $("#overBtn").prop("disabled", true);
        $("#taskStatus").removeClass('running').addClass('stopped');
        $("#statusText").text("已停止");
        localStorage.removeItem('collectionTaskState');
        showDebug('前端状态已重置');
        return;
    }
    
    showDebug('正在停止采集任务...');
    
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'stop',
            task_id: currentTaskId
        }),
        success: function(response) {
            console.log('停止任务响应:', response);
            
            // 更新前端状态
            currentTaskId = null;
            $("#startBtn").prop("disabled", false);
            $("#overBtn").prop("disabled", true);
            $("#taskStatus").removeClass('running').addClass('stopped');
            $("#statusText").text("已停止");
            localStorage.removeItem('collectionTaskState');
            
            // 再次确保所有预警已清除（使用静默模式）
            clearAllAlerts(true);
            
            if (response.success) {
                showDebug('采集任务已成功停止');
                alert("后台采集任务已停止！");
                // 延迟清理任务状态
                delayedCleanup();
            } else {
                console.warn('后端停止任务失败，但前端状态已重置:', response.message);
                showDebug('前端状态已重置，后端任务可能已停止: ' + response.message);
                // 尝试强制停止所有任务
                forceStopAllTasks();
            }
        },
        error: function(xhr, status, error) {
            console.error('停止任务API调用失败:', { xhr, status, error });
            
            // 即使API调用失败，也要更新前端状态
            currentTaskId = null;
            $("#startBtn").prop("disabled", false);
            $("#overBtn").prop("disabled", true);
            $("#taskStatus").removeClass('running').addClass('stopped');
            $("#statusText").text("已停止");
            localStorage.removeItem('collectionTaskState');
            
            // 再次确保所有预警已清除（使用静默模式）
            clearAllAlerts(true);
            
            if (xhr.status === 400) {
                showDebug('停止请求格式错误，但前端状态已重置');
                alert("停止请求处理异常，但前端状态已重置");
            } else {
                showError('停止任务API调用失败，但前端状态已重置: ' + error);
                alert("网络错误，但前端状态已重置");
            }
            
            // 尝试强制停止所有任务
            forceStopAllTasks();
        }
    });
}

// 清除所有现有预警
function clearAllAlerts(silent) {
    console.log('清除所有预警记录, silent:', silent);
    
    // silent参数控制是否使用静默方式清除预警（不弹确认框）
    silent = (silent === true);
    
    // 尝试关闭预警管理面板
    try {
        // 找到并关闭预警面板
        var $alertPanel = $('.预警管理, [aria-label="预警管理"], .alert-panel, .modal:contains("预警管理")');
        if ($alertPanel.length > 0) {
            console.log('找到预警面板，尝试关闭');
            $alertPanel.hide();
        }
        
        // 清除所有预警记录数据
        localStorage.removeItem('alerts');
        localStorage.removeItem('lastAlerts');
        localStorage.removeItem('alertHistory');
        
        // 如果需要静默模式，不调用可能会弹窗的API
        if (!silent) {
            try {
                // 直接关闭模态框
                if (typeof $.fn.modal === 'function') {
                    $(".modal").modal("hide");
                }
                
                // 尝试点击"标记已读"和"关闭"按钮
                $(".modal .btn-primary, .modal .btn-success, .modal button:contains('标记已读')").click();
                $(".modal .btn-secondary, .modal .close, .modal button:contains('关闭')").click();
            } catch (modalError) {
                console.log('模态框操作出错，可忽略:', modalError);
            }
            
            // 尝试调用API清除所有预警
            $.ajax({
                url: '/api/alerts/clear',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'clear_all',
                    silent: true
                }),
                success: function(response) {
                    console.log('清除预警API调用成功:', response);
                },
                error: function() {
                    console.log('清除预警API调用失败，但已本地清除预警记录');
                }
            });
        }
        
        // 如果有预警DOM元素，移除它们
        $('.alert-item, .cpu-alert, .memory-alert, .disk-alert, .network-alert').remove();
        
        // 通过点击关闭按钮关闭预警面板
        $('.close-alerts, .dismiss-alerts, [data-dismiss="alert"], [data-dismiss="modal"]').click();
        
        // 直接点击页面上可见的特定按钮 - 只在非静默模式下执行
        if (!silent) {
            $('button:contains("标记已读"), button:contains("全部标记为已读")').click();
            $('button:contains("清除所有预警"), button:contains("清除所有")').click();
            
            // 即使有错误也尝试调用特定API
            try {
                // 从截图看到的预警弹窗，尝试调用与标记已读相关的API
                $.ajax({
                    url: '/api/mark_alerts_read/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        action: 'mark_all_read',
                        silent: true
                    })
                });
            } catch (apiError) {
                console.log('调用标记已读API出错，可以忽略', apiError);
            }
        }
        
        console.log('预警记录已清除');
    } catch (e) {
        console.error('清除预警记录时出错:', e);
    }
}

// 强制停止所有任务
function forceStopAllTasks() {
    console.log('尝试强制停止所有任务...');
    
    // 立即更新前端状态，确保不再触发警报
    isCollecting = false;
    localStorage.removeItem('isCollecting');
    
    // 清除所有现有预警（使用静默模式）
    clearAllAlerts(true);
    
    // 停止全局监控
    if (window.monitorManager) {
        window.monitorManager.stopChecking();
        console.log('已停止全局监控');
        
        // 清除所有预警记录
        if (typeof window.monitorManager.clearAllAlerts === 'function') {
            window.monitorManager.clearAllAlerts();
            console.log('已清除所有预警记录');
        }
    }
    
    // 尝试关闭预警面板
    $('.预警管理, [aria-label="预警管理"], .alert-panel').hide();
    
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'force_stop_all'
        }),
        success: function(response) {
            if (response.success) {
                console.log('强制停止所有任务成功:', response);
                showDebug('已强制停止所有后台任务');
                
                // 强制清理前端状态
                forceStopAllPolling();
                
                // 再次清除所有预警（使用静默模式）
                clearAllAlerts(true);
                
                // 关闭预警模态框（直接点击关闭按钮）
                $('.关闭, .close, [data-dismiss="modal"]').click();
            } else {
                console.warn('强制停止所有任务失败:', response.message);
                showError('强制停止所有任务失败: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('强制停止所有任务API调用失败:', error);
            showError('强制停止所有任务API调用失败: ' + error);
            
            // 即使API调用失败，也要清除预警（使用静默模式）
            clearAllAlerts(true);
        }
    });
}

// 开始定时获取数据
function startDataPolling() {
    if (dataTimer) clearInterval(dataTimer);
    
    function fetchLatestData() {
        let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
        let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
        let cpuRange = parseRange($("#cpuRange").val());
        let memRange = parseRange($("#memRange").val());
        let diskRange = parseRange($("#diskRange").val());
        let netRange = parseRange($("#netRange").val());
        
        // 添加调试信息
        console.log('=== 数据获取调试信息 ===');
        console.log('IP:', ip);
        console.log('Port:', port);
        console.log('IP元素:', $(".ip-selected").attr("data-ip"), $(".ip-selected").text());
        console.log('Port元素:', $(".port-selected").attr("data-port"), $(".port-selected").text());
        
        // 保存当前IP和端口到localStorage，以便全局监控使用
        localStorage.setItem('selectedIp', ip);
        localStorage.setItem('selectedPort', port);
        
        // 获取最新数据
        $.ajax({
            url: '/api/get_latest_data/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                ip: ip,
                port: port
            }),
            success: function(response) {
                console.log('=== API响应详情 ===');
                console.log('完整响应:', response);
                console.log('响应成功:', response.success);
                console.log('数据对象:', response.data);
                console.log('CPU数据:', response.data?.cpu);
                console.log('内存数据:', response.data?.memory);
                console.log('磁盘数据:', response.data?.disk);
                console.log('网络数据:', response.data?.network);
                
                if (response.success) {
                    if (response.data && Object.keys(response.data).length > 0) {
                        console.log('开始渲染数据卡片...');
                        
                        // 检查阈值并触发警报
                        checkAndTriggerAlerts(response.data);
                        
                        // 渲染数据卡片
                        renderCard('#cpuCard', response.data.cpu, cpuRange, 'cpu');
                        renderCard('#memCard', response.data.memory, memRange, 'mem');
                        renderCard('#diskCard', response.data.disk, diskRange, 'disk');
                        renderCard('#netCard', response.data.network, netRange, 'net');
                        
                        // 更新最后成功时间
                        $("#lastSuccess").text(new Date().toLocaleString('zh-CN'));
                    } else {
                        console.warn('API返回成功但没有数据');
                        showWarning('API返回成功但没有数据');
                    }
                } else {
                    // 更新错误计数
                    let errorCount = parseInt($("#errorCount").text()) || 0;
                    $("#errorCount").text(errorCount + 1);
                    
                    console.error('API返回失败:', response.message);
                    showError('获取数据失败: ' + (response.message || '未知错误'));
                }
            },
            error: function(xhr, status, error) {
                console.log("获取数据失败：" + error);
                console.log("XHR状态:", xhr.status);
                console.log("错误详情:", xhr.responseText);
                showError("获取数据失败，将在下次轮询时重试");
            }
        });
        
        // 检查任务状态
        if (currentTaskId && isCollecting) {
            $.ajax({
                url: '/api/background_collection/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'status',
                    task_id: currentTaskId
                }),
                success: function(response) {
                    if (response.success && response.status) {
                        updateTaskStatus(response.status);
                    } else if (!response.success) {
                        console.warn("任务状态检查失败：" + response.message);
                        // 如果任务不存在，停止轮询
                        if (response.message && response.message.includes('任务不存在')) {
                            console.log('任务不存在，停止数据轮询');
                            stopDataPolling();
                            isCollecting = false;
                            currentTaskId = null;
                            $("#startBtn").prop("disabled", false);
                            $("#overBtn").prop("disabled", true);
                            $("#taskStatus").removeClass('running').addClass('stopped');
                            $("#statusText").text("任务已停止");
                            showError("后台任务已停止，数据轮询已停止");
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.log("检查任务状态失败：" + error);
                    // 如果是404错误，说明任务不存在
                    if (xhr.status === 404) {
                        console.log('任务不存在，停止数据轮询');
                        stopDataPolling();
                        isCollecting = false;
                        currentTaskId = null;
                        $("#startBtn").prop("disabled", false);
                        $("#overBtn").prop("disabled", true);
                        $("#taskStatus").removeClass('running').addClass('stopped');
                        $("#statusText").text("任务已停止");
                        showError("后台任务已停止，数据轮询已停止");
                    }
                }
            });
        }
    }
    
    // 立即获取一次数据
    fetchLatestData();
    
    // 根据用户设置的间隔时间进行轮询（最小3秒，最大不超过设置的间隔）
    let pollInterval = parseInt($("#pollInterval").val()) || 30;
    let frontendInterval = Math.max(3, Math.min(pollInterval, 30)) * 1000; // 转换为毫秒，最小3秒，最大30秒
    
    console.log(`前端数据轮询间隔设置为: ${frontendInterval/1000}秒 (后台采集间隔: ${pollInterval}秒)`);
    
    // 更新前端间隔显示
    $("#frontendInterval").text(frontendInterval/1000);
    
    dataTimer = setInterval(fetchLatestData, frontendInterval);
}

// 停止数据轮询
function stopDataPolling() {
    console.log('尝试停止数据轮询，当前dataTimer:', dataTimer);
    
    if (dataTimer) {
        clearInterval(dataTimer);
        dataTimer = null;
        console.log('数据轮询已停止');
    } else {
        console.log('没有活动的轮询定时器');
    }
}

// 强制停止所有轮询（用于调试）
function forceStopAllPolling() {
    console.log('强制停止所有轮询...');
    
    // 清除所有可能的定时器
    if (dataTimer) {
        clearInterval(dataTimer);
        dataTimer = null;
    }
    
    // 清除所有定时器（更彻底的方法）
    for (let i = 1; i <= 10000; i++) {
        clearInterval(i);
        clearTimeout(i);
    }
    
    // 重置状态变量
    isCollecting = false;
    currentTaskId = null;
    
    // 更新UI状态
    $("#startBtn").prop("disabled", false);
    $("#overBtn").prop("disabled", true);
    $("#taskStatus").removeClass('running').addClass('stopped');
    $("#statusText").text("已停止");
    
    // 清除localStorage
    localStorage.removeItem('collectionTaskState');
    
    console.log('所有轮询已强制停止，状态已重置');
}

// 延迟清理任务状态
function delayedCleanup() {
    if (currentTaskId) {
        setTimeout(function() {
            // 延迟5秒后清理任务状态，给前端足够时间获取最终状态
            console.log('延迟清理任务状态:', currentTaskId);
            
            // 调用清理API
            $.ajax({
                url: '/api/background_collection/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'cleanup',
                    task_id: currentTaskId
                }),
                success: function(response) {
                    if (response.success) {
                        console.log('任务清理成功:', currentTaskId);
                    } else {
                        console.warn('任务清理失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('清理任务API调用失败:', error);
                }
            });
        }, 5000);
    }
}



// 更新任务状态显示
function updateTaskStatus(status) {
    $("#startTime").text(status.start_time || '-');
    $("#lastSuccess").text(status.last_success || '-');
    $("#errorCount").text(status.error_count || 0);
    
    // 更新状态文本和样式
    let statusText = '';
    let statusClass = '';
    switch(status.status) {
        case 'starting':
            statusText = '正在启动';
            statusClass = 'starting';
            break;
        case 'running':
            statusText = '运行中';
            statusClass = 'running';
            break;
        case 'error':
            statusText = '出错';
            statusClass = 'error';
            break;
        case 'stopping':
            statusText = '正在停止';
            statusClass = 'stopping';
            break;
        default:
            statusText = status.status || '未知';
            statusClass = 'unknown';
    }
    
    $("#statusText").text(statusText);
    $("#taskStatus")
        .removeClass('starting running error stopping unknown')
        .addClass(statusClass);
    
    // 如果任务出错次数过多，显示警告
    if (status.error_count > 0) {
        showError(`采集任务出现${status.error_count}次错误，系统正在自动重试`);
    }
    
    // 保存任务状态
    saveTaskState();
}

// 显示错误信息
function showError(message) {
    $("#errorMessage").text(message);
    $("#errorAlert").removeClass("alert-warning").addClass("alert-danger").show();
    console.error('错误:', message);
    
    // 8秒后自动隐藏
    setTimeout(function() {
        $("#errorAlert").fadeOut();
    }, 8000);
}

// 显示警告信息
function showWarning(message) {
    $("#errorMessage").text(message);
    $("#errorAlert").removeClass("alert-danger").addClass("alert-warning").show();
    console.warn('警告:', message);
    
    // 5秒后自动隐藏
    setTimeout(function() {
        $("#errorAlert").fadeOut();
    }, 5000);
}

// 显示调试信息
function showDebug(message) {
    $("#debugMessage").text(message);
    $("#debugInfo").fadeIn();
    
    // 10秒后自动隐藏
    setTimeout(function() {
        $("#debugInfo").fadeOut();
    }, 10000);
    
    console.log('调试:', message);
}

function paddingIpSelectTag(data) {
    console.log('填充IP选择数据:', data);
    showDebug('正在加载服务器列表...');
    
    var selectTag = $("#ipSelect");
    selectTag.empty();
    var ipData = [];
    var remarkData = [];
    
    // 检查数据格式 - 处理get_ipadress API返回的{remark: ip}格式
    if (typeof data === 'object' && data !== null) {
        // 如果是get_ipadress API返回的格式 {remark: ip}
        if (Object.keys(data).length > 0 && typeof Object.values(data)[0] === 'string') {
            for (var remark in data) {
                if (data.hasOwnProperty(remark)) {
                    remarkData.push(remark);
                    ipData.push(data[remark]);
                }
            }
        }
        // 如果是其他API返回的数组格式
        else if (Array.isArray(data)) {
            data.forEach(function(item) {
                if (item.ip && item.remarks) {
                    remarkData.push(item.remarks);
                    ipData.push(item.ip);
                }
            });
        }
        // 如果是{all_data: [...]}格式
        else if (data.all_data && Array.isArray(data.all_data)) {
            data.all_data.forEach(function(item) {
                var displayText = item.remarks && item.remarks.trim() !== "" ? item.remarks : item.ip;
                remarkData.push(displayText);
                ipData.push(item.ip);
            });
        }
    }
    
    console.log('处理后的数据:', { remarkData: remarkData, ipData: ipData });
    showDebug(`找到 ${remarkData.length} 台服务器`);
    
    // 默认选中第一个
    if (remarkData.length > 0) {
        $(".ip-selected").text(remarkData[0]);
        $(".ip-selected").attr("data-ip", ipData[0]);
        console.log('默认选中:', remarkData[0], 'IP:', ipData[0]);
        showDebug(`默认选中: ${remarkData[0]} (${ipData[0]})`);
        
        // 自动加载端口
        requestTwoModel("cpu", "get_port", JSON.stringify({ "ip": ipData[0] }), function (portData) {
            console.log('端口数据:', portData);
            paddingPortSelectTag(portData);
        }, function(error) {
            console.error('获取端口失败:', error);
            showError('获取端口列表失败');
        });
    } else {
        console.warn('没有找到可用的IP数据');
        $(".ip-selected").text("暂无可用服务器");
        showError('没有找到可用的服务器，请检查服务器配置');
    }
    
    for (var i = 0; i < remarkData.length; i++) {
        var optionTag = $("<div>").attr("class", "ip");
        optionTag.text(remarkData[i]);
        optionTag.attr("data-ip", ipData[i]);
        selectTag.append(optionTag);
    }
    
    // 确保下拉框正确显示
    if (remarkData.length > 0) {
        selectTag.show();
    } else {
        selectTag.hide();
    }
}

function paddingPortSelectTag(data) {
    console.log('填充端口选择数据:', data);
    var selectTag = $("#portSelect");
    selectTag.empty();
    
    if (data && data.port && Array.isArray(data.port)) {
        var portData = data.port;
        if (portData.length > 0) {
            $(".port-selected").text(portData[0]);
            $(".port-selected").attr("data-port", portData[0]);
            console.log('默认选中端口:', portData[0]);
        }
        
        for (var i = 0; i < portData.length; i++) {
            var optionTag = $("<div>").attr("class", "port");
            optionTag.text(portData[i]);
            optionTag.attr("data-port", portData[i]);
            selectTag.append(optionTag);
        }
        
        // 确保下拉框正确显示
        selectTag.show();
        
        // 检查是否需要启动数据轮询（如果任务状态恢复成功）
        if (isCollecting && currentTaskId && !dataTimer) {
            console.log('IP和端口设置完成，启动数据轮询');
            startDataPolling();
        }
    } else {
        console.warn('端口数据格式错误:', data);
        $(".port-selected").text("暂无可用端口");
        selectTag.hide();
    }
}

// 保存任务状态到localStorage
function saveTaskState() {
    if (currentTaskId) {
        // 获取当前阈值设置
        const cpuThreshold = $("#cpuRange").val();
        const memThreshold = $("#memRange").val();
        const diskThreshold = $("#diskRange").val();
        const netThreshold = $("#netRange").val();
        
        // 保存阈值设置到localStorage
        localStorage.setItem('cpuThreshold', cpuThreshold);
        localStorage.setItem('memThreshold', memThreshold);
        localStorage.setItem('diskThreshold', diskThreshold);
        localStorage.setItem('netThreshold', netThreshold);
        
        console.log('保存阈值设置:', {
            cpu: cpuThreshold,
            memory: memThreshold,
            disk: diskThreshold,
            network: netThreshold
        });
        
        let taskState = {
            taskId: currentTaskId,
            ip: $(".ip-selected").attr("data-ip") || $(".ip-selected").text(),
            port: $(".port-selected").attr("data-port") || $(".port-selected").text(),
            interval: $("#pollInterval").val(),
            isCollecting: isCollecting,
            // 保存阈值设置
            thresholds: {
                cpu: cpuThreshold,
                mem: memThreshold,
                disk: diskThreshold,
                net: netThreshold
            }
        };
        localStorage.setItem('collectionTaskState', JSON.stringify(taskState));
    } else {
        localStorage.removeItem('collectionTaskState');
    }
}

// 从localStorage恢复任务状态
function restoreTaskState() {
    const state = JSON.parse(localStorage.getItem('collectionTaskState') || '{}');
    
    if (state.isCollecting && state.taskId) {
        console.log('发现保存的任务状态:', state);
        
        // 先检查任务是否真的在运行
        $.ajax({
            url: '/api/background_collection/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: 'status',
                task_id: state.taskId
            }),
            success: function(response) {
                if (response.success && response.status && response.status.running) {
                    // 恢复UI状态
                    currentTaskId = state.taskId;
                    isCollecting = true;
                    
                    // 设置IP和端口
                    $(".ip-selected").text(state.ip).attr("data-ip", state.ip);
                    $(".port-selected").text(state.port).attr("data-port", state.port);
                    
                    // 设置采集间隔
                    $("#pollInterval").val(state.interval);
                    
                    // 更新UI状态
                    $("#startBtn").prop("disabled", true);
                    $("#overBtn").prop("disabled", false);
                    $("#taskStatus").show().removeClass('stopped').addClass('running');
                    $("#statusText").text("运行中");
                    
                    // 注意：不在这里启动数据轮询，等待IP和端口设置完成后再启动
                    // startDataPolling();
                    
                    console.log('任务状态恢复成功，等待IP和端口设置完成后启动轮询');
                } else {
                    console.warn('后端任务未运行，清除状态');
                    localStorage.removeItem('collectionTaskState');
                    isCollecting = false;
                    currentTaskId = null;
                    
                    // 更新UI状态
                    $("#startBtn").prop("disabled", false);
                    $("#overBtn").prop("disabled", true);
                    $("#taskStatus").removeClass('running').addClass('stopped');
                    $("#statusText").text("已停止");
                }
            },
            error: function(xhr, status, error) {
                console.error('检查任务状态失败:', error);
                // 检查失败时，清除状态避免问题
                localStorage.removeItem('collectionTaskState');
                isCollecting = false;
                currentTaskId = null;
                
                // 更新UI状态
                $("#startBtn").prop("disabled", false);
                $("#overBtn").prop("disabled", true);
                $("#taskStatus").removeClass('running').addClass('stopped');
                $("#statusText").text("已停止");
            }
        });
    } else {
        console.log('没有保存的任务状态或状态无效');
    }
    
    // 恢复阈值设置
    if (state.thresholds) {
        $("#cpuRange").val(state.thresholds.cpu || '');
        $("#memRange").val(state.thresholds.mem || '');
        $("#diskRange").val(state.thresholds.disk || '');
        $("#netRange").val(state.thresholds.net || '');
    }
}

// 修改startBackgroundCollection函数
function startBackgroundCollection() {
    if (isCollecting) return;
    
    let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
    let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
    let interval = parseInt($("#pollInterval").val()) || 30;
    
    if (!ip || ip === "选择IP" || !port || port === "选择端口") {
        alert("请先选择IP和端口");
        return;
    }
    
    // 验证阈值设置
    const cpuThreshold = $("#cpuRange").val();
    const memThreshold = $("#memRange").val();
    const diskThreshold = $("#diskRange").val();
    const netThreshold = $("#netRange").val();
    
    // 提示用户设置阈值
    if (!cpuThreshold && !memThreshold && !diskThreshold && !netThreshold) {
        if (!confirm("您尚未设置任何阈值，这将导致无法收到告警通知。是否继续？")) {
            return;
        }
    }
    
    // 发送启动后台采集任务请求
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'start',
            ip: ip,
            port: port,
            interval: interval
        }),
        success: function(response) {
            if (response.success) {
                currentTaskId = response.task_id;
                isCollecting = true;
                
                // 设置采集状态标记，确保全局监控能够正确工作
                localStorage.setItem('isCollecting', 'true');
                
                // 更新UI状态
                $("#startBtn").prop("disabled", true);
                $("#overBtn").prop("disabled", false);
                
                // 显示任务状态和间隔信息
                $("#taskStatus").show().removeClass('stopped').addClass('running');
                $("#statusText").text("运行中");
                $("#taskId").text(currentTaskId);
                
                // 开始定时获取数据
                startDataPolling();
                
                // 启动全局监控
                if (window.monitorManager) {
                    window.monitorManager.startChecking();
                    console.log('已启动全局监控');
                }
                
                // 保存任务状态和阈值设置
                saveTaskState();
                
                alert("后台采集任务启动成功！");
            } else {
                alert("启动失败：" + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert("启动失败：" + error);
        }
    });
}

// 检查阈值并触发警报
function checkAndTriggerAlerts(data) {
    // 如果采集已停止，不检查阈值
    if (!isCollecting) {
        console.log('采集已停止，不检查阈值');
        return;
    }
    
    // 获取阈值设置
    const cpuThreshold = parseFloat($("#cpuRange").val()) || 0;
    const memThreshold = parseFloat($("#memRange").val()) || 0;
    const diskThreshold = parseFloat($("#diskRange").val()) || 0;
    const netThreshold = parseFloat($("#netRange").val()) || 0;
    
    // 保存当前阈值到localStorage，确保全局监控能够使用
    localStorage.setItem('cpuThreshold', cpuThreshold);
    localStorage.setItem('memThreshold', memThreshold);
    localStorage.setItem('diskThreshold', diskThreshold);
    localStorage.setItem('netThreshold', netThreshold);
    
    console.log('检查阈值:', {
        cpu: `${data.cpu?.cpu_percent || 0}% / ${cpuThreshold}%`,
        memory: `${data.memory?.mem_percent || 0}% / ${memThreshold}%`,
        disk: `${data.disk?.disk_percent || 0}% / ${diskThreshold}%`,
        network: `${data.network?.net_speed || 0}Mbps / ${netThreshold}Mbps`
    });
    
    // 检查monitorManager是否可用
    console.log('monitorManager状态:', {
        exists: typeof window.monitorManager !== 'undefined',
        manager: window.monitorManager
    });
    
    // 检查CPU阈值
    if (cpuThreshold > 0 && data.cpu && data.cpu.cpu_percent > cpuThreshold) {
        console.log(`CPU告警: ${data.cpu.cpu_percent}% > ${cpuThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('添加CPU告警到monitorManager');
            window.monitorManager.addAlert(
                'CPU告警',
                'CPU使用率超过设定阈值',
                `${data.cpu.cpu_percent}%`,
                `阈值: ${cpuThreshold}%`
            );
        } else {
            console.error('monitorManager不可用，无法添加告警');
        }
    }
    
    // 检查内存阈值
    if (memThreshold > 0 && data.memory && data.memory.mem_percent > memThreshold) {
        console.log(`内存告警: ${data.memory.mem_percent}% > ${memThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('添加内存告警到monitorManager');
            window.monitorManager.addAlert(
                '内存告警',
                '内存使用率超过设定阈值',
                `${data.memory.mem_percent}%`,
                `阈值: ${memThreshold}%`
            );
        } else {
            console.error('monitorManager不可用，无法添加告警');
        }
    }
    
    // 检查磁盘阈值
    if (diskThreshold > 0 && data.disk && data.disk.disk_percent > diskThreshold) {
        console.log(`磁盘告警: ${data.disk.disk_percent}% > ${diskThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('添加磁盘告警到monitorManager');
            window.monitorManager.addAlert(
                '磁盘告警',
                '磁盘使用率超过设定阈值',
                `${data.disk.disk_percent}%`,
                `阈值: ${diskThreshold}%`