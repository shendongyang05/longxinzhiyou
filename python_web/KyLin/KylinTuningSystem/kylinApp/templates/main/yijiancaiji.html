{% extends "layout.html" %}
{% load static %}

{% block title %}ä¸€é”®é‡‡é›†{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script>
// ç‰ˆæœ¬å·ï¼š2025-07-30-v2.0 - å¼ºåˆ¶åœæ­¢è½®è¯¢ä¿®å¤
console.log('=== è½®è¯¢é¡µé¢åŠ è½½ v2.0 ===');

// ç«‹å³åœæ­¢æ‰€æœ‰å¯èƒ½çš„è½®è¯¢
(function() {
    console.log('ç«‹å³åœæ­¢æ‰€æœ‰è½®è¯¢...');
    
    // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
    for (let i = 1; i <= 10000; i++) {
        clearInterval(i);
        clearTimeout(i);
    }
    
    // é‡ç½®å…¨å±€å˜é‡
    if (typeof window.isCollecting !== 'undefined') {
        window.isCollecting = false;
    }
    if (typeof window.currentTaskId !== 'undefined') {
        window.currentTaskId = null;
    }
    if (typeof window.dataTimer !== 'undefined') {
        window.dataTimer = null;
    }
    
    console.log('æ‰€æœ‰è½®è¯¢å·²å¼ºåˆ¶åœæ­¢');
})();

// å…¨å±€å˜é‡
var isCollecting = false;
var currentTaskId = null;
var dataTimer = null;
</script>
{% endblock %}

{% block css %}
<style>
    .collection-container {
        padding: 20px;
        background: #f5f5f5;
        min-height: 100vh;
        color: #333;
    }

    .collection-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }

    .control-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-label {
        font-size: 18px;
        color: #333;
        white-space: nowrap;
    }

    .control-select {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 150px;
    }

    .control-input {
        background: white;
        color: #333;
        border: 1px solid #ccc;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 16px;
        min-width: 100px;
    }

    .control-input::placeholder {
        color: #999;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
    }

    .btn-reset {
        background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
        color: white;
        border: 1px solid #fd7e14;
    }

    .btn-reset:hover {
        background: linear-gradient(135deg, #e55a00, #cc4900);
        box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3);
        transform: translateY(-1px);
    }

    /* ç¦ç”¨çŠ¶æ€ */
    .btn:disabled {
        background: #e9ecef !important;
        color: #6c757d !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        transform: none !important;
    }

    /* æŒ‰é’®ç»„é—´è· */
    .control-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-buttons .btn {
        margin: 0;
    }

    .status-section {
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .content-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .data-display-panel, .ai-suggestion-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .panel-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
    }

    .panel-content {
        color: #333;
    }
    .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .data-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .data-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .data-card .card-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
    }
    .data-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .data-row .icon {
        font-size: 1.2rem;
        margin-right: 8px;
    }
    .data-row .label {
        color: #555;
        min-width: 90px;
    }
    .data-row .value {
        color: #333;
        font-weight: 500;
        margin-left: 6px;
    }
    .data-row .value.over {
        color: #dc3545;
        font-weight: bold;
        background: #ffebee;
        border-radius: 3px;
        padding: 0 4px;
    }
    .data-card .card-time {
        position: absolute;
        right: 18px;
        bottom: 10px;
        color: #666;
        font-size: 0.85em;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #e0e0e0;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    @media (max-width: 900px) {
        .cards-container {
            flex-direction: column;
            gap: 12px;
        }
        .data-card {
            max-width: 100%;
            min-width: 0;
        }
    }
    .param-box label,
    .param-box input,
    .param-box .custom-select,
    .param-box .btn {
        color: #222 !important;
    }
    .param-box label {
        font-weight: 600;
    }

    /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .custom-select {
        position: relative;
        display: inline-block;
        min-width: 200px;
    }

    .select-selected {
        background-color: white;
        color: #333;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: border-color 0.3s ease;
    }

    .select-selected:after {
        content: "";
        position: absolute;
        top: 50%;
        right: 15px;
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-color: #666 transparent transparent transparent;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
    }

    .select-selected.select-arrow-active:after {
        border-color: transparent transparent #666 transparent;
        transform: translateY(-50%) rotate(180deg);
    }

    .select-selected:hover {
        border-color: #007bff;
    }

    .select-items {
        position: absolute;
        background-color: white;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 99;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .select-items div {
        color: #333;
        padding: 10px 15px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .select-items div:hover {
        background-color: #f8f9fa;
    }

    .select-items div.selected {
        background-color: #007bff;
        color: white;
    }

    .select-hide {
        display: none;
    }

    /* ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçŠ¶æ€ */
    .select-items.show {
        display: block;
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .select-items div.empty {
        color: #999;
        font-style: italic;
        cursor: default;
    }

    .select-items div.empty:hover {
        background-color: transparent;
    }
    .task-status {
        background: #ffffff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
        color: #333;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .task-status.starting {
        border-left-color: #ffc107;
        background: #ffffff;
    }
    .task-status.running {
        border-left-color: #28a745;
        background: #ffffff;
    }
    .task-status.error {
        border-left-color: #dc3545;
        background: #ffffff;
    }
    .task-status.stopping {
        border-left-color: #6c757d;
        background: #ffffff;
    }
    .task-status.unknown {
        border-left-color: #6c757d;
        background: #ffffff;
    }
    .task-status strong {
        color: #333;
    }
    .task-status small {
        color: #666;
    }
    .task-status #statusText {
        font-weight: 500;
    }
    .task-status.running #statusText {
        color: #28a745;
    }
    .task-status.error #statusText {
        color: #dc3545;
    }
    .task-status.starting #statusText {
        color: #ffc107;
    }
    .alert {
        padding: 12px 20px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
        transition: all 0.3s ease;
    }
    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }
</style>
{% endblock %}

{% block content %}
<!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
<audio id="alertSound" preload="auto" style="display:none;">
    <source src="{% static 'sounds/alert.mp3' %}" type="audio/mpeg">
    <source src="{% static 'sounds/alert.wav' %}" type="audio/wav">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ 
</audio>

<div class="collection-container">
    <h1 class="collection-title">æ•°æ®è½®è¯¢é‡‡é›†</h1>

    <!-- æ§åˆ¶åŒºåŸŸ -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">IPåœ°å€é€‰æ‹©ï¼š</span>
            <div class="custom-select ip-select">
                <div class="select-selected ip-selected">é€‰æ‹©IP</div>
                <div class="select-items ip-items" id="ipSelect" style="display: none;">
                    <div data-value="102.168.46.50">éº’éºŸæœåŠ¡å™¨1 (102.168.46.50)</div>
                    <div data-value="192.168.1.100">æµ‹è¯•æœåŠ¡å™¨2 (192.168.1.100)</div>
                    <div data-value="10.0.0.50">æœ¬åœ°æœåŠ¡å™¨3 (10.0.0.50)</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">é€‰æ‹©ç«¯å£ï¼š</span>
            <div class="custom-select port-select">
                <div class="select-selected port-selected">é€‰æ‹©ç«¯å£</div>
                <div class="select-items port-items" id="portSelect" style="display: none;">
                    <div data-value="22">SSH (22)</div>
                    <div data-value="80">HTTP (80)</div>
                    <div data-value="443">HTTPS (443)</div>
                    <div data-value="3306">MySQL (3306)</div>
                    <div data-value="6379">Redis (6379)</div>
                    <div data-value="8080">åº”ç”¨æœåŠ¡ (8080)</div>
                    <div data-value="9000">ç›‘æ§æœåŠ¡ (9000)</div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">è½®è¯¢é—´éš”(ç§’)ï¼š</span>
            <input type="number" class="control-input" id="pollInterval" min="2" max="3600" value="30">
        </div>

        <div class="control-buttons">
            <button class="btn" id="startBtn">
                <i class="fa fa-play"></i> å¼€å§‹é‡‡é›†
            </button>
            <button class="btn" id="overBtn" disabled>
                <i class="fa fa-stop"></i> ç»“æŸé‡‡é›†
            </button>
            <button class="btn btn-reset" id="cleanupBtn" style="margin-left: 10px;">
                <i class="fa fa-trash"></i> æ¸…ç†ä»»åŠ¡
            </button>
            <button class="btn btn-danger" id="forceStopBtn" style="margin-left: 10px; background-color: #dc3545;">
                <i class="fa fa-power-off"></i> å¼ºåˆ¶åœæ­¢æ‰€æœ‰
            </button>


            
        </div>
    </div>

    <!-- é˜ˆå€¼è®¾ç½®åŒºåŸŸ -->
    <div class="control-section">
        <div class="control-group">
            <span class="control-label">CPUä½¿ç”¨ç‡(%)ï¼š</span>
            <input type="text" class="control-input" id="cpuRange" placeholder="ä¾‹å¦‚: 80">
        </div>

        <div class="control-group">
            <span class="control-label">å†…å­˜ä½¿ç”¨ç‡(%)ï¼š</span>
            <input type="text" class="control-input" id="memRange" placeholder="ä¾‹å¦‚: 85">
        </div>

        <div class="control-group">
            <span class="control-label">ç£ç›˜ä½¿ç”¨ç‡(%)ï¼š</span>
            <input type="text" class="control-input" id="diskRange" placeholder="ä¾‹å¦‚: 90">
        </div>

        <div class="control-group">
            <span class="control-label">ç½‘ç»œé€Ÿç‡(Mbps)ï¼š</span>
            <input type="text" class="control-input" id="netRange" placeholder="ä¾‹å¦‚: 100">
        </div>
    </div>

    <!-- çŠ¶æ€åŒºåŸŸ -->
    <div class="status-section">
        <div class="task-status" id="taskStatus" style="display: none;">
            <strong>ä»»åŠ¡çŠ¶æ€ï¼š</strong><span id="statusText">æœªå¯åŠ¨</span>
            <br><small>ä»»åŠ¡IDï¼š<span id="taskId">-</span></small>
            <br><small>åå°é‡‡é›†é—´éš”ï¼š<span id="backendInterval">-</span>ç§’</small>
            <br><small>å‰ç«¯åˆ·æ–°é—´éš”ï¼š<span id="frontendInterval">-</span>ç§’</small>
            <br><small>å¼€å§‹æ—¶é—´ï¼š<span id="startTime">-</span></small>
            <br><small>æœ€åæˆåŠŸï¼š<span id="lastSuccess">-</span></small>
            <br><small>é”™è¯¯æ¬¡æ•°ï¼š<span id="errorCount">0</span></small>
        </div>
        <div class="alert alert-warning" id="errorAlert" style="display: none;">
            <strong>è­¦å‘Šï¼</strong> <span id="errorMessage"></span>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
        <div class="alert alert-info" id="debugInfo" style="display: none;">
            <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong> <span id="debugMessage"></span>
        </div>
    </div>

    <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
    <div class="cards-container">
        <div class="data-card" id="cpuCard">
            <div class="card-title">ğŸ–¥ï¸ CPUæ€§èƒ½</div>
            <div class="card-content">
                <p>æš‚æ— æ•°æ®ï¼Œè¯·å¼€å§‹é‡‡é›†...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="memCard">
            <div class="card-title">ğŸ’¾ å†…å­˜æ€§èƒ½</div>
            <div class="card-content">
                <p>æš‚æ— æ•°æ®ï¼Œè¯·å¼€å§‹é‡‡é›†...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="diskCard">
            <div class="card-title">ğŸ’½ ç£ç›˜æ€§èƒ½</div>
            <div class="card-content">
                <p>æš‚æ— æ•°æ®ï¼Œè¯·å¼€å§‹é‡‡é›†...</p>
            </div>
            <div class="card-time"></div>
        </div>
        <div class="data-card" id="netCard">
            <div class="card-title">ğŸŒ ç½‘ç»œæ€§èƒ½</div>
            <div class="card-content">
                <p>æš‚æ— æ•°æ®ï¼Œè¯·å¼€å§‹é‡‡é›†...</p>
            </div>
            <div class="card-time"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    // æ’­æ”¾è­¦æŠ¥å£°éŸ³å‡½æ•°
function playAlertSound() {
    console.log('æ’­æ”¾è­¦æŠ¥å£°éŸ³...');
    
    // å¦‚æœé‡‡é›†å·²åœæ­¢ï¼Œä¸æ’­æ”¾è­¦æŠ¥
    if (!isCollecting) {
        console.log('é‡‡é›†å·²åœæ­¢ï¼Œä¸æ’­æ”¾è­¦æŠ¥');
        return;
    }
    
    // åœ¨HTTPç¯å¢ƒä¸‹ï¼Œä¼˜å…ˆä½¿ç”¨Web Audio API
    if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        console.log('æ£€æµ‹åˆ°HTTPç¯å¢ƒï¼Œä½¿ç”¨Web Audio API');
        playWebAudioFallback();
        return;
    }
    
    try {
        // åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ 
        const audio = new Audio("{% static 'sounds/alert.mp3' %}");
        audio.volume = 0.8;
        
        // æ·»åŠ ç”¨æˆ·äº¤äº’æ¥è§£é”éŸ³é¢‘
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('è­¦æŠ¥å£°éŸ³æ’­æ”¾æˆåŠŸ');
            }).catch(err => {
                console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', err);
                // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨Web Audio API
                playWebAudioFallback();
            });
        }
    } catch (e) {
        console.error('åˆ›å»ºéŸ³é¢‘å¯¹è±¡å¤±è´¥:', e);
        // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨Web Audio API
        playWebAudioFallback();
    }
}

function playWebAudioFallback() {
    try {
        // å¦‚æœé‡‡é›†å·²åœæ­¢ï¼Œä¸æ’­æ”¾è­¦æŠ¥
        if (!isCollecting) {
            console.log('é‡‡é›†å·²åœæ­¢ï¼Œä¸æ’­æ”¾Web Audioè­¦æŠ¥');
            return;
        }
        
        console.log('ä½¿ç”¨Web Audio APIæ’­æ”¾è­¦æŠ¥å£°éŸ³...');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰éŸ³é¢‘ä¸Šä¸‹æ–‡
        if (!window.audioContext) {
            window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œæ¢å¤å®ƒ
        if (window.audioContext.state === 'suspended') {
            window.audioContext.resume();
        }
        
        // åˆ›å»ºæŒ¯è¡å™¨
        const oscillator = window.audioContext.createOscillator();
        const gain = window.audioContext.createGain();
        
        oscillator.connect(gain);
        gain.connect(window.audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.value = 800; // 800Hz
        gain.gain.value = 0.3; // é™ä½éŸ³é‡
        
        oscillator.start();
        
        // æ’­æ”¾500æ¯«ç§’ååœæ­¢
        setTimeout(() => {
            oscillator.stop();
            // ä¸å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œä¿æŒå®ƒæ´»è·ƒ
        }, 500);
        
        console.log('Web Audio APIè­¦æŠ¥å£°éŸ³æ’­æ”¾æˆåŠŸ');
    } catch (e) {
        console.error('Web Audio APIå¤±è´¥:', e);
        // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨é€šçŸ¥
        showBrowserNotification();
    }
}

function showBrowserNotification() {
    try {
        // å¦‚æœé‡‡é›†å·²åœæ­¢ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
        if (!isCollecting) {
            console.log('é‡‡é›†å·²åœæ­¢ï¼Œä¸æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥');
            return;
        }
        
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ç³»ç»Ÿé¢„è­¦', {
                body: 'æ£€æµ‹åˆ°æ€§èƒ½æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼',
                icon: '/static/img/kylin.ico'
            });
        }
    } catch (e) {
        console.error('æµè§ˆå™¨é€šçŸ¥å¤±è´¥:', e);
    }
}

// ä¸‹æ‹‰é€‰æ‹©æ¡†é€»è¾‘ï¼ˆä¸å…¶ä»–é¡µé¢ä¸€è‡´ï¼‰
function setupDropdown(selectedClass, itemsClass) {
    console.log('è®¾ç½®ä¸‹æ‹‰æ¡†:', selectedClass, itemsClass);
    
    $(document).on("click", "." + selectedClass, function (e) {
        e.stopPropagation();
        console.log('ç‚¹å‡»ä¸‹æ‹‰æ¡†:', selectedClass);
        
        // åˆ‡æ¢ç®­å¤´çŠ¶æ€
        $(this).toggleClass("select-arrow-active");
        
        // åˆ‡æ¢ä¸‹æ‹‰åˆ—è¡¨æ˜¾ç¤º
        var items = $(this).siblings("." + itemsClass);
        items.toggle();
        
        // éšè—å…¶ä»–ä¸‹æ‹‰æ¡†
        $("." + itemsClass).not(items).hide();
        $("." + selectedClass).not(this).removeClass("select-arrow-active");
    });
    
    $(document).on("click", "." + itemsClass + " div", function () {
        var selectedText = $(this).text();
        var selectedVal = $(this).attr("data-ip") || $(this).attr("data-port") || selectedText;
        
        console.log('é€‰æ‹©é¡¹ç›®:', selectedText, selectedVal);
        
        // æ›´æ–°é€‰ä¸­çš„æ–‡æœ¬å’Œå€¼
        $(this).parent().siblings(".select-selected").text(selectedText);
        $(this).parent().siblings(".select-selected").attr("data-ip", selectedVal);
        $(this).parent().siblings(".select-selected").attr("data-port", selectedVal);
        
        // ä¿å­˜åˆ°localStorage
        if (itemsClass === "ip-items") {
            localStorage.setItem('selectedIp', selectedVal);
            localStorage.setItem('selectedIpText', selectedText);
            console.log('IPå·²ä¿å­˜åˆ°localStorage:', selectedVal);
        } else if (itemsClass === "port-items") {
            localStorage.setItem('selectedPort', selectedVal);
            localStorage.setItem('selectedPortText', selectedText);
            console.log('ç«¯å£å·²ä¿å­˜åˆ°localStorage:', selectedVal);
        }
        
        // éšè—ä¸‹æ‹‰åˆ—è¡¨
        $(this).parent().hide();
        $(this).parent().siblings(".select-selected").removeClass("select-arrow-active");
        
        // å¦‚æœæ˜¯IPé€‰æ‹©ï¼Œè‡ªåŠ¨åŠ è½½ç«¯å£
        if (itemsClass === "ip-items" && selectedVal) {
            console.log('è‡ªåŠ¨åŠ è½½ç«¯å£ï¼ŒIP:', selectedVal);
            requestTwoModel("cpu", "get_port", JSON.stringify({ "ip": selectedVal }), function (portData) {
                console.log('ç«¯å£æ•°æ®:', portData);
                paddingPortSelectTag(portData);
            }, function(error) {
                console.error('è·å–ç«¯å£å¤±è´¥:', error);
                showError('è·å–ç«¯å£åˆ—è¡¨å¤±è´¥');
            });
        }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    $(document).click(function (event) {
        if (!$(event.target).closest('.custom-select').length) {
            $(".ip-items, .port-items").hide();
            $(".ip-selected, .port-selected").removeClass("select-arrow-active");
        }
    });
}

// åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
setupDropdown("ip-selected", "ip-items");
setupDropdown("port-selected", "port-items");

// åå°ä»»åŠ¡ç®¡ç†
let currentTaskId = null;
let dataTimer = null;
let isCollecting = false;

function parseRange(str) {
    // "1~80" => [1,80] æˆ– "80" => [0,80]
    if (!str) return [null, null];
    if (str.includes("~")) {
        let [min, max] = str.split("~").map(Number);
        return [min, max];
    } else {
        let num = Number(str);
        return [0, num];
    }
}

function highlight(val, min, max) {
    if (min === null || max === null) return '';
    val = parseFloat(val);
    if (isNaN(val)) return '';
    if (val < min || val > max) return 'over';
    return '';
}

function renderCard(cardId, data, range, type) {
    let content = '';
    let time = '';
    
    console.log(`=== æ¸²æŸ“${type}æ•°æ® ===`);
    console.log('å¡ç‰‡ID:', cardId);
    console.log('åŸå§‹æ•°æ®:', data);
    console.log('æ•°æ®ç±»å‹:', typeof data);
    console.log('æ•°æ®æ˜¯å¦ä¸ºå¯¹è±¡:', typeof data === 'object');
    
    if (!data || typeof data !== 'object') {
        console.warn(`${type}æ•°æ®æ— æ•ˆ:`, data);
        $(cardId + ' .card-content').html('<span style="color:#aaa;">æš‚æ— æ•°æ®, è¯·å¼€å§‹é‡‡é›†...</span>');
        $(cardId + ' .card-time').text('');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰messageå­—æ®µï¼ˆè¡¨ç¤ºæ²¡æœ‰æ•°æ®ï¼‰
    if (data.message) {
        console.warn(`${type}æ•°æ®åŒ…å«é”™è¯¯ä¿¡æ¯:`, data.message);
        $(cardId + ' .card-content').html(`<span style="color:#ff6b6b;">âš ï¸ ${data.message}</span>`);
        $(cardId + ' .card-time').text('');
        return;
    }
    
    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    let hasData = false;
    
    // æ ¹æ®ä¸åŒç±»å‹æ£€æŸ¥å…³é”®å­—æ®µ
    switch(type) {
        case 'cpu':
            hasData = data.cpu_percent !== undefined;
            break;
        case 'mem':
            hasData = data.mem_percent !== undefined;
            break;
        case 'disk':
            hasData = data.disk_percent !== undefined;
            break;
        case 'net':
            hasData = data.net_bytes_sent !== undefined || data.net_bytes_recv !== undefined;
            break;
    }
    
    console.log(`${type}æ•°æ®å®Œæ•´æ€§æ£€æŸ¥:`, {
        type: type,
        hasData: hasData,
        key_fields: Object.keys(data)
    });
    
    if (!hasData) {
        console.warn(`${type}æ•°æ®ä¸å®Œæ•´:`, data);
        $(cardId + ' .card-content').html('<span style="color:#aaa;">æ•°æ®ä¸å®Œæ•´</span>');
        $(cardId + ' .card-time').text('');
        return;
    }

    let [min, max] = range;
    
    if (type === 'cpu') {
        let percent = data.cpu_percent ?? 0;
        let threshold = parseFloat($("#cpuRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">CPUä½¿ç”¨ç‡</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ–¥ï¸</span><span class="label">ä¸»æœº</span><span class="value">${data.host ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸŸ¢</span><span class="label">cpuæ ¸å¿ƒæ•°</span><span class="value">${data.cpu_count ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â°</span><span class="label">å®é™…CPUæ—¶é—´</span><span class="value">${data.cpu_user_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â°</span><span class="label">CPUè¿è¡Œæ—¶é—´</span><span class="value">${data.cpu_system_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â°</span><span class="label">CPUç©ºé—²æ—¶é—´</span><span class="value">${data.cpu_idle_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â°</span><span class="label">CPUç­‰å¾…æ—¶é—´</span><span class="value">${data.cpu_wait_time ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ–¥ï¸</span><span class="label">CPUå‹å·</span><span class="value">${data.cpu_model ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'mem') {
        let percent = data.mem_percent ?? 0;
        let threshold = parseFloat($("#memRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">å†…å­˜ä½¿ç”¨ç‡</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ’¾</span><span class="label">æ€»å†…å­˜</span><span class="value">${data.mem_total ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">å·²ç”¨å†…å­˜</span><span class="value">${data.mem_used ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸŸ¢</span><span class="label">å¯ç”¨å†…å­˜</span><span class="value">${data.mem_free ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“„</span><span class="label">ç¼“å†²åŒº</span><span class="value">${data.mem_buffers ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“¦</span><span class="label">ç¼“å­˜</span><span class="value">${data.mem_cached ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ”„</span><span class="label">äº¤æ¢åŒº</span><span class="value">${data.swap_used ?? '-'}/${data.swap_total ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'disk') {
        let percent = data.disk_percent ?? 0;
        let threshold = parseFloat($("#diskRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">ç£ç›˜ä½¿ç”¨ç‡</span><span class="value ${highlight(percent, min, max)}">${percent}%</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ’¾</span><span class="label">æ€»å®¹é‡</span><span class="value">${data.disk_total ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">å·²ç”¨ç©ºé—´</span><span class="value">${data.disk_used ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸŸ¢</span><span class="label">å¯ç”¨ç©ºé—´</span><span class="value">${data.disk_free ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â¬†ï¸</span><span class="label">è¯»æ•°æ®é‡</span><span class="value">${data.disk_read ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â¬‡ï¸</span><span class="label">å†™æ•°æ®é‡</span><span class="value">${data.disk_write ?? '-'}</span></div>`;
        time = data.time || '';
    } else if (type === 'net') {
        let speed = parseFloat(data.net_speed) || 0;
        let threshold = parseFloat($("#netRange").val()) || 0;
        content += `<div class="data-row"><span class="icon">ğŸ–¥ï¸</span><span class="label">ä¸»æœº</span><span class="value">${data.host ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â¬†ï¸</span><span class="label">å‘é€å­—èŠ‚</span><span class="value ${highlight(speed, min, max)}">${data.net_bytes_sent ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">â¬‡ï¸</span><span class="label">æ¥æ”¶å­—èŠ‚</span><span class="value ${highlight(speed, min, max)}">${data.net_bytes_recv ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">æ¥æ”¶åŒ…æ•°</span><span class="value">${data.net_packets_recv ?? '-'}</span></div>`;
        content += `<div class="data-row"><span class="icon">ğŸ“Š</span><span class="label">å‘é€åŒ…æ•°</span><span class="value">${data.net_packets_sent ?? '-'}</span></div>`;
        if (data.net_speed) {
            content += `<div class="data-row"><span class="icon">ğŸ“¶</span><span class="label">ç½‘ç»œé€Ÿç‡</span><span class="value">${data.net_speed ?? '-'} Mbps</span></div>`;
        }
        time = data.time || '';
    }
    
    $(cardId + ' .card-content').html(content);
    
    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    if (time) {
        let formattedTime = '';
        if (typeof time === 'string') {
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            formattedTime = time;
        } else if (time instanceof Date) {
            // å¦‚æœæ˜¯Dateå¯¹è±¡ï¼Œæ ¼å¼åŒ–
            formattedTime = time.toLocaleString('zh-CN');
        } else {
            // å…¶ä»–æƒ…å†µï¼Œå°è¯•è½¬æ¢
            try {
                formattedTime = new Date(time).toLocaleString('zh-CN');
            } catch (e) {
                formattedTime = time.toString();
            }
        }
        $(cardId + ' .card-time').text(formattedTime);
    } else {
        $(cardId + ' .card-time').text('');
    }
}

// å¯åŠ¨åå°é‡‡é›†ä»»åŠ¡
function startBackgroundCollection() {
    if (isCollecting) return;
    
    let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
    let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
    let interval = parseInt($("#pollInterval").val()) || 30;
    
    if (!ip || ip === "é€‰æ‹©IP" || !port || port === "é€‰æ‹©ç«¯å£") {
        alert("è¯·å…ˆé€‰æ‹©IPå’Œç«¯å£");
        return;
    }
    
    // éªŒè¯é˜ˆå€¼è®¾ç½®
    const cpuThreshold = $("#cpuRange").val();
    const memThreshold = $("#memRange").val();
    const diskThreshold = $("#diskRange").val();
    const netThreshold = $("#netRange").val();
    
    // æç¤ºç”¨æˆ·è®¾ç½®é˜ˆå€¼
    if (!cpuThreshold && !memThreshold && !diskThreshold && !netThreshold) {
        if (!confirm("æ‚¨å°šæœªè®¾ç½®ä»»ä½•é˜ˆå€¼ï¼Œè¿™å°†å¯¼è‡´æ— æ³•æ”¶åˆ°å‘Šè­¦é€šçŸ¥ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")) {
            return;
        }
    }
    
    // å‘é€å¯åŠ¨åå°é‡‡é›†ä»»åŠ¡è¯·æ±‚
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'start',
            ip: ip,
            port: port,
            interval: interval
        }),
        success: function(response) {
            if (response.success) {
                currentTaskId = response.task_id;
                isCollecting = true;
                
                // è®¾ç½®é‡‡é›†çŠ¶æ€æ ‡è®°ï¼Œç¡®ä¿å…¨å±€ç›‘æ§èƒ½å¤Ÿæ­£ç¡®å·¥ä½œ
                localStorage.setItem('isCollecting', 'true');
                
                // æ›´æ–°UIçŠ¶æ€
                $("#startBtn").prop("disabled", true);
                $("#overBtn").prop("disabled", false);
                
                // æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€å’Œé—´éš”ä¿¡æ¯
                $("#taskStatus").show().removeClass('stopped').addClass('running');
                $("#statusText").text("è¿è¡Œä¸­");
                $("#taskId").text(currentTaskId);
                $("#backendInterval").text(interval);
                
                // å¼€å§‹å®šæ—¶è·å–æ•°æ®
                startDataPolling();
                
                // å¯åŠ¨å…¨å±€ç›‘æ§
                if (window.monitorManager) {
                    window.monitorManager.startChecking();
                    console.log('å·²å¯åŠ¨å…¨å±€ç›‘æ§');
                }
                
                // ä¿å­˜ä»»åŠ¡çŠ¶æ€å’Œé˜ˆå€¼è®¾ç½®
                saveTaskState();
                
                alert("åå°é‡‡é›†ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼åå°é‡‡é›†é—´éš”ï¼š" + interval + "ç§’");
            } else {
                alert("å¯åŠ¨å¤±è´¥ï¼š" + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert("å¯åŠ¨å¤±è´¥ï¼š" + error);
        }
    });
}

// åœæ­¢åå°é‡‡é›†ä»»åŠ¡
function stopBackgroundCollection() {
    console.log('å°è¯•åœæ­¢é‡‡é›†ä»»åŠ¡:', { isCollecting, currentTaskId });
    
    // å…ˆåœæ­¢å‰ç«¯æ•°æ®è½®è¯¢
    stopDataPolling();
    
    // ç«‹å³æ›´æ–°å‰ç«¯çŠ¶æ€ï¼Œç¡®ä¿ä¸å†è§¦å‘è­¦æŠ¥
    isCollecting = false;
    localStorage.removeItem('isCollecting');
    
    // æ¸…é™¤æ‰€æœ‰ç°æœ‰é¢„è­¦ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
    clearAllAlerts(true);
    
    // åœæ­¢å…¨å±€ç›‘æ§
    if (window.monitorManager) {
        window.monitorManager.stopChecking();
        console.log('å·²åœæ­¢å…¨å±€ç›‘æ§');
        
        // æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•
        if (typeof window.monitorManager.clearAllAlerts === 'function') {
            window.monitorManager.clearAllAlerts();
            console.log('å·²æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•');
        }
    }
    
    // å¦‚æœæ²¡æœ‰ä»»åŠ¡IDï¼Œç›´æ¥æ›´æ–°UIçŠ¶æ€
    if (!currentTaskId) {
        console.warn('æ²¡æœ‰ä»»åŠ¡IDï¼Œç›´æ¥æ›´æ–°UIçŠ¶æ€');
        $("#startBtn").prop("disabled", false);
        $("#overBtn").prop("disabled", true);
        $("#taskStatus").removeClass('running').addClass('stopped');
        $("#statusText").text("å·²åœæ­¢");
        localStorage.removeItem('collectionTaskState');
        showDebug('å‰ç«¯çŠ¶æ€å·²é‡ç½®');
        return;
    }
    
    showDebug('æ­£åœ¨åœæ­¢é‡‡é›†ä»»åŠ¡...');
    
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'stop',
            task_id: currentTaskId
        }),
        success: function(response) {
            console.log('åœæ­¢ä»»åŠ¡å“åº”:', response);
            
            // æ›´æ–°å‰ç«¯çŠ¶æ€
            currentTaskId = null;
            $("#startBtn").prop("disabled", false);
            $("#overBtn").prop("disabled", true);
            $("#taskStatus").removeClass('running').addClass('stopped');
            $("#statusText").text("å·²åœæ­¢");
            localStorage.removeItem('collectionTaskState');
            
            // å†æ¬¡ç¡®ä¿æ‰€æœ‰é¢„è­¦å·²æ¸…é™¤ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
            clearAllAlerts(true);
            
            if (response.success) {
                showDebug('é‡‡é›†ä»»åŠ¡å·²æˆåŠŸåœæ­¢');
                alert("åå°é‡‡é›†ä»»åŠ¡å·²åœæ­¢ï¼");
                // å»¶è¿Ÿæ¸…ç†ä»»åŠ¡çŠ¶æ€
                delayedCleanup();
            } else {
                console.warn('åç«¯åœæ­¢ä»»åŠ¡å¤±è´¥ï¼Œä½†å‰ç«¯çŠ¶æ€å·²é‡ç½®:', response.message);
                showDebug('å‰ç«¯çŠ¶æ€å·²é‡ç½®ï¼Œåç«¯ä»»åŠ¡å¯èƒ½å·²åœæ­¢: ' + response.message);
                // å°è¯•å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡
                forceStopAllTasks();
            }
        },
        error: function(xhr, status, error) {
            console.error('åœæ­¢ä»»åŠ¡APIè°ƒç”¨å¤±è´¥:', { xhr, status, error });
            
            // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°å‰ç«¯çŠ¶æ€
            currentTaskId = null;
            $("#startBtn").prop("disabled", false);
            $("#overBtn").prop("disabled", true);
            $("#taskStatus").removeClass('running').addClass('stopped');
            $("#statusText").text("å·²åœæ­¢");
            localStorage.removeItem('collectionTaskState');
            
            // å†æ¬¡ç¡®ä¿æ‰€æœ‰é¢„è­¦å·²æ¸…é™¤ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
            clearAllAlerts(true);
            
            if (xhr.status === 400) {
                showDebug('åœæ­¢è¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œä½†å‰ç«¯çŠ¶æ€å·²é‡ç½®');
                alert("åœæ­¢è¯·æ±‚å¤„ç†å¼‚å¸¸ï¼Œä½†å‰ç«¯çŠ¶æ€å·²é‡ç½®");
            } else {
                showError('åœæ­¢ä»»åŠ¡APIè°ƒç”¨å¤±è´¥ï¼Œä½†å‰ç«¯çŠ¶æ€å·²é‡ç½®: ' + error);
                alert("ç½‘ç»œé”™è¯¯ï¼Œä½†å‰ç«¯çŠ¶æ€å·²é‡ç½®");
            }
            
            // å°è¯•å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡
            forceStopAllTasks();
        }
    });
}

// æ¸…é™¤æ‰€æœ‰ç°æœ‰é¢„è­¦
function clearAllAlerts(silent) {
    console.log('æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•, silent:', silent);
    
    // silentå‚æ•°æ§åˆ¶æ˜¯å¦ä½¿ç”¨é™é»˜æ–¹å¼æ¸…é™¤é¢„è­¦ï¼ˆä¸å¼¹ç¡®è®¤æ¡†ï¼‰
    silent = (silent === true);
    
    // å°è¯•å…³é—­é¢„è­¦ç®¡ç†é¢æ¿
    try {
        // æ‰¾åˆ°å¹¶å…³é—­é¢„è­¦é¢æ¿
        var $alertPanel = $('.é¢„è­¦ç®¡ç†, [aria-label="é¢„è­¦ç®¡ç†"], .alert-panel, .modal:contains("é¢„è­¦ç®¡ç†")');
        if ($alertPanel.length > 0) {
            console.log('æ‰¾åˆ°é¢„è­¦é¢æ¿ï¼Œå°è¯•å…³é—­');
            $alertPanel.hide();
        }
        
        // æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•æ•°æ®
        localStorage.removeItem('alerts');
        localStorage.removeItem('lastAlerts');
        localStorage.removeItem('alertHistory');
        
        // å¦‚æœéœ€è¦é™é»˜æ¨¡å¼ï¼Œä¸è°ƒç”¨å¯èƒ½ä¼šå¼¹çª—çš„API
        if (!silent) {
            try {
                // ç›´æ¥å…³é—­æ¨¡æ€æ¡†
                if (typeof $.fn.modal === 'function') {
                    $(".modal").modal("hide");
                }
                
                // å°è¯•ç‚¹å‡»"æ ‡è®°å·²è¯»"å’Œ"å…³é—­"æŒ‰é’®
                $(".modal .btn-primary, .modal .btn-success, .modal button:contains('æ ‡è®°å·²è¯»')").click();
                $(".modal .btn-secondary, .modal .close, .modal button:contains('å…³é—­')").click();
            } catch (modalError) {
                console.log('æ¨¡æ€æ¡†æ“ä½œå‡ºé”™ï¼Œå¯å¿½ç•¥:', modalError);
            }
            
            // å°è¯•è°ƒç”¨APIæ¸…é™¤æ‰€æœ‰é¢„è­¦
            $.ajax({
                url: '/api/alerts/clear',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'clear_all',
                    silent: true
                }),
                success: function(response) {
                    console.log('æ¸…é™¤é¢„è­¦APIè°ƒç”¨æˆåŠŸ:', response);
                },
                error: function() {
                    console.log('æ¸…é™¤é¢„è­¦APIè°ƒç”¨å¤±è´¥ï¼Œä½†å·²æœ¬åœ°æ¸…é™¤é¢„è­¦è®°å½•');
                }
            });
        }
        
        // å¦‚æœæœ‰é¢„è­¦DOMå…ƒç´ ï¼Œç§»é™¤å®ƒä»¬
        $('.alert-item, .cpu-alert, .memory-alert, .disk-alert, .network-alert').remove();
        
        // é€šè¿‡ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­é¢„è­¦é¢æ¿
        $('.close-alerts, .dismiss-alerts, [data-dismiss="alert"], [data-dismiss="modal"]').click();
        
        // ç›´æ¥ç‚¹å‡»é¡µé¢ä¸Šå¯è§çš„ç‰¹å®šæŒ‰é’® - åªåœ¨éé™é»˜æ¨¡å¼ä¸‹æ‰§è¡Œ
        if (!silent) {
            $('button:contains("æ ‡è®°å·²è¯»"), button:contains("å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»")').click();
            $('button:contains("æ¸…é™¤æ‰€æœ‰é¢„è­¦"), button:contains("æ¸…é™¤æ‰€æœ‰")').click();
            
            // å³ä½¿æœ‰é”™è¯¯ä¹Ÿå°è¯•è°ƒç”¨ç‰¹å®šAPI
            try {
                // ä»æˆªå›¾çœ‹åˆ°çš„é¢„è­¦å¼¹çª—ï¼Œå°è¯•è°ƒç”¨ä¸æ ‡è®°å·²è¯»ç›¸å…³çš„API
                $.ajax({
                    url: '/api/mark_alerts_read/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        action: 'mark_all_read',
                        silent: true
                    })
                });
            } catch (apiError) {
                console.log('è°ƒç”¨æ ‡è®°å·²è¯»APIå‡ºé”™ï¼Œå¯ä»¥å¿½ç•¥', apiError);
            }
        }
        
        console.log('é¢„è­¦è®°å½•å·²æ¸…é™¤');
    } catch (e) {
        console.error('æ¸…é™¤é¢„è­¦è®°å½•æ—¶å‡ºé”™:', e);
    }
}

// å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡
function forceStopAllTasks() {
    console.log('å°è¯•å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡...');
    
    // ç«‹å³æ›´æ–°å‰ç«¯çŠ¶æ€ï¼Œç¡®ä¿ä¸å†è§¦å‘è­¦æŠ¥
    isCollecting = false;
    localStorage.removeItem('isCollecting');
    
    // æ¸…é™¤æ‰€æœ‰ç°æœ‰é¢„è­¦ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
    clearAllAlerts(true);
    
    // åœæ­¢å…¨å±€ç›‘æ§
    if (window.monitorManager) {
        window.monitorManager.stopChecking();
        console.log('å·²åœæ­¢å…¨å±€ç›‘æ§');
        
        // æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•
        if (typeof window.monitorManager.clearAllAlerts === 'function') {
            window.monitorManager.clearAllAlerts();
            console.log('å·²æ¸…é™¤æ‰€æœ‰é¢„è­¦è®°å½•');
        }
    }
    
    // å°è¯•å…³é—­é¢„è­¦é¢æ¿
    $('.é¢„è­¦ç®¡ç†, [aria-label="é¢„è­¦ç®¡ç†"], .alert-panel').hide();
    
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'force_stop_all'
        }),
        success: function(response) {
            if (response.success) {
                console.log('å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡æˆåŠŸ:', response);
                showDebug('å·²å¼ºåˆ¶åœæ­¢æ‰€æœ‰åå°ä»»åŠ¡');
                
                // å¼ºåˆ¶æ¸…ç†å‰ç«¯çŠ¶æ€
                forceStopAllPolling();
                
                // å†æ¬¡æ¸…é™¤æ‰€æœ‰é¢„è­¦ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
                clearAllAlerts(true);
                
                // å…³é—­é¢„è­¦æ¨¡æ€æ¡†ï¼ˆç›´æ¥ç‚¹å‡»å…³é—­æŒ‰é’®ï¼‰
                $('.å…³é—­, .close, [data-dismiss="modal"]').click();
            } else {
                console.warn('å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡å¤±è´¥:', response.message);
                showError('å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡å¤±è´¥: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡APIè°ƒç”¨å¤±è´¥:', error);
            showError('å¼ºåˆ¶åœæ­¢æ‰€æœ‰ä»»åŠ¡APIè°ƒç”¨å¤±è´¥: ' + error);
            
            // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿè¦æ¸…é™¤é¢„è­¦ï¼ˆä½¿ç”¨é™é»˜æ¨¡å¼ï¼‰
            clearAllAlerts(true);
        }
    });
}

// å¼€å§‹å®šæ—¶è·å–æ•°æ®
function startDataPolling() {
    if (dataTimer) clearInterval(dataTimer);
    
    function fetchLatestData() {
        let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
        let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
        let cpuRange = parseRange($("#cpuRange").val());
        let memRange = parseRange($("#memRange").val());
        let diskRange = parseRange($("#diskRange").val());
        let netRange = parseRange($("#netRange").val());
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('=== æ•°æ®è·å–è°ƒè¯•ä¿¡æ¯ ===');
        console.log('IP:', ip);
        console.log('Port:', port);
        console.log('IPå…ƒç´ :', $(".ip-selected").attr("data-ip"), $(".ip-selected").text());
        console.log('Portå…ƒç´ :', $(".port-selected").attr("data-port"), $(".port-selected").text());
        
        // ä¿å­˜å½“å‰IPå’Œç«¯å£åˆ°localStorageï¼Œä»¥ä¾¿å…¨å±€ç›‘æ§ä½¿ç”¨
        localStorage.setItem('selectedIp', ip);
        localStorage.setItem('selectedPort', port);
        
        // è·å–æœ€æ–°æ•°æ®
        $.ajax({
            url: '/api/get_latest_data/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                ip: ip,
                port: port
            }),
            success: function(response) {
                console.log('=== APIå“åº”è¯¦æƒ… ===');
                console.log('å®Œæ•´å“åº”:', response);
                console.log('å“åº”æˆåŠŸ:', response.success);
                console.log('æ•°æ®å¯¹è±¡:', response.data);
                console.log('CPUæ•°æ®:', response.data?.cpu);
                console.log('å†…å­˜æ•°æ®:', response.data?.memory);
                console.log('ç£ç›˜æ•°æ®:', response.data?.disk);
                console.log('ç½‘ç»œæ•°æ®:', response.data?.network);
                
                if (response.success) {
                    if (response.data && Object.keys(response.data).length > 0) {
                        console.log('å¼€å§‹æ¸²æŸ“æ•°æ®å¡ç‰‡...');
                        
                        // æ£€æŸ¥é˜ˆå€¼å¹¶è§¦å‘è­¦æŠ¥
                        checkAndTriggerAlerts(response.data);
                        
                        // æ¸²æŸ“æ•°æ®å¡ç‰‡
                        renderCard('#cpuCard', response.data.cpu, cpuRange, 'cpu');
                        renderCard('#memCard', response.data.memory, memRange, 'mem');
                        renderCard('#diskCard', response.data.disk, diskRange, 'disk');
                        renderCard('#netCard', response.data.network, netRange, 'net');
                        
                        // æ›´æ–°æœ€åæˆåŠŸæ—¶é—´
                        $("#lastSuccess").text(new Date().toLocaleString('zh-CN'));
                    } else {
                        console.warn('APIè¿”å›æˆåŠŸä½†æ²¡æœ‰æ•°æ®');
                        showWarning('APIè¿”å›æˆåŠŸä½†æ²¡æœ‰æ•°æ®');
                    }
                } else {
                    // æ›´æ–°é”™è¯¯è®¡æ•°
                    let errorCount = parseInt($("#errorCount").text()) || 0;
                    $("#errorCount").text(errorCount + 1);
                    
                    console.error('APIè¿”å›å¤±è´¥:', response.message);
                    showError('è·å–æ•°æ®å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                }
            },
            error: function(xhr, status, error) {
                console.log("è·å–æ•°æ®å¤±è´¥ï¼š" + error);
                console.log("XHRçŠ¶æ€:", xhr.status);
                console.log("é”™è¯¯è¯¦æƒ…:", xhr.responseText);
                showError("è·å–æ•°æ®å¤±è´¥ï¼Œå°†åœ¨ä¸‹æ¬¡è½®è¯¢æ—¶é‡è¯•");
            }
        });
        
        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        if (currentTaskId && isCollecting) {
            $.ajax({
                url: '/api/background_collection/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'status',
                    task_id: currentTaskId
                }),
                success: function(response) {
                    if (response.success && response.status) {
                        updateTaskStatus(response.status);
                    } else if (!response.success) {
                        console.warn("ä»»åŠ¡çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼š" + response.message);
                        // å¦‚æœä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢è½®è¯¢
                        if (response.message && response.message.includes('ä»»åŠ¡ä¸å­˜åœ¨')) {
                            console.log('ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢æ•°æ®è½®è¯¢');
                            stopDataPolling();
                            isCollecting = false;
                            currentTaskId = null;
                            $("#startBtn").prop("disabled", false);
                            $("#overBtn").prop("disabled", true);
                            $("#taskStatus").removeClass('running').addClass('stopped');
                            $("#statusText").text("ä»»åŠ¡å·²åœæ­¢");
                            showError("åå°ä»»åŠ¡å·²åœæ­¢ï¼Œæ•°æ®è½®è¯¢å·²åœæ­¢");
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.log("æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼š" + error);
                    // å¦‚æœæ˜¯404é”™è¯¯ï¼Œè¯´æ˜ä»»åŠ¡ä¸å­˜åœ¨
                    if (xhr.status === 404) {
                        console.log('ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢æ•°æ®è½®è¯¢');
                        stopDataPolling();
                        isCollecting = false;
                        currentTaskId = null;
                        $("#startBtn").prop("disabled", false);
                        $("#overBtn").prop("disabled", true);
                        $("#taskStatus").removeClass('running').addClass('stopped');
                        $("#statusText").text("ä»»åŠ¡å·²åœæ­¢");
                        showError("åå°ä»»åŠ¡å·²åœæ­¢ï¼Œæ•°æ®è½®è¯¢å·²åœæ­¢");
                    }
                }
            });
        }
    }
    
    // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
    fetchLatestData();
    
    // æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é—´éš”æ—¶é—´è¿›è¡Œè½®è¯¢ï¼ˆæœ€å°3ç§’ï¼Œæœ€å¤§ä¸è¶…è¿‡è®¾ç½®çš„é—´éš”ï¼‰
    let pollInterval = parseInt($("#pollInterval").val()) || 30;
    let frontendInterval = Math.max(3, Math.min(pollInterval, 30)) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’ï¼Œæœ€å°3ç§’ï¼Œæœ€å¤§30ç§’
    
    console.log(`å‰ç«¯æ•°æ®è½®è¯¢é—´éš”è®¾ç½®ä¸º: ${frontendInterval/1000}ç§’ (åå°é‡‡é›†é—´éš”: ${pollInterval}ç§’)`);
    
    // æ›´æ–°å‰ç«¯é—´éš”æ˜¾ç¤º
    $("#frontendInterval").text(frontendInterval/1000);
    
    dataTimer = setInterval(fetchLatestData, frontendInterval);
}

// åœæ­¢æ•°æ®è½®è¯¢
function stopDataPolling() {
    console.log('å°è¯•åœæ­¢æ•°æ®è½®è¯¢ï¼Œå½“å‰dataTimer:', dataTimer);
    
    if (dataTimer) {
        clearInterval(dataTimer);
        dataTimer = null;
        console.log('æ•°æ®è½®è¯¢å·²åœæ­¢');
    } else {
        console.log('æ²¡æœ‰æ´»åŠ¨çš„è½®è¯¢å®šæ—¶å™¨');
    }
}

// å¼ºåˆ¶åœæ­¢æ‰€æœ‰è½®è¯¢ï¼ˆç”¨äºè°ƒè¯•ï¼‰
function forceStopAllPolling() {
    console.log('å¼ºåˆ¶åœæ­¢æ‰€æœ‰è½®è¯¢...');
    
    // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„å®šæ—¶å™¨
    if (dataTimer) {
        clearInterval(dataTimer);
        dataTimer = null;
    }
    
    // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨ï¼ˆæ›´å½»åº•çš„æ–¹æ³•ï¼‰
    for (let i = 1; i <= 10000; i++) {
        clearInterval(i);
        clearTimeout(i);
    }
    
    // é‡ç½®çŠ¶æ€å˜é‡
    isCollecting = false;
    currentTaskId = null;
    
    // æ›´æ–°UIçŠ¶æ€
    $("#startBtn").prop("disabled", false);
    $("#overBtn").prop("disabled", true);
    $("#taskStatus").removeClass('running').addClass('stopped');
    $("#statusText").text("å·²åœæ­¢");
    
    // æ¸…é™¤localStorage
    localStorage.removeItem('collectionTaskState');
    
    console.log('æ‰€æœ‰è½®è¯¢å·²å¼ºåˆ¶åœæ­¢ï¼ŒçŠ¶æ€å·²é‡ç½®');
}

// å»¶è¿Ÿæ¸…ç†ä»»åŠ¡çŠ¶æ€
function delayedCleanup() {
    if (currentTaskId) {
        setTimeout(function() {
            // å»¶è¿Ÿ5ç§’åæ¸…ç†ä»»åŠ¡çŠ¶æ€ï¼Œç»™å‰ç«¯è¶³å¤Ÿæ—¶é—´è·å–æœ€ç»ˆçŠ¶æ€
            console.log('å»¶è¿Ÿæ¸…ç†ä»»åŠ¡çŠ¶æ€:', currentTaskId);
            
            // è°ƒç”¨æ¸…ç†API
            $.ajax({
                url: '/api/background_collection/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'cleanup',
                    task_id: currentTaskId
                }),
                success: function(response) {
                    if (response.success) {
                        console.log('ä»»åŠ¡æ¸…ç†æˆåŠŸ:', currentTaskId);
                    } else {
                        console.warn('ä»»åŠ¡æ¸…ç†å¤±è´¥:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('æ¸…ç†ä»»åŠ¡APIè°ƒç”¨å¤±è´¥:', error);
                }
            });
        }, 5000);
    }
}



// æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
function updateTaskStatus(status) {
    $("#startTime").text(status.start_time || '-');
    $("#lastSuccess").text(status.last_success || '-');
    $("#errorCount").text(status.error_count || 0);
    
    // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œæ ·å¼
    let statusText = '';
    let statusClass = '';
    switch(status.status) {
        case 'starting':
            statusText = 'æ­£åœ¨å¯åŠ¨';
            statusClass = 'starting';
            break;
        case 'running':
            statusText = 'è¿è¡Œä¸­';
            statusClass = 'running';
            break;
        case 'error':
            statusText = 'å‡ºé”™';
            statusClass = 'error';
            break;
        case 'stopping':
            statusText = 'æ­£åœ¨åœæ­¢';
            statusClass = 'stopping';
            break;
        default:
            statusText = status.status || 'æœªçŸ¥';
            statusClass = 'unknown';
    }
    
    $("#statusText").text(statusText);
    $("#taskStatus")
        .removeClass('starting running error stopping unknown')
        .addClass(statusClass);
    
    // å¦‚æœä»»åŠ¡å‡ºé”™æ¬¡æ•°è¿‡å¤šï¼Œæ˜¾ç¤ºè­¦å‘Š
    if (status.error_count > 0) {
        showError(`é‡‡é›†ä»»åŠ¡å‡ºç°${status.error_count}æ¬¡é”™è¯¯ï¼Œç³»ç»Ÿæ­£åœ¨è‡ªåŠ¨é‡è¯•`);
    }
    
    // ä¿å­˜ä»»åŠ¡çŠ¶æ€
    saveTaskState();
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    $("#errorMessage").text(message);
    $("#errorAlert").removeClass("alert-warning").addClass("alert-danger").show();
    console.error('é”™è¯¯:', message);
    
    // 8ç§’åè‡ªåŠ¨éšè—
    setTimeout(function() {
        $("#errorAlert").fadeOut();
    }, 8000);
}

// æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
function showWarning(message) {
    $("#errorMessage").text(message);
    $("#errorAlert").removeClass("alert-danger").addClass("alert-warning").show();
    console.warn('è­¦å‘Š:', message);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(function() {
        $("#errorAlert").fadeOut();
    }, 5000);
}

// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebug(message) {
    $("#debugMessage").text(message);
    $("#debugInfo").fadeIn();
    
    // 10ç§’åè‡ªåŠ¨éšè—
    setTimeout(function() {
        $("#debugInfo").fadeOut();
    }, 10000);
    
    console.log('è°ƒè¯•:', message);
}

function paddingIpSelectTag(data) {
    console.log('å¡«å……IPé€‰æ‹©æ•°æ®:', data);
    showDebug('æ­£åœ¨åŠ è½½æœåŠ¡å™¨åˆ—è¡¨...');
    
    var selectTag = $("#ipSelect");
    selectTag.empty();
    var ipData = [];
    var remarkData = [];
    
    // æ£€æŸ¥æ•°æ®æ ¼å¼ - å¤„ç†get_ipadress APIè¿”å›çš„{remark: ip}æ ¼å¼
    if (typeof data === 'object' && data !== null) {
        // å¦‚æœæ˜¯get_ipadress APIè¿”å›çš„æ ¼å¼ {remark: ip}
        if (Object.keys(data).length > 0 && typeof Object.values(data)[0] === 'string') {
            for (var remark in data) {
                if (data.hasOwnProperty(remark)) {
                    remarkData.push(remark);
                    ipData.push(data[remark]);
                }
            }
        }
        // å¦‚æœæ˜¯å…¶ä»–APIè¿”å›çš„æ•°ç»„æ ¼å¼
        else if (Array.isArray(data)) {
            data.forEach(function(item) {
                if (item.ip && item.remarks) {
                    remarkData.push(item.remarks);
                    ipData.push(item.ip);
                }
            });
        }
        // å¦‚æœæ˜¯{all_data: [...]}æ ¼å¼
        else if (data.all_data && Array.isArray(data.all_data)) {
            data.all_data.forEach(function(item) {
                var displayText = item.remarks && item.remarks.trim() !== "" ? item.remarks : item.ip;
                remarkData.push(displayText);
                ipData.push(item.ip);
            });
        }
    }
    
    console.log('å¤„ç†åçš„æ•°æ®:', { remarkData: remarkData, ipData: ipData });
    showDebug(`æ‰¾åˆ° ${remarkData.length} å°æœåŠ¡å™¨`);
    
    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    if (remarkData.length > 0) {
        $(".ip-selected").text(remarkData[0]);
        $(".ip-selected").attr("data-ip", ipData[0]);
        console.log('é»˜è®¤é€‰ä¸­:', remarkData[0], 'IP:', ipData[0]);
        showDebug(`é»˜è®¤é€‰ä¸­: ${remarkData[0]} (${ipData[0]})`);
        
        // è‡ªåŠ¨åŠ è½½ç«¯å£
        requestTwoModel("cpu", "get_port", JSON.stringify({ "ip": ipData[0] }), function (portData) {
            console.log('ç«¯å£æ•°æ®:', portData);
            paddingPortSelectTag(portData);
        }, function(error) {
            console.error('è·å–ç«¯å£å¤±è´¥:', error);
            showError('è·å–ç«¯å£åˆ—è¡¨å¤±è´¥');
        });
    } else {
        console.warn('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„IPæ•°æ®');
        $(".ip-selected").text("æš‚æ— å¯ç”¨æœåŠ¡å™¨");
        showError('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®');
    }
    
    for (var i = 0; i < remarkData.length; i++) {
        var optionTag = $("<div>").attr("class", "ip");
        optionTag.text(remarkData[i]);
        optionTag.attr("data-ip", ipData[i]);
        selectTag.append(optionTag);
    }
    
    // ç¡®ä¿ä¸‹æ‹‰æ¡†æ­£ç¡®æ˜¾ç¤º
    if (remarkData.length > 0) {
        selectTag.show();
    } else {
        selectTag.hide();
    }
}

function paddingPortSelectTag(data) {
    console.log('å¡«å……ç«¯å£é€‰æ‹©æ•°æ®:', data);
    var selectTag = $("#portSelect");
    selectTag.empty();
    
    if (data && data.port && Array.isArray(data.port)) {
        var portData = data.port;
        if (portData.length > 0) {
            $(".port-selected").text(portData[0]);
            $(".port-selected").attr("data-port", portData[0]);
            console.log('é»˜è®¤é€‰ä¸­ç«¯å£:', portData[0]);
        }
        
        for (var i = 0; i < portData.length; i++) {
            var optionTag = $("<div>").attr("class", "port");
            optionTag.text(portData[i]);
            optionTag.attr("data-port", portData[i]);
            selectTag.append(optionTag);
        }
        
        // ç¡®ä¿ä¸‹æ‹‰æ¡†æ­£ç¡®æ˜¾ç¤º
        selectTag.show();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨æ•°æ®è½®è¯¢ï¼ˆå¦‚æœä»»åŠ¡çŠ¶æ€æ¢å¤æˆåŠŸï¼‰
        if (isCollecting && currentTaskId && !dataTimer) {
            console.log('IPå’Œç«¯å£è®¾ç½®å®Œæˆï¼Œå¯åŠ¨æ•°æ®è½®è¯¢');
            startDataPolling();
        }
    } else {
        console.warn('ç«¯å£æ•°æ®æ ¼å¼é”™è¯¯:', data);
        $(".port-selected").text("æš‚æ— å¯ç”¨ç«¯å£");
        selectTag.hide();
    }
}

// ä¿å­˜ä»»åŠ¡çŠ¶æ€åˆ°localStorage
function saveTaskState() {
    if (currentTaskId) {
        // è·å–å½“å‰é˜ˆå€¼è®¾ç½®
        const cpuThreshold = $("#cpuRange").val();
        const memThreshold = $("#memRange").val();
        const diskThreshold = $("#diskRange").val();
        const netThreshold = $("#netRange").val();
        
        // ä¿å­˜é˜ˆå€¼è®¾ç½®åˆ°localStorage
        localStorage.setItem('cpuThreshold', cpuThreshold);
        localStorage.setItem('memThreshold', memThreshold);
        localStorage.setItem('diskThreshold', diskThreshold);
        localStorage.setItem('netThreshold', netThreshold);
        
        console.log('ä¿å­˜é˜ˆå€¼è®¾ç½®:', {
            cpu: cpuThreshold,
            memory: memThreshold,
            disk: diskThreshold,
            network: netThreshold
        });
        
        let taskState = {
            taskId: currentTaskId,
            ip: $(".ip-selected").attr("data-ip") || $(".ip-selected").text(),
            port: $(".port-selected").attr("data-port") || $(".port-selected").text(),
            interval: $("#pollInterval").val(),
            isCollecting: isCollecting,
            // ä¿å­˜é˜ˆå€¼è®¾ç½®
            thresholds: {
                cpu: cpuThreshold,
                mem: memThreshold,
                disk: diskThreshold,
                net: netThreshold
            }
        };
        localStorage.setItem('collectionTaskState', JSON.stringify(taskState));
    } else {
        localStorage.removeItem('collectionTaskState');
    }
}

// ä»localStorageæ¢å¤ä»»åŠ¡çŠ¶æ€
function restoreTaskState() {
    const state = JSON.parse(localStorage.getItem('collectionTaskState') || '{}');
    
    if (state.isCollecting && state.taskId) {
        console.log('å‘ç°ä¿å­˜çš„ä»»åŠ¡çŠ¶æ€:', state);
        
        // å…ˆæ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ
        $.ajax({
            url: '/api/background_collection/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: 'status',
                task_id: state.taskId
            }),
            success: function(response) {
                if (response.success && response.status && response.status.running) {
                    // æ¢å¤UIçŠ¶æ€
                    currentTaskId = state.taskId;
                    isCollecting = true;
                    
                    // è®¾ç½®IPå’Œç«¯å£
                    $(".ip-selected").text(state.ip).attr("data-ip", state.ip);
                    $(".port-selected").text(state.port).attr("data-port", state.port);
                    
                    // è®¾ç½®é‡‡é›†é—´éš”
                    $("#pollInterval").val(state.interval);
                    
                    // æ›´æ–°UIçŠ¶æ€
                    $("#startBtn").prop("disabled", true);
                    $("#overBtn").prop("disabled", false);
                    $("#taskStatus").show().removeClass('stopped').addClass('running');
                    $("#statusText").text("è¿è¡Œä¸­");
                    
                    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œå¯åŠ¨æ•°æ®è½®è¯¢ï¼Œç­‰å¾…IPå’Œç«¯å£è®¾ç½®å®Œæˆåå†å¯åŠ¨
                    // startDataPolling();
                    
                    console.log('ä»»åŠ¡çŠ¶æ€æ¢å¤æˆåŠŸï¼Œç­‰å¾…IPå’Œç«¯å£è®¾ç½®å®Œæˆåå¯åŠ¨è½®è¯¢');
                } else {
                    console.warn('åç«¯ä»»åŠ¡æœªè¿è¡Œï¼Œæ¸…é™¤çŠ¶æ€');
                    localStorage.removeItem('collectionTaskState');
                    isCollecting = false;
                    currentTaskId = null;
                    
                    // æ›´æ–°UIçŠ¶æ€
                    $("#startBtn").prop("disabled", false);
                    $("#overBtn").prop("disabled", true);
                    $("#taskStatus").removeClass('running').addClass('stopped');
                    $("#statusText").text("å·²åœæ­¢");
                }
            },
            error: function(xhr, status, error) {
                console.error('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œæ¸…é™¤çŠ¶æ€é¿å…é—®é¢˜
                localStorage.removeItem('collectionTaskState');
                isCollecting = false;
                currentTaskId = null;
                
                // æ›´æ–°UIçŠ¶æ€
                $("#startBtn").prop("disabled", false);
                $("#overBtn").prop("disabled", true);
                $("#taskStatus").removeClass('running').addClass('stopped');
                $("#statusText").text("å·²åœæ­¢");
            }
        });
    } else {
        console.log('æ²¡æœ‰ä¿å­˜çš„ä»»åŠ¡çŠ¶æ€æˆ–çŠ¶æ€æ— æ•ˆ');
    }
    
    // æ¢å¤é˜ˆå€¼è®¾ç½®
    if (state.thresholds) {
        $("#cpuRange").val(state.thresholds.cpu || '');
        $("#memRange").val(state.thresholds.mem || '');
        $("#diskRange").val(state.thresholds.disk || '');
        $("#netRange").val(state.thresholds.net || '');
    }
}

// ä¿®æ”¹startBackgroundCollectionå‡½æ•°
function startBackgroundCollection() {
    if (isCollecting) return;
    
    let ip = $(".ip-selected").attr("data-ip") || $(".ip-selected").text();
    let port = $(".port-selected").attr("data-port") || $(".port-selected").text();
    let interval = parseInt($("#pollInterval").val()) || 30;
    
    if (!ip || ip === "é€‰æ‹©IP" || !port || port === "é€‰æ‹©ç«¯å£") {
        alert("è¯·å…ˆé€‰æ‹©IPå’Œç«¯å£");
        return;
    }
    
    // éªŒè¯é˜ˆå€¼è®¾ç½®
    const cpuThreshold = $("#cpuRange").val();
    const memThreshold = $("#memRange").val();
    const diskThreshold = $("#diskRange").val();
    const netThreshold = $("#netRange").val();
    
    // æç¤ºç”¨æˆ·è®¾ç½®é˜ˆå€¼
    if (!cpuThreshold && !memThreshold && !diskThreshold && !netThreshold) {
        if (!confirm("æ‚¨å°šæœªè®¾ç½®ä»»ä½•é˜ˆå€¼ï¼Œè¿™å°†å¯¼è‡´æ— æ³•æ”¶åˆ°å‘Šè­¦é€šçŸ¥ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")) {
            return;
        }
    }
    
    // å‘é€å¯åŠ¨åå°é‡‡é›†ä»»åŠ¡è¯·æ±‚
    $.ajax({
        url: '/api/background_collection/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'start',
            ip: ip,
            port: port,
            interval: interval
        }),
        success: function(response) {
            if (response.success) {
                currentTaskId = response.task_id;
                isCollecting = true;
                
                // è®¾ç½®é‡‡é›†çŠ¶æ€æ ‡è®°ï¼Œç¡®ä¿å…¨å±€ç›‘æ§èƒ½å¤Ÿæ­£ç¡®å·¥ä½œ
                localStorage.setItem('isCollecting', 'true');
                
                // æ›´æ–°UIçŠ¶æ€
                $("#startBtn").prop("disabled", true);
                $("#overBtn").prop("disabled", false);
                
                // æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€å’Œé—´éš”ä¿¡æ¯
                $("#taskStatus").show().removeClass('stopped').addClass('running');
                $("#statusText").text("è¿è¡Œä¸­");
                $("#taskId").text(currentTaskId);
                
                // å¼€å§‹å®šæ—¶è·å–æ•°æ®
                startDataPolling();
                
                // å¯åŠ¨å…¨å±€ç›‘æ§
                if (window.monitorManager) {
                    window.monitorManager.startChecking();
                    console.log('å·²å¯åŠ¨å…¨å±€ç›‘æ§');
                }
                
                // ä¿å­˜ä»»åŠ¡çŠ¶æ€å’Œé˜ˆå€¼è®¾ç½®
                saveTaskState();
                
                alert("åå°é‡‡é›†ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼");
            } else {
                alert("å¯åŠ¨å¤±è´¥ï¼š" + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert("å¯åŠ¨å¤±è´¥ï¼š" + error);
        }
    });
}

// æ£€æŸ¥é˜ˆå€¼å¹¶è§¦å‘è­¦æŠ¥
function checkAndTriggerAlerts(data) {
    // å¦‚æœé‡‡é›†å·²åœæ­¢ï¼Œä¸æ£€æŸ¥é˜ˆå€¼
    if (!isCollecting) {
        console.log('é‡‡é›†å·²åœæ­¢ï¼Œä¸æ£€æŸ¥é˜ˆå€¼');
        return;
    }
    
    // è·å–é˜ˆå€¼è®¾ç½®
    const cpuThreshold = parseFloat($("#cpuRange").val()) || 0;
    const memThreshold = parseFloat($("#memRange").val()) || 0;
    const diskThreshold = parseFloat($("#diskRange").val()) || 0;
    const netThreshold = parseFloat($("#netRange").val()) || 0;
    
    // ä¿å­˜å½“å‰é˜ˆå€¼åˆ°localStorageï¼Œç¡®ä¿å…¨å±€ç›‘æ§èƒ½å¤Ÿä½¿ç”¨
    localStorage.setItem('cpuThreshold', cpuThreshold);
    localStorage.setItem('memThreshold', memThreshold);
    localStorage.setItem('diskThreshold', diskThreshold);
    localStorage.setItem('netThreshold', netThreshold);
    
    console.log('æ£€æŸ¥é˜ˆå€¼:', {
        cpu: `${data.cpu?.cpu_percent || 0}% / ${cpuThreshold}%`,
        memory: `${data.memory?.mem_percent || 0}% / ${memThreshold}%`,
        disk: `${data.disk?.disk_percent || 0}% / ${diskThreshold}%`,
        network: `${data.network?.net_speed || 0}Mbps / ${netThreshold}Mbps`
    });
    
    // æ£€æŸ¥monitorManageræ˜¯å¦å¯ç”¨
    console.log('monitorManagerçŠ¶æ€:', {
        exists: typeof window.monitorManager !== 'undefined',
        manager: window.monitorManager
    });
    
    // æ£€æŸ¥CPUé˜ˆå€¼
    if (cpuThreshold > 0 && data.cpu && data.cpu.cpu_percent > cpuThreshold) {
        console.log(`CPUå‘Šè­¦: ${data.cpu.cpu_percent}% > ${cpuThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('æ·»åŠ CPUå‘Šè­¦åˆ°monitorManager');
            window.monitorManager.addAlert(
                'CPUå‘Šè­¦',
                'CPUä½¿ç”¨ç‡è¶…è¿‡è®¾å®šé˜ˆå€¼',
                `${data.cpu.cpu_percent}%`,
                `é˜ˆå€¼: ${cpuThreshold}%`
            );
        } else {
            console.error('monitorManagerä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ å‘Šè­¦');
        }
    }
    
    // æ£€æŸ¥å†…å­˜é˜ˆå€¼
    if (memThreshold > 0 && data.memory && data.memory.mem_percent > memThreshold) {
        console.log(`å†…å­˜å‘Šè­¦: ${data.memory.mem_percent}% > ${memThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('æ·»åŠ å†…å­˜å‘Šè­¦åˆ°monitorManager');
            window.monitorManager.addAlert(
                'å†…å­˜å‘Šè­¦',
                'å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡è®¾å®šé˜ˆå€¼',
                `${data.memory.mem_percent}%`,
                `é˜ˆå€¼: ${memThreshold}%`
            );
        } else {
            console.error('monitorManagerä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ å‘Šè­¦');
        }
    }
    
    // æ£€æŸ¥ç£ç›˜é˜ˆå€¼
    if (diskThreshold > 0 && data.disk && data.disk.disk_percent > diskThreshold) {
        console.log(`ç£ç›˜å‘Šè­¦: ${data.disk.disk_percent}% > ${diskThreshold}%`);
        playAlertSound();
        if (window.monitorManager) {
            console.log('æ·»åŠ ç£ç›˜å‘Šè­¦åˆ°monitorManager');
            window.monitorManager.addAlert(
                'ç£ç›˜å‘Šè­¦',
                'ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡è®¾å®šé˜ˆå€¼',
                `${data.disk.disk_percent}%`,
                `é˜ˆå€¼: ${diskThreshold}%`