{% extends "layout.html" %}
{%load static%}

{%block css%}
<style>
    /* 强制重置所有样式，确保页面显示正常 */
    * {
      font-size: 14px !important;
      line-height: 1.5 !important;
    }
    
    /* 统一页面样式，确保与其他页面保持一致 */
    .contentBox {
        position: relative;
        height: 65vh;
        overflow: auto;
    }

    .selectPage {
        height: 10px;

    }

    .btn {
        padding: 2px 6px;
    }



    /* <reset-style> ============================ */
    .button {
        border: none;
        float: right;
        background: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
        font-family: inherit;
        border-radius: 10px;
        margin: 0 10px;
    }

    /* <main-style> ============================ */
    .menu__button {
        min-width: 62px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px 16px;
        background-color: #fff;
        transition: background-color .4s;
    }

    /* .menu__button span {
        color: #000;
        line-height: 1;
        transition: color .4s;
    }

    .menu__button:hover {
        background: linear-gradient(90deg, #fff 50%, transparent 0) repeat-x,
            linear-gradient(90deg, #fff 50%, transparent 0) repeat-x,
            linear-gradient(0deg, #fff 50%, transparent 0) repeat-y,
            linear-gradient(0deg, #fff 50%, transparent 0) repeat-y;
        background-size: 6px 2px, 6px 2px, 2px 6px, 2px 6px;
        background-position: 0 0, 0 100%, 0 0, 100% 0;
        animation: linearGradientMove .4s infinite linear;
    } */

    .menu__button:hover span {
        color: #fff;
    }

    @keyframes linearGradientMove {
        100% {
            background-position: 6px 0, -6px 100%, 0 -6px, 100% 6px;
        }
    }

    input {
        height: 20px;
        border: 0;
        text-indent: 1em;
        margin-right: 10px;
        border-radius: 10px;
    }

/* 新增样式 - 按照用户管理风格 */
/* 确保页面标题样式正确 */
.breadcrumb-nav {
    font-size: 14px !important;
}

.breadcrumb-item {
    font-size: 14px !important;
}

/* 确保页面整体样式统一 - 使用更高优先级 */
.content-area {
    font-size: 14px !important;
}

.content-area * {
    font-size: inherit !important;
}

/* 强制覆盖所有可能的字体大小设置 */
.content-area h1,
.content-area h2,
.content-area h3,
.content-area h4,
.content-area h5,
.content-area h6,
.content-area p,
.content-area span,
.content-area div,
.content-area label {
    font-size: 14px !important;
}

/* 特别处理可能被其他样式影响的元素 */
.content-area .tooltitle,
.content-area .title {
    font-size: 14px !important;
}

/* 覆盖Bootstrap可能的样式影响 */
.table th,
.table td {
    font-size: 14px !important;
    padding: 8px 12px !important;
}

.btn {
    font-size: 14px !important;
    padding: 6px 12px !important;
    height: auto !important;
}

.form-control {
    font-size: 14px !important;
    height: 32px !important;
    padding: 4px 8px !important;
}

/* 确保所有文本元素都使用正确的字体大小 */
h1, h2, h3, h4, h5, h6, p, span, div, label, input, textarea, select {
    font-size: 14px !important;
}

/* 确保按钮样式统一 */
.btn {
    font-size: 14px !important;
    padding: 6px 12px !important;
    height: auto !important;
}

/* 确保表单控件样式统一 */
.form-control {
    font-size: 14px !important;
    height: 32px !important;
    padding: 4px 8px !important;
}

/* 确保标签样式统一 */
label {
    font-size: 14px !important;
    color: #333 !important;
}

/* 确保页面内容区域样式统一 */
.content-area {
    font-size: 14px !important;
    line-height: 1.5 !important;
}

.search-section {
    background: white;
    padding: 20px;
    margin-bottom: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.search-left {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.search-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-item label {
    font-size: 14px;
    color: #333;
    white-space: nowrap;
    margin: 0;
}

.search-item .form-control {
    width: 200px;
    height: 32px;
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
}

.action-section {
    background: white;
    padding: 16px 20px;
    margin-bottom: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.action-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.dropdown-container {
    position: relative;
    display: inline-block;
}

.info-bar {
    background: #f0f9ff;
    border: 1px solid #bae7ff;
    padding: 12px 20px;
    margin-bottom: 16px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.info-left {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1890ff;
    font-size: 14px;
}

.info-right {
    color: #999;
    font-size: 14px;
}

.table-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 16px;
}

.server-table {
    margin: 0;
    border: none;
    table-layout: fixed;
    width: 100%;
}

.server-table th {
    background: #fafafa;
    color: #000;
    font-weight: 500;
    padding: 12px 16px;
    border-bottom: 1px solid #e8e8e8;
    font-size: 14px;
    text-align: center !important;
    vertical-align: middle !important;
}

.server-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    color: #000;
    font-size: 14px;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 特定列的对齐方式 */
.server-table td:nth-child(2), /* IP地址 */
.server-table th:nth-child(2) {
    text-align: left !important;
}

.server-table td:nth-child(4), /* 备注 */
.server-table th:nth-child(4) {
    text-align: left !important;
    white-space: normal;
    word-wrap: break-word;
}

.server-table td:nth-child(6), /* 创建时间 */
.server-table th:nth-child(6) {
    text-align: center !important;
}

/* 状态指示器样式优化 */
.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-online {
    background-color: #f6ffed;
    color: #52c41a;
    border: 1px solid #b7eb8f;
}

.status-offline {
    background-color: #fff2f0;
    color: #ff4d4f;
    border: 1px solid #ffccc7;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: currentColor;
}

/* 表格行间距优化 */
.server-table tbody tr {
    transition: background-color 0.2s ease;
}

.server-table tbody tr:nth-child(even) {
    background-color: #fafafa;
}

.server-table tbody tr:hover {
    background-color: #e6f7ff !important;
}

.server-table tr:hover {
    background: #f8f9fa;
}

.table-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    margin: 0 auto;
    display: block;
}

.action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
    flex-wrap: nowrap;
}

.action-buttons .btn {
    padding: 4px 8px;
    font-size: 12px;
    min-width: 50px;
}

/* 弹窗样式 */
.modal {
    display: none !important;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.show {
    display: block !important;
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: 10px;
    max-width: 500px;
    margin: 30px auto;
}

.modal-content {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    outline: 0;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #e8e8e8;
}

.modal-title {
    margin: 0;
    font-size: 18px;
    font-weight: 500;
    color: #333;
}

.modal-header .close {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-header .close:hover {
    color: #333;
}

.modal-body {
    padding: 24px;
    flex: 1 1 auto;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 16px 24px;
    border-top: 1px solid #e8e8e8;
    gap: 12px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    color: #333;
    font-size: 14px;
    font-weight: 500;
}

.required {
    color: #ff4d4f;
}

.form-group .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    color: #333;
    background: #fff;
    transition: border-color 0.3s ease;
}

.form-group .form-control:focus {
    border-color: #1890ff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

.btn-default {
    background: #fff;
    border: 1px solid #d9d9d9;
    color: #333;
}

.btn-default:hover {
    border-color: #1890ff;
    color: #1890ff;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #000 !important;
    white-space: nowrap;
    flex-wrap: nowrap;
    justify-content: center;
    cursor: pointer;
    line-height: 1;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    order: -1;
    margin-right: 6px;
    margin-left: 0;
    align-self: center;
    vertical-align: middle;
}

.status-online .status-dot {
    background: #52c41a;
}

.status-offline .status-dot {
    background: #ff4d4f;
}

/* 分页样式 */
.pagination-container {
    background: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.pagination-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
}

.pagination-total {
    color: #666;
    font-size: 14px;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pagination-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #d9d9d9;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
    border-color: #1890ff;
    color: #1890ff;
}

.pagination-btn:disabled {
    color: #ccc;
    cursor: not-allowed;
    border-color: #f0f0f0;
}

.page-numbers {
    display: flex;
    gap: 4px;
}

.page-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #d9d9d9;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s ease;
}

.page-btn:hover {
    border-color: #1890ff;
    color: #1890ff;
}

.page-btn.active {
    background: #1890ff;
    border-color: #1890ff;
    color: white;
}

.page-size-select {
    height: 32px;
    padding: 4px 8px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    color: #666;
    background: white;
    cursor: pointer;
    min-width: 80px;
}

.page-size-select:focus {
    border-color: #1890ff;
    outline: none;
}

.goto-text {
    color: #666;
    font-size: 14px;
}

.goto-input {
    width: 50px;
    height: 32px;
    padding: 4px 8px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
    color: #666;
}

.goto-input:focus {
    border-color: #1890ff;
    outline: none;
}

</style>
{%endblock%}

{%block content%}
<!-- 搜索区域 -->
<div class="search-section">
    <div class="search-left">
        <div class="search-item">
            <label>IP地址</label>
            <input id="ipadress" type="text" placeholder="请输入IP地址" class="form-control">
        </div>
        <div class="search-item">
            <label>服务类型</label>
            <input id="serviceTypeSearch" type="text" placeholder="请输入服务类型" class="form-control">
        </div>
        <button id="selectOneModel" class="btn btn-primary">
            <i class="el-icon-search"></i> 查询
        </button>
        <button id="resetSearch" class="btn btn-default">
            重置
        </button>
    </div>
</div>

<!-- 操作按钮区域 -->
<div class="action-section">
    <div class="action-left">
        <button id="createBtn" class="btn btn-primary">
            <i class="el-icon-plus"></i> 新增服务器
        </button>
        <button id="batchDeleteBtn" class="btn btn-danger" disabled>
            <i class="el-icon-delete"></i> 批量删除
        </button>
        <div class="dropdown-container">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                更多操作 <i class="el-icon-arrow-down"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#" id="exportSelected"><i class="el-icon-download"></i> 导出所选数据</a></li>
                <li><a href="#" id="exportAll"><i class="el-icon-download"></i> 导出全部数据</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- 提示栏 -->
<div class="info-bar">
    <div class="info-left">
        <i class="el-icon-info"></i>
        <span id="selectionInfo">已选择 0 项</span>
        <a href="#" id="clearSelection" style="display: none;">是否全部清空</a>
    </div>
    <div class="info-right">
        <span>当前选择的服务器将进行批量操作</span>
    </div>
</div>

<!-- 服务器弹窗 -->
<div class="modal fade" id="serverModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">新增服务器</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="serverForm">
                    <div class="form-group">
                        <label for="modalIp">IP地址 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="modalIp" placeholder="请输入IP地址" required>
                    </div>
                    <div class="form-group">
                        <label for="modalPort">端口 <span class="required">*</span></label>
                        <input type="number" class="form-control" id="modalPort" placeholder="请输入端口" required>
                    </div>
                    <div class="form-group">
                        <label for="modalServiceType">服务类型 <span class="required">*</span></label>
                        <select class="form-control" id="modalServiceType" required>
                            <option value="">请选择服务类型</option>
                            <!-- Web服务器 -->
                            <option value="Nginx">Nginx</option>
                            <option value="Apache">Apache</option>
                            <option value="IIS">IIS</option>
                            <option value="Lighttpd">Lighttpd</option>
                            <!-- 应用服务器 -->
                            <option value="Tomcat">Tomcat</option>
                            <option value="Jetty">Jetty</option>
                            <option value="WebLogic">WebLogic</option>
                            <option value="WebSphere">WebSphere</option>
                            <option value="JBoss">JBoss</option>
                            <option value="Undertow">Undertow</option>
                            <!-- 数据库 -->
                            <option value="MySQL">MySQL</option>
                            <option value="PostgreSQL">PostgreSQL</option>
                            <option value="Oracle">Oracle</option>
                            <option value="SQL Server">SQL Server</option>
                            <option value="MongoDB">MongoDB</option>
                            <option value="达梦数据库">达梦数据库</option>
                            <option value="人大金仓">人大金仓</option>
                            <option value="南大通用">南大通用</option>
                            <!-- 缓存服务 -->
                            <option value="Redis">Redis</option>
                            <option value="Memcached">Memcached</option>
                            <option value="Hazelcast">Hazelcast</option>
                            <!-- 消息队列 -->
                            <option value="RabbitMQ">RabbitMQ</option>
                            <option value="Kafka">Kafka</option>
                            <option value="ActiveMQ">ActiveMQ</option>
                            <option value="RocketMQ">RocketMQ</option>
                            <option value="Pulsar">Pulsar</option>
                            <!-- 搜索引擎 -->
                            <option value="Elasticsearch">Elasticsearch</option>
                            <option value="Solr">Solr</option>
                            <!-- 系统服务 -->
                            <option value="SSH">SSH</option>
                            <option value="FTP">FTP</option>
                            <option value="SFTP">SFTP</option>
                            <option value="Telnet">Telnet</option>
                            <option value="SNMP">SNMP</option>
                            <option value="DNS">DNS</option>
                            <option value="DHCP">DHCP</option>
                            <option value="NTP">NTP</option>
                            <!-- 监控服务 -->
                            <option value="监控代理">监控代理</option>
                            <option value="Prometheus">Prometheus</option>
                            <option value="Grafana">Grafana</option>
                            <option value="Zabbix">Zabbix</option>
                            <option value="Nagios">Nagios</option>
                            <!-- 容器服务 -->
                            <option value="Docker">Docker</option>
                            <option value="Kubernetes">Kubernetes</option>
                            <option value="Containerd">Containerd</option>
                            <!-- 负载均衡 -->
                            <option value="HAProxy">HAProxy</option>
                            <option value="LVS">LVS</option>
                            <option value="F5">F5</option>
                            <!-- 文件服务 -->
                            <option value="Samba">Samba</option>
                            <option value="NFS">NFS</option>
                            <option value="MinIO">MinIO</option>
                            <!-- 其他服务 -->
                            <option value="Jenkins">Jenkins</option>
                            <option value="GitLab">GitLab</option>
                            <option value="Nexus">Nexus</option>
                            <option value="SonarQube">SonarQube</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalRemarks">备注</label>
                        <input type="text" class="form-control" id="modalRemarks" placeholder="请输入备注">
                    </div>
                    <div class="form-group">
                        <label for="modalStatus">状态</label>
                        <select class="form-control" id="modalStatus">
                            <option value="在线">在线</option>
                            <option value="离线">离线</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveServerBtn">保存</button>
            </div>
        </div>
    </div>
</div>
    <!-- 表格区域 -->
    <div class="table-container">
        <table class="table table-bordered server-table">
            <thead>
                <tr>
                    <th width="50">
                        <input type="checkbox" id="selectAll" class="table-checkbox">
                    </th>
                    <th width="120">IP地址</th>
                    <th width="80">端口</th>
                    <th width="120">服务类型</th>
                    <th width="80">状态</th>
                    <th width="200">备注</th>
                    <th width="160">创建时间</th>
                    <th width="140">操作</th>
                </tr>
            </thead>
            <tbody id="tbodyContent">
                <!-- 动态加载 -->
            </tbody>
        </table>
    </div>

    <!-- 分页区域 -->
    <div class="pagination-container">
        <div class="pagination-wrapper">
            <span class="pagination-total">共 <span id="totalCount">5</span> 条</span>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevPage" disabled>&lt;</button>
                <span class="page-numbers" id="pageNumbers">
                    <button class="page-btn active">1</button>
                </span>
                <button class="pagination-btn" id="nextPage">&gt;</button>
                <select class="page-size-select" id="pageSizeSelect">
                    <option value="10">10 条/页</option>
                    <option value="20">20 条/页</option>
                    <option value="50">50 条/页</option>
                </select>
                <span class="goto-text">跳至</span>
                <input type="number" class="goto-input" id="gotoPage" min="1" value="1">
                <span class="goto-text">页</span>
            </div>
        </div>
    </div>
</div>


{%endblock%}

{%block js%}
<script>
    // 强制设置页面样式
    function forcePageStyles() {
        // 强制设置所有元素的字体大小
        $('*').css('font-size', '14px');
        $('*').css('line-height', '1.5');
        
        // 特别处理可能被其他样式影响的元素
        $('h1, h2, h3, h4, h5, h6').css('font-size', '14px');
        $('.btn').css('font-size', '14px');
        $('.form-control').css('font-size', '14px');
        $('label').css('font-size', '14px');
        $('input, textarea, select').css('font-size', '14px');
        
        console.log('强制设置页面样式完成');
    }
    
    // 初始化
    function initialaze() {
        requestOneModel("JianKongFuWuQi", "select", "{}", "1-50")
    }

    // 重写requestOneModel的回调处理，确保数据正确渲染
    window.originalRequestOneModel = window.requestOneModel;
    window.requestOneModel = function(name, type, values, numberRange) {
        // 调用原始函数
        if (window.originalRequestOneModel) {
            return window.originalRequestOneModel(name, type, values, numberRange);
        }

        // 如果原始函数不存在，使用模拟数据
        if (name === "JianKongFuWuQi" && type === "select") {
            setTimeout(function() {
                renderServerTable();
            }, 100);
        }
    }

    $(document).ready(function () {
        // 强制设置页面样式
        forcePageStyles();
        
        // 延迟再次设置样式，确保覆盖所有动态加载的内容
        setTimeout(function() {
            forcePageStyles();
        }, 100);
        
        // 定义全局变量（避免undefined错误）
        window.reviseTag = $("#saveServerBtn"); // 使用保存按钮作为修改按钮
        window.submitTag = $("#saveServerBtn");  // 使用保存按钮作为提交按钮
        window.creatDataTag = $("#serverModal"); // 使用模态框

        var name = "JianKongFuWuQi";
        var type = "";
        var values = "";
        var oldData = "";
        var newData = "";

        // 初始化数据
        renderServerTable();

        // 新增服务器按钮
        $("#createBtn").on("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Create button clicked");
            openServerModal('create');
        });

        // 编辑服务器按钮
        $(document).on("click", ".revise", function (e) {
            e.preventDefault();
            console.log("Edit button clicked");

            var row = $(this).closest("tr");
            var ip = row.find("td:nth-child(2)").text();
            var port = row.find("td:nth-child(3)").text();
            var serviceType = row.find("td:nth-child(4)").text();
            var status = row.find("td:nth-child(5)").text().trim();
            var remarks = row.find("td:nth-child(6)").text();

            console.log("Edit data:", {ip, port, serviceType, status, remarks});

            openServerModal('edit', {
                ip: ip,
                port: port,
                serviceType: serviceType,
                status: status,
                remarks: remarks
            });
        });

        // 保存服务器按钮
        $("#saveServerBtn").on("click", function() {
            saveServer();
        });

        // 弹窗关闭事件
        $(document).on("click", ".close, [data-dismiss='modal']", function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Close button clicked");
            closeServerModal();
        });

        // 点击弹窗外部关闭
        $(document).on("click", "#serverModal", function(e) {
            if (e.target === this) {
                console.log("Clicked outside modal content");
                closeServerModal();
            }
        });

        // 阻止弹窗内容区域的点击事件冒泡
        $(document).on("click", ".modal-content", function(e) {
            e.stopPropagation();
        });

        // 状态切换功能
        $(document).on("click", ".toggle-status", function () {
            var row = $(this).closest("tr");
            var ip = row.data("ip");
            var isOnline = row.data("online");
            var action = isOnline ? "设为离线" : "设为在线";

            var confirmMessage = `确认要${action}服务器 "${ip}" 吗？`;

            if (confirm(confirmMessage)) {
                // 更新UI
                var newOnline = !isOnline;
                row.data("online", newOnline);

                var statusIndicator = $(this);

                if (newOnline) {
                    statusIndicator.removeClass("status-offline").addClass("status-online");
                    statusIndicator.html('<span class="status-dot"></span>在线');
                } else {
                    statusIndicator.removeClass("status-online").addClass("status-offline");
                    statusIndicator.html('<span class="status-dot"></span>离线');
                }

                console.log(`服务器 ${ip} 已${action}`);
            }
        });

        //初始化页面数据
        console.log("JianKongXinXiFuWuGuanLi.html loaded - using JianKongFuWuQi API");
        initialaze()

        // 注释掉旧的重复事件绑定，避免重复提交
        /*
        reviseTag.on("click", function () {
            var type = "update"
            newData = get_value();
            values = JSON.stringify({ "old": oldData, "new": newData })
            if (values) {
                requestOneModel(name, type, values)
                creatDataTag.css("display", "none")
            }
        })
        // 为按钮绑定提交点击事件
        submitTag.on("click", function () {
            // 获取输入框的值
            type = "create";
            values = get_value();
            if (values) {
                requestOneModel(name, type, values)
                creatDataTag.css("display", "none")
            }

        });

        //显示新增页面
        $("#createBtn").on("click", function () {
            submitTag.css("display", "block")
            reviseTag.css("display", "none")
            creatDataTag.css("display", "block")
        })
        */

        //绑定查询事件
        $("#selectOneModel").on("click", function () {
            type = "select";
            var value = $("#ipadress").val()
            if (value.trim() === "") {
                alert("请输入IP地址")
                return;
            }
            ipValue = JSON.stringify({
                "ip": $("#ipadress").val()
            })

            requestOneModel(name, type, ipValue)
        })

        //绑定选择页码
        $(".choose").on("click", function () {
            $("#dropdownLiTag").children().on("click", function () {
                type = "select";
                indexs = getNumber($(this).text())
                numberRange = indexs[0] + "-" + indexs[1]
                requestOneModel(name, type, "{}", numberRange)
            })
        })

        // 使用事件委托给删除按钮添加点击事件
        $(document).on("click", ".del", function () {
            // 获取包含删除按钮的行元素
            var row = $(this).closest("tr");
            // 获取相应的值
            var ip = row.find("td:nth-child(2)").text();
            var port = row.find("td:nth-child(3)").text();
            var serviceType = row.find("td:nth-child(4)").text();
            var remarks = row.find("td:nth-child(6)").text();

            // 构建确认消息
            var confirmMessage = "确认要删除以下服务器信息吗？\n\n";
            confirmMessage += "IP地址: " + ip + "\n";
            confirmMessage += "端口: " + port + "\n";
            confirmMessage += "服务类型: " + serviceType + "\n";
            if (remarks && remarks.trim() !== "") {
                confirmMessage += "备注: " + remarks + "\n";
            }
            confirmMessage += "\n删除后将无法恢复！";

            var bool = confirm(confirmMessage);
            if (bool) {
                var type = "del"
                var values = JSON.stringify({ "ip": ip, "port": port })
                requestOneModel(name, type, values)
            }
        });
        // 这个重复的编辑事件处理已被移除，使用上面的现代化版本

        $(document).on("click", "#closeImg", function () {
            submitTag.css("display", "none")
            creatDataTag.css("display", "none")
            creatDataTag.css("display", "none")
            set_value("", "", "")
        })




        // tool
        function set_value(ip, port, remark) {
            var ipValue = $("#ip").val(ip);
            var portValue = $("#port").val(port);
            var remarkValue = $("#remark").val(remark);
        }
        function get_value() {
            var ipValue = $("#ip").val();
            var portValue = $("#port").val();
            var remarkValue = $("#remark").val();
            if (
                ipValue === '' ||
                portValue === '' ||
                remarkValue === ''
            ) {
                // 弹窗提示有空输入框
                alert('请输入完整信息');
                return null;
            }
            // 创建一个对象并设置键值对
            var data = {
                ip: ipValue,
                port: portValue,
                remarks: remarkValue
            };

            // 将对象转换为 JSON 字符串并返回
            return JSON.stringify(data);
        }


    });

    // 打开服务器弹窗
    function openServerModal(mode, serverData) {
        console.log("Opening modal in mode:", mode);

        var modal = $("#serverModal");
        var title = $("#modalTitle");
        var saveBtn = $("#saveServerBtn");

        // 清空表单
        var form = $("#serverForm")[0];
        if (form) {
            form.reset();
        }

        if (mode === 'create') {
            title.text("新增服务器");
            saveBtn.text("保存").data("mode", "create");
            $("#modalIp").prop("readonly", false);
        } else if (mode === 'edit') {
            title.text("编辑服务器");
            saveBtn.text("更新").data("mode", "edit");
            $("#modalIp").prop("readonly", true);

            // 填充数据
            if (serverData) {
                $("#modalIp").val(serverData.ip);
                $("#modalPort").val(serverData.port);
                $("#modalServiceType").val(serverData.serviceType);
                $("#modalRemarks").val(serverData.remarks);
                $("#modalStatus").val(serverData.status.replace(/在线|离线/, function(match) {
                    return match === '在线' ? '在线' : '离线';
                }));

                // 保存原始数据用于更新操作
                window.originalServerData = {
                    ip: serverData.ip,
                    port: parseInt(serverData.port),
                    serviceType: serverData.serviceType,
                    remarks: serverData.remarks
                };
                console.log("Original server data saved:", window.originalServerData);
            }
        }

        // 显示弹窗
        setTimeout(function() {
            modal.removeClass("fade").addClass("show").css({
                "display": "block",
                "opacity": "1"
            });
        }, 10);
    }

    // 选择状态管理
    var selectedServers = [];
    
    // 全选/取消全选
    $(document).on("change", "#selectAll", function() {
        var isChecked = $(this).prop("checked");
        $(".server-checkbox").prop("checked", isChecked);
        updateSelectedServers();
    });
    
    // 单个选择框变化
    $(document).on("change", ".server-checkbox", function() {
        updateSelectedServers();
    });
    
    // 更新选择状态
    function updateSelectedServers() {
        selectedServers = [];
        $(".server-checkbox:checked").each(function() {
            var ip = $(this).val();
            var row = $(this).closest("tr");
            var port = row.find("td:nth-child(3)").text();
            selectedServers.push({ip: ip, port: port});
        });
        
        // 更新选择信息
        var count = selectedServers.length;
        $("#selectionInfo").text("已选择 " + count + " 项");
        
        // 显示/隐藏清空选择链接
        if (count > 0) {
            $("#clearSelection").show();
            $("#batchDeleteBtn").prop("disabled", false);
        } else {
            $("#clearSelection").hide();
            $("#batchDeleteBtn").prop("disabled", true);
        }
    }
    
    // 清空选择
    $("#clearSelection").on("click", function(e) {
        e.preventDefault();
        $(".server-checkbox, #selectAll").prop("checked", false);
        updateSelectedServers();
    });
    
    // 批量删除功能
    $("#batchDeleteBtn").on("click", function() {
        if (selectedServers.length === 0) {
            alert("请选择要删除的服务器");
            return;
        }

        if (confirm("确认要删除选中的 " + selectedServers.length + " 个服务器吗？删除后将无法恢复！")) {
            console.log("批量删除服务器:", selectedServers);
            
            // 调用批量删除API
            var deletePromises = selectedServers.map(function(server) {
                return new Promise(function(resolve, reject) {
                    requestOneModel("JianKongFuWuQi", "del", JSON.stringify({
                        ip: server.ip,
                        port: server.port
                    }));
                    resolve();
                });
            });

            Promise.all(deletePromises).then(function() {
                alert("成功删除 " + selectedServers.length + " 个服务器");
                // 清空选择
                $(".server-checkbox, #selectAll").prop("checked", false);
                selectedServers = [];
                updateSelectedServers();
                // 刷新服务器列表
                initialaze();
            }).catch(function(error) {
                console.error("批量删除失败:", error);
                alert("批量删除失败，请稍后重试");
            });
        }
    });

    // 关闭服务器弹窗
    function closeServerModal() {
        var modal = $("#serverModal");
        modal.removeClass("show").css({
            "display": "none",
            "opacity": "0"
        });

        // 清空表单
        var form = $("#serverForm")[0];
        if (form) {
            form.reset();
        }
        
        // 重置提交状态
        window.isSubmitting = false;

        console.log("Modal closed");
    }

    // 保存服务器
    function saveServer() {
        // 防重复提交保护
        if (window.isSubmitting) {
            console.log("正在提交中，请勿重复点击");
            return;
        }
        window.isSubmitting = true;
        
        var mode = $("#saveServerBtn").data("mode");
        var ip = $("#modalIp").val().trim();
        var port = $("#modalPort").val().trim();
        var serviceType = $("#modalServiceType").val();
        var remarks = $("#modalRemarks").val().trim();
        var status = $("#modalStatus").val();

        console.log("saveServer called with:", {mode, ip, port, serviceType, remarks, status});

        // 验证必填字段
        if (!ip) {
            alert("请输入IP地址");
            $("#modalIp").focus();
            return;
        }

        if (!port) {
            alert("请输入端口");
            $("#modalPort").focus();
            return;
        }

        if (!serviceType) {
            alert("请选择服务类型");
            $("#modalServiceType").focus();
            return;
        }

        // 验证IP格式
        var ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(ip)) {
            alert("请输入正确的IP地址格式");
            $("#modalIp").focus();
            return;
        }

        // 验证端口范围
        var portNum = parseInt(port);
        if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
            alert("请输入正确的端口号(1-65535)");
            $("#modalPort").focus();
            return;
        }

        var data = {
            ip: ip,
            port: portNum,
            serviceType: serviceType,
            remarks: remarks,
            status: status
        };

        console.log("Saving server data:", data);

        if (mode === 'create') {
            // 新增服务器 - 使用后端期望的字段名
            var createData = {
                ip: ip,
                port: portNum,
                server_category: serviceType,  // 映射到后端字段名
                remarks: remarks || ""
            };
            console.log("Creating server with data:", createData);

            // 再次验证数据
            if (!createData.ip || !createData.port || !createData.server_category) {
                alert("IP地址、端口和服务类型不能为空");
                return;
            }

            // 直接发送数据对象，不要JSON.stringify
            // 调用创建API
            requestOneModel("JianKongFuWuQi", "create", createData);
            
            // 重置提交状态
            setTimeout(() => {
                window.isSubmitting = false;
            }, 2000);
            
        } else if (mode === 'edit') {
            // 编辑服务器
            if (!window.originalServerData) {
                alert("原始数据丢失，请重新打开编辑窗口");
                window.isSubmitting = false;
                return;
            }

            var oldData = {
                ip: window.originalServerData.ip,
                port: window.originalServerData.port,
                server_category: window.originalServerData.serviceType,
                remarks: window.originalServerData.remarks
            };
            var newData = {
                ip: ip,
                port: portNum,  // 使用已验证的端口号
                server_category: serviceType,  // 使用服务类型
                remarks: remarks || ""  // 确保备注不为null
            };

            // 再次验证数据
            if (!newData.ip || !newData.port || !newData.server_category) {
                alert("IP地址、端口和服务类型不能为空");
                window.isSubmitting = false;
                return;
            }

            var updateData = {
                old: oldData,
                new: newData
            };

            console.log("Updating server with data:", updateData);
            console.log("Old data:", oldData);
            console.log("New data:", newData);

            // 直接发送数据对象，不要JSON.stringify
            requestOneModel("JianKongFuWuQi", "update", updateData);
            
            // 重置提交状态
            setTimeout(() => {
                window.isSubmitting = false;
            }, 2000);
        }

        closeServerModal();
    }

    // 渲染服务器表格
    function renderServerTable(serverData) {
        var tbody = $("#tbodyContent");
        tbody.empty();

        // 如果没有传入数据，使用模拟数据
        var servers = serverData || [
            {ip: "192.168.46.50", port: "7788", server_category: "监控代理", remarks: "主监控服务器"},
            {ip: "192.168.46.57", port: "22", server_category: "SSH", remarks: "远程管理服务器"},
            {ip: "192.168.1.100", port: "80", server_category: "Nginx", remarks: "Web前端服务器"}
        ];

        if (servers.length === 0) {
            tbody.append('<tr><td colspan="8" style="text-align: center; color: #999;">暂无数据</td></tr>');
            return;
        }

        servers.forEach(function(server, index) {
            var isOnline = Math.random() > 0.3; // 70%概率为在线状态
            var statusClass = isOnline ? 'status-online' : 'status-offline';
            var statusText = isOnline ? '在线' : '离线';

            // 处理服务类型字段名的兼容性
            var serviceType = server.server_category || server.serviceType || "";

            // 创建时间格式：2025/7/28 12:40:20
            var now = new Date();
            var createTime = now.getFullYear() + '/' +
                           (now.getMonth() + 1) + '/' +
                           now.getDate() + ' ' +
                           now.getHours().toString().padStart(2, '0') + ':' +
                           now.getMinutes().toString().padStart(2, '0') + ':' +
                           now.getSeconds().toString().padStart(2, '0');

            var row = `
                <tr data-ip="${server.ip}" data-online="${isOnline}">
                    <td>
                        <input type="checkbox" class="table-checkbox server-checkbox" value="${server.ip}">
                    </td>
                    <td>${server.ip}</td>
                    <td>${server.port}</td>
                    <td>${serviceType}</td>
                    <td>
                        <span class="status-indicator ${statusClass} toggle-status" title="点击切换状态">
                            <span class="status-dot"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td>${server.remarks || ""}</td>
                    <td>${createTime}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm revise" title="编辑">
                                编辑
                            </button>
                            <button class="btn btn-danger btn-sm del" title="删除">
                                删除
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

</script>
{%endblock%}