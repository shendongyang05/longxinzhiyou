{% extends "layout.html" %}
{%load static%}

{%block css%}
<style>
  .contentBox {
    position: relative;
    height: 65vh;
    overflow: auto;
  }

  .selectPage {
    height: 10px;

  }

  .btn {
    padding: 2px 6px;
  }

  #dropdownLiTag {
    height: 120px !important;
    overflow: auto;
    background-color: bisque;
    direction: rtl;
  }

  #dropdownLiTag li {
    color: black;
    padding: 5px;
  }

  #dropdownLiTag li:hover {
    cursor: pointer;
    background-color: rgb(197, 209, 219);
  }

  #createData  div{
    margin-top: 30px;
  }

  /* <reset-style> ============================ */
  .button {
    border: none;
    float: right;
    background: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-family: inherit;
    border-radius: 10px;
    margin: 0 10px;
  }

  /* <main-style> ============================ */
  .menu__button {
    min-width: 62px;
    height: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 8px 16px;
    background-color: #fff;
    transition: background-color .4s;
  }


  @keyframes linearGradientMove {
    100% {
      background-position: 6px 0, -6px 100%, 0 -6px, 100% 6px;
    }
  }

  input {
    height: 20px;
    border: 0;
    text-indent: 1em;
    margin-right: 10px;
    border-radius: 10px;
  }

/* 新增样式 - 按照用户管理风格 */
.search-section {
    background: white;
    padding: 20px;
    margin-bottom: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.search-left {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.search-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-item label {
    font-size: 14px;
    color: #333;
    white-space: nowrap;
    margin: 0;
}

.search-item .form-control {
    width: 200px;
    height: 32px;
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
}

.action-section {
    background: white;
    padding: 16px 20px;
    margin-bottom: 16px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.action-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.dropdown-container {
    position: relative;
    display: inline-block;
}

.info-bar {
    background: #f0f9ff;
    border: 1px solid #bae7ff;
    padding: 12px 20px;
    margin-bottom: 16px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.info-left {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1890ff;
    font-size: 14px;
}

.info-right {
    color: #999;
    font-size: 14px;
}

.table-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 16px;
}

.middleware-table {
    margin: 0;
    border: none;
    table-layout: fixed;
    width: 100%;
}

.middleware-table th {
    background: #fafafa;
    color: #000;
    font-weight: 500;
    padding: 12px 16px;
    border-bottom: 1px solid #e8e8e8;
    font-size: 14px;
    text-align: center !important;
    vertical-align: middle !important;
}

.middleware-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    color: #000;
    font-size: 14px;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.middleware-table tr:hover {
    background: #f8f9fa;
}

.table-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    margin: 0 auto;
    display: block;
}

.action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
    flex-wrap: nowrap;
}

.action-buttons .btn {
    padding: 4px 8px;
    font-size: 12px;
    min-width: 50px;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #000 !important;
    white-space: nowrap;
    flex-wrap: nowrap;
    justify-content: center;
    cursor: pointer;
    line-height: 1;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    order: -1;
    margin-right: 6px;
    margin-left: 0;
    align-self: center;
    vertical-align: middle;
}

.status-online .status-dot {
    background: #52c41a;
}

.status-offline .status-dot {
    background: #ff4d4f;
}

/* 分页样式 */
.pagination-container {
    background: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.pagination-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
}

.pagination-total {
    color: #666;
    font-size: 14px;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pagination-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #d9d9d9;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
    border-color: #1890ff;
    color: #1890ff;
}

.pagination-btn:disabled {
    color: #ccc;
    cursor: not-allowed;
    border-color: #f0f0f0;
}

.page-numbers {
    display: flex;
    gap: 4px;
}

.page-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #d9d9d9;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s ease;
}

.page-btn:hover {
    border-color: #1890ff;
    color: #1890ff;
}

.page-btn.active {
    background: #1890ff;
    border-color: #1890ff;
    color: white;
}

.page-size-select {
    height: 32px;
    padding: 4px 8px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    color: #666;
    background: white;
    cursor: pointer;
    min-width: 80px;
}

.page-size-select:focus {
    border-color: #1890ff;
    outline: none;
}

.goto-text {
    color: #666;
    font-size: 14px;
}

.goto-input {
    width: 50px;
    height: 32px;
    padding: 4px 8px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
    color: #666;
}

.goto-input:focus {
    border-color: #1890ff;
    outline: none;
}

/* 弹窗样式 */
.modal {
    display: none !important;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.show {
    display: block !important;
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: 10px;
    max-width: 500px;
    margin: 30px auto;
}

.modal-content {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    outline: 0;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #e8e8e8;
}

.modal-title {
    margin: 0;
    font-size: 18px;
    font-weight: 500;
    color: #333;
}

.modal-header .close {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-header .close:hover {
    color: #333;
}

.modal-body {
    padding: 24px;
    flex: 1 1 auto;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 16px 24px;
    border-top: 1px solid #e8e8e8;
    gap: 12px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    color: #333;
    font-size: 14px;
    font-weight: 500;
}

.required {
    color: #ff4d4f;
}

.form-group .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    color: #333;
    background: #fff;
    transition: border-color 0.3s ease;
}

.form-group .form-control:focus {
    border-color: #1890ff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

.btn-default {
    background: #fff;
    border: 1px solid #d9d9d9;
    color: #333;
}

.btn-default:hover {
    border-color: #1890ff;
    color: #1890ff;
}

/* 强制显示按钮样式 */
#createBtn, #batchDeleteBtn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 1000 !important;
}

#createBtn {
    background-color: #1890ff !important;
    border-color: #1890ff !important;
    color: white !important;
}

#batchDeleteBtn {
    background-color: #ff4d4f !important;
    border-color: #ff4d4f !important;
    color: white !important;
}

.action-section {
    display: block !important;
    visibility: visible !important;
    position: relative !important;
    z-index: 999 !important;
}

/* 确保表格中的编辑和删除按钮可见 */
.revise, .del {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.revise {
    background-color: #1890ff !important;
    border-color: #1890ff !important;
    color: white !important;
}

.del {
    background-color: #ff4d4f !important;
    border-color: #ff4d4f !important;
    color: white !important;
}

/* 强制显示模态框中的保存按钮 */
#saveMiddlewareBtn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background-color: #1890ff !important;
    border-color: #1890ff !important;
    color: white !important;
    padding: 8px 16px !important;
    border-radius: 4px !important;
}

.modal-footer {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.modal-footer .btn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

</style>
{%endblock%}

{%block content%}
<!-- 搜索区域 -->
<div class="search-section">
    <div class="search-left">
        <div class="search-item">
            <label>IP地址</label>
            <input id="ipadress" type="text" placeholder="请输入IP地址" class="form-control">
        </div>
        <div class="search-item">
            <label>中间件名称</label>
            <input id="middlewareNameSearch" type="text" placeholder="请输入中间件名称" class="form-control">
        </div>
        <button id="selectOneModel" class="btn btn-primary">
            <i class="el-icon-search"></i> 查询
        </button>
        <button id="resetSearch" class="btn btn-default">
            重置
        </button>
    </div>
</div>

<!-- 操作按钮区域 -->
<div class="action-section">
    <div class="action-left">
        <button id="createBtn" class="btn btn-primary">
            <i class="el-icon-plus"></i> 新增中间件
        </button>
        <button id="batchDeleteBtn" class="btn btn-danger" disabled>
            <i class="el-icon-delete"></i> 批量删除
        </button>
        <div class="dropdown-container">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                更多操作 <i class="el-icon-arrow-down"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#" id="exportSelected"><i class="el-icon-download"></i> 导出所选数据</a></li>
                <li><a href="#" id="exportAll"><i class="el-icon-download"></i> 导出全部数据</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- 提示栏 -->
<div class="info-bar">
    <div class="info-left">
        <i class="el-icon-info"></i>
        <span id="selectionInfo">已选择 0 项</span>
        <a href="#" id="clearSelection" style="display: none;">是否全部清空</a>
    </div>
    <div class="info-right">
        <span>当前选择的中间件将进行批量操作</span>
    </div>
</div>

<!-- 中间件弹窗 -->
<div class="modal fade" id="middlewareModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">新增中间件</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="middlewareForm">
                    <div class="form-group">
                        <label for="modalIp">IP地址 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="modalIp" placeholder="请输入IP地址" required>
                    </div>
                    <div class="form-group">
                        <label for="modalPort">端口 <span class="required">*</span></label>
                        <input type="number" class="form-control" id="modalPort" placeholder="请输入端口" required>
                    </div>
                    <div class="form-group">
                        <label for="modalServiceType">服务类型 <span class="required">*</span></label>
                        <select class="form-control" id="modalServiceType" required>
                            <option value="">请选择服务类型</option>
                            <!-- Web服务器 -->
                            <option value="Nginx">Nginx</option>
                            <option value="Apache">Apache</option>
                            <option value="IIS">IIS</option>
                            <option value="Lighttpd">Lighttpd</option>
                            <!-- 应用服务器 -->
                            <option value="Tomcat">Tomcat</option>
                            <option value="Jetty">Jetty</option>
                            <option value="WebLogic">WebLogic</option>
                            <option value="WebSphere">WebSphere</option>
                            <option value="JBoss">JBoss</option>
                            <option value="Undertow">Undertow</option>
                            <!-- 数据库 -->
                            <option value="MySQL">MySQL</option>
                            <option value="PostgreSQL">PostgreSQL</option>
                            <option value="Oracle">Oracle</option>
                            <option value="SQL Server">SQL Server</option>
                            <option value="MongoDB">MongoDB</option>
                            <option value="达梦数据库">达梦数据库</option>
                            <option value="人大金仓">人大金仓</option>
                            <option value="南大通用">南大通用</option>
                            <!-- 缓存服务 -->
                            <option value="Redis">Redis</option>
                            <option value="Memcached">Memcached</option>
                            <option value="Hazelcast">Hazelcast</option>
                            <!-- 消息队列 -->
                            <option value="RabbitMQ">RabbitMQ</option>
                            <option value="Kafka">Kafka</option>
                            <option value="ActiveMQ">ActiveMQ</option>
                            <option value="RocketMQ">RocketMQ</option>
                            <option value="Pulsar">Pulsar</option>
                            <!-- 搜索引擎 -->
                            <option value="Elasticsearch">Elasticsearch</option>
                            <option value="Solr">Solr</option>
                            <!-- 系统服务 -->
                            <option value="SSH">SSH</option>
                            <option value="FTP">FTP</option>
                            <option value="SFTP">SFTP</option>
                            <option value="Telnet">Telnet</option>
                            <option value="SNMP">SNMP</option>
                            <option value="DNS">DNS</option>
                            <option value="DHCP">DHCP</option>
                            <option value="NTP">NTP</option>
                            <!-- 监控服务 -->
                            <option value="监控代理">监控代理</option>
                            <option value="Prometheus">Prometheus</option>
                            <option value="Grafana">Grafana</option>
                            <option value="Zabbix">Zabbix</option>
                            <option value="Nagios">Nagios</option>
                            <!-- 容器服务 -->
                            <option value="Docker">Docker</option>
                            <option value="Kubernetes">Kubernetes</option>
                            <option value="Containerd">Containerd</option>
                            <!-- 负载均衡 -->
                            <option value="HAProxy">HAProxy</option>
                            <option value="LVS">LVS</option>
                            <option value="F5">F5</option>
                            <!-- 文件服务 -->
                            <option value="Samba">Samba</option>
                            <option value="NFS">NFS</option>
                            <option value="MinIO">MinIO</option>
                            <!-- 其他服务 -->
                            <option value="Jenkins">Jenkins</option>
                            <option value="GitLab">GitLab</option>
                            <option value="Nexus">Nexus</option>
                            <option value="SonarQube">SonarQube</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalStatus">状态</label>
                        <select class="form-control" id="modalStatus">
                            <option value="在线">在线</option>
                            <option value="离线">离线</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalRemarks">备注</label>
                        <textarea class="form-control" id="modalRemarks" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveMiddlewareBtn">保存</button>
            </div>
        </div>
    </div>
</div>
<!-- 表格区域 -->
<div class="table-container">
    <table class="table table-bordered middleware-table">
        <thead>
            <tr>
                <th width="50">
                    <input type="checkbox" id="selectAll" class="table-checkbox">
                </th>
                <th width="120">IP地址</th>
                <th width="80">端口</th>
                <th width="120">服务类型</th>
                <th width="80">状态</th>
                <th width="200">备注</th>
                <th width="160">创建时间</th>
                <th width="140">操作</th>
            </tr>
        </thead>
        <tbody id="tbodyContent">
            <!-- 动态加载 -->
        </tbody>
    </table>
</div>

<!-- 分页区域 -->
<div class="pagination-container">
    <div class="pagination-wrapper">
        <span class="pagination-total">共 <span id="totalCount">4</span> 条</span>
        <div class="pagination-controls">
            <button class="pagination-btn" id="prevPage" disabled>&lt;</button>
            <span class="page-numbers" id="pageNumbers">
                <button class="page-btn active">1</button>
            </span>
            <button class="pagination-btn" id="nextPage">&gt;</button>
            <select class="page-size-select" id="pageSizeSelect">
                <option value="10">10 条/页</option>
                <option value="20">20 条/页</option>
                <option value="50">50 条/页</option>
            </select>
            <span class="goto-text">跳至</span>
            <input type="number" class="goto-input" id="gotoPage" min="1" value="1">
            <span class="goto-text">页</span>
        </div>
    </div>
</div>

</div>


{%endblock%}

{%block js%}
<script>
  // 初始化
  function initialaze() {
    requestOneModel("FuWuXinXi", "select", "{}", "1-50")
  }

  $(document).ready(function () {
    // 定义全局变量（避免undefined错误）
    window.reviseTag = $("#saveMiddlewareBtn"); // 使用保存按钮作为修改按钮
    window.submitTag = $("#saveMiddlewareBtn");  // 使用保存按钮作为提交按钮
    window.creatDataTag = $("#middlewareModal"); // 使用模态框

    var name = "FuWuXinXi";
    var type = "";
    var values = "";
    var oldData = "";
    var newData = "";

    // 初始化数据
    renderMiddlewareTable();

    // 新增中间件按钮
    $("#createBtn").on("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("Create button clicked");
        openMiddlewareModal('create');
    });

    // 编辑中间件按钮
    $(document).on("click", ".revise", function (e) {
        e.preventDefault();
        console.log("Edit button clicked");

        var row = $(this).closest("tr");
        var ip = row.find("td:nth-child(2)").text();
        var port = row.find("td:nth-child(3)").text();
        var serviceType = row.find("td:nth-child(4)").text();
        var status = row.find("td:nth-child(5)").text().trim();
        var remarks = row.find("td:nth-child(6)").text();

        console.log("Edit data:", {ip, port, serviceType, status, remarks});

        openMiddlewareModal('edit', {
            ip: ip,
            port: port,
            serviceType: serviceType,
            status: status,
            remarks: remarks
        });
    });

    // 保存中间件按钮
    $("#saveMiddlewareBtn").on("click", function() {
        saveMiddleware();
    });

    // 弹窗关闭事件
    $(document).on("click", ".close, [data-dismiss='modal']", function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("Close button clicked");
        closeMiddlewareModal();
    });

    // 点击弹窗外部关闭
    $(document).on("click", "#middlewareModal", function(e) {
        if (e.target === this) {
            console.log("Clicked outside modal content");
            closeMiddlewareModal();
        }
    });

    // 阻止弹窗内容区域的点击事件冒泡
    $(document).on("click", ".modal-content", function(e) {
        e.stopPropagation();
    });

    // 状态切换功能
    $(document).on("click", ".toggle-status", function () {
        var row = $(this).closest("tr");
        var ip = row.data("ip");
        var isOnline = row.data("online");
        var action = isOnline ? "设为离线" : "设为在线";

        var confirmMessage = `确认要${action}中间件 "${ip}" 吗？`;

        if (confirm(confirmMessage)) {
            // 更新UI
            var newOnline = !isOnline;
            row.data("online", newOnline);

            var statusIndicator = $(this);

            if (newOnline) {
                statusIndicator.removeClass("status-offline").addClass("status-online");
                statusIndicator.html('<span class="status-dot"></span>在线');
            } else {
                statusIndicator.removeClass("status-online").addClass("status-offline");
                statusIndicator.html('<span class="status-dot"></span>离线');
            }

            console.log(`中间件 ${ip} 已${action}`);
        }
    });

    //初始化页面数据
    console.log("FuWuXinXiGuanLi.html loaded - using FuWuXinXi API");

    // 检查按钮是否存在
    console.log("createBtn exists:", $("#createBtn").length > 0);
    console.log("createBtn visible:", $("#createBtn").is(":visible"));
    console.log("createBtn CSS display:", $("#createBtn").css("display"));

    // 强制显示按钮
    function forceShowButtons() {
        $("#createBtn").show().css({
            'display': 'inline-block',
            'visibility': 'visible',
            'opacity': '1'
        });
        $("#batchDeleteBtn").show().css({
            'display': 'inline-block',
            'visibility': 'visible',
            'opacity': '1'
        });
        $(".action-section").show().css({
            'display': 'block',
            'visibility': 'visible'
        });

        // 强制显示模态框中的保存按钮
        $("#saveMiddlewareBtn").show().css({
            'display': 'inline-block',
            'visibility': 'visible',
            'opacity': '1'
        });
        $(".modal-footer").show().css({
            'display': 'flex',
            'visibility': 'visible',
            'opacity': '1'
        });

        console.log("All buttons forced to show");
        console.log("saveMiddlewareBtn exists:", $("#saveMiddlewareBtn").length > 0);
        console.log("saveMiddlewareBtn visible:", $("#saveMiddlewareBtn").is(":visible"));
    }

    // 立即执行
    forceShowButtons();

    // 延迟执行，确保DOM完全加载
    setTimeout(forceShowButtons, 100);

    // 添加调试函数
    window.debugModal = function() {
        console.log("=== Modal Debug Info ===");
        console.log("Modal exists:", $("#middlewareModal").length > 0);
        console.log("Modal visible:", $("#middlewareModal").is(":visible"));
        console.log("Save button exists:", $("#saveMiddlewareBtn").length > 0);
        console.log("Save button visible:", $("#saveMiddlewareBtn").is(":visible"));
        console.log("Modal footer exists:", $(".modal-footer").length > 0);
        console.log("Modal footer visible:", $(".modal-footer").is(":visible"));
        console.log("Save button CSS display:", $("#saveMiddlewareBtn").css("display"));
        console.log("Save button CSS visibility:", $("#saveMiddlewareBtn").css("visibility"));
        console.log("Save button CSS opacity:", $("#saveMiddlewareBtn").css("opacity"));
    };

    initialaze()

    // 注意：新的界面使用模态框，这些旧的事件绑定可能不再需要
    // 但为了兼容性，我们保留一些基本功能

    // 如果需要通过编程方式触发保存操作
    function triggerSave(isUpdate) {
      if (isUpdate) {
        var newData = get_value();
        if (newData) {
          var values = JSON.stringify({ "old": oldData, "new": newData });
          requestOneModel(name, "update", values);
        }
      } else {
        var values = get_value();
        if (values) {
          requestOneModel(name, "create", values);
        }
      }
    }

    // 注释掉对不存在元素的引用
    // 这些功能在新界面中可能不需要或者有不同的实现方式

    /*
    //绑定查询事件
    $("#selectOneModel").on("click", function () {
      type = "select";
      ipValue = JSON.stringify({
        "ip": $("#ipadress").val()
      })

      requestOneModel(name, type, ipValue)
    })

    //绑定选择页码
    $(".choose").on("click", function () {
      $("#dropdownLiTag").children().on("click", function () {
        type = "select";
        indexs = getNumber($(this).text())
        numberRange = indexs[0] + "-" + indexs[1]
        requestOneModel(name, type, "{}", numberRange)
      })
    })
    */

    // 使用事件委托给删除按钮添加点击事件
    $(document).on("click", ".del", function () {
      var row = $(this).closest("tr");
      var ip = row.find("td:nth-child(2)").text();
      var port = row.find("td:nth-child(3)").text();

      var confirmMessage = `确认要删除中间件 "${ip}:${port}" 吗？`;

      var bool = confirm(confirmMessage);
      if (bool) {
        var type = "del"
        var values = JSON.stringify({ "ip": ip, "port": port })
        requestOneModel(name, type, values)
      }
    });

    // 编辑按钮点击事件（这个事件已经在上面的代码中处理了）
    // 这里保留一个备用的处理函数
    $(document).on("click", ".revise", function () {
      var row = $(this).closest("tr");
      var ipValue = row.find("td:nth-child(2)").text();
      var portValue = row.find("td:nth-child(3)").text();
      var severCategoryValue = row.find("td:nth-child(4)").text();
      var remarkValue = row.find("td:nth-child(6)").text();

      // 保存旧数据用于更新操作
      oldData = JSON.stringify({
        ip: ipValue,
        port: portValue,
        server_category: severCategoryValue,
        remarks: remarkValue
      });

      // 打开编辑模态框
      openMiddlewareModal('edit', {
        ip: ipValue,
        port: portValue,
        serviceType: severCategoryValue,
        remarks: remarkValue
      });
    });

    // 工具函数
    function set_value(ip, port, server, remark) {
      $("#modalIp").val(ip);
      $("#modalPort").val(port);
      $("#modalServiceType").val(server);
      $("#modalRemarks").val(remark);
    }

    function get_value() {
      var ipValue = $("#modalIp").val();
      var portValue = $("#modalPort").val();
      var severCategoryValue = $("#modalServiceType").val();
      var remarkValue = $("#modalRemarks").val();
      if (
        ipValue === '' ||
        portValue === '' ||
        severCategoryValue === "" ||
        remarkValue === ''
      ) {
        // 弹窗提示有空输入框
        alert('请输入完整信息');
        return null;
      }
      // 创建一个对象并设置键值对
      var data = {
        ip: ipValue,
        port: portValue,
        server_category: severCategoryValue,
        remarks: remarkValue
      };

      // 将对象转换为 JSON 字符串并返回
      return JSON.stringify(data);
    }

  });

  // 打开中间件弹窗
  function openMiddlewareModal(mode, middlewareData) {
      console.log("Opening modal in mode:", mode);

      var modal = $("#middlewareModal");
      var title = $("#modalTitle");
      var saveBtn = $("#saveMiddlewareBtn");

      // 清空表单
      var form = $("#middlewareForm")[0];
      if (form) {
          form.reset();
      }

      if (mode === 'create') {
          title.text("新增中间件");
          saveBtn.text("保存").data("mode", "create");
          $("#modalIp").prop("readonly", false);
      } else if (mode === 'edit') {
          title.text("编辑中间件");
          saveBtn.text("更新").data("mode", "edit");
          $("#modalIp").prop("readonly", true);

          // 填充数据
          if (middlewareData) {
              $("#modalIp").val(middlewareData.ip);
              $("#modalPort").val(middlewareData.port);
              $("#modalServiceType").val(middlewareData.serviceType);
              $("#modalStatus").val(middlewareData.status.replace(/在线|离线/, function(match) {
                  return match === '在线' ? '在线' : '离线';
              }));
              $("#modalRemarks").val(middlewareData.remarks);
          }
      }

      // 显示弹窗
      setTimeout(function() {
          modal.removeClass("fade").addClass("show").css({
              "display": "block",
              "opacity": "1"
          });

          // 强制显示保存按钮
          $("#saveMiddlewareBtn").show().css({
              'display': 'inline-block',
              'visibility': 'visible',
              'opacity': '1'
          });
          $(".modal-footer").show().css({
              'display': 'flex',
              'visibility': 'visible',
              'opacity': '1'
          });
          console.log("Modal opened, save button forced to show");
      }, 10);
  }

  // 关闭中间件弹窗
  function closeMiddlewareModal() {
      var modal = $("#middlewareModal");
      modal.removeClass("show").css({
          "display": "none",
          "opacity": "0"
      });

      // 清空表单
      var form = $("#middlewareForm")[0];
      if (form) {
          form.reset();
      }

      console.log("Modal closed");
  }

  // 保存中间件
  function saveMiddleware() {
      var mode = $("#saveMiddlewareBtn").data("mode");
      var ip = $("#modalIp").val().trim();
      var port = $("#modalPort").val().trim();
      var serviceType = $("#modalServiceType").val();
      var status = $("#modalStatus").val();
      var remarks = $("#modalRemarks").val().trim();

      // 验证必填字段
      if (!ip) {
          alert("请输入IP地址");
          $("#modalIp").focus();
          return;
      }

      if (!port) {
          alert("请输入端口");
          $("#modalPort").focus();
          return;
      }

      if (!serviceType) {
          alert("请选择服务类型");
          $("#modalServiceType").focus();
          return;
      }

      // 验证IP格式
      var ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
      if (!ipPattern.test(ip)) {
          alert("请输入正确的IP地址格式");
          $("#modalIp").focus();
          return;
      }

      // 验证端口范围
      var portNum = parseInt(port);
      if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
          alert("请输入正确的端口号(1-65535)");
          $("#modalPort").focus();
          return;
      }

      var data = {
          ip: ip,
          port: portNum,
          severCategory: serviceType,
          remark: remarks
      };

      console.log("Saving middleware data:", data);

      if (mode === 'create') {
          // 新增中间件
          console.log("Calling requestOneModel with:", "FuWuXinXi", "create", JSON.stringify(data));
          requestOneModel("FuWuXinXi", "create", JSON.stringify(data));
      } else if (mode === 'edit') {
          // 编辑中间件
          var updateData = {
              old: JSON.stringify({ip: ip, port: port, severCategory: serviceType, remark: remarks}),
              new: JSON.stringify(data)
          };
          requestOneModel("FuWuXinXi", "update", JSON.stringify(updateData));
      }

      closeMiddlewareModal();
  }

  // 渲染中间件表格
  function renderMiddlewareTable() {
      var tbody = $("#tbodyContent");
      tbody.empty();

      // 模拟中间件数据
      var middlewares = [
          {ip: "192.168.1.100", port: "80", serviceType: "Nginx", remarks: "Web前端服务器"},
          {ip: "192.168.1.101", port: "8080", serviceType: "Tomcat", remarks: "Java应用服务器"},
          {ip: "192.168.1.102", port: "6379", serviceType: "Redis", remarks: "Redis缓存服务器"},
          {ip: "192.168.1.103", port: "5672", serviceType: "RabbitMQ", remarks: "消息队列服务"},
          {ip: "192.168.1.104", port: "9200", serviceType: "Elasticsearch", remarks: "搜索引擎服务"},
          {ip: "192.168.1.105", port: "9092", serviceType: "Kafka", remarks: "分布式消息系统"},
          {ip: "192.168.1.106", port: "3306", serviceType: "MySQL", remarks: "MySQL数据库"},
          {ip: "192.168.1.107", port: "5432", serviceType: "PostgreSQL", remarks: "PostgreSQL数据库"},
          {ip: "192.168.1.108", port: "1521", serviceType: "Oracle", remarks: "Oracle数据库"},
          {ip: "192.168.1.109", port: "5236", serviceType: "达梦数据库", remarks: "国产达梦数据库"},
          {ip: "192.168.1.110", port: "9090", serviceType: "Prometheus", remarks: "监控数据收集"},
          {ip: "192.168.1.111", port: "3000", serviceType: "Grafana", remarks: "监控数据可视化"},
          {ip: "192.168.1.112", port: "8080", serviceType: "Jenkins", remarks: "CI/CD构建服务"},
          {ip: "192.168.1.113", port: "9000", serviceType: "MinIO", remarks: "对象存储服务"},
          {ip: "192.168.1.114", port: "11211", serviceType: "Memcached", remarks: "内存缓存服务"},
          {ip: "192.168.1.115", port: "2375", serviceType: "Docker", remarks: "容器运行时"},
          {ip: "192.168.1.116", port: "8443", serviceType: "Kubernetes", remarks: "容器编排平台"},
          {ip: "192.168.1.117", port: "8080", serviceType: "WebLogic", remarks: "Oracle应用服务器"},
          {ip: "192.168.1.118", port: "9080", serviceType: "WebSphere", remarks: "IBM应用服务器"},
          {ip: "192.168.1.119", port: "8080", serviceType: "JBoss", remarks: "RedHat应用服务器"}
      ];

      if (middlewares.length === 0) {
          tbody.append('<tr><td colspan="8" style="text-align: center; color: #999;">暂无数据</td></tr>');
          return;
      }

      middlewares.forEach(function(middleware, index) {
          var isOnline = Math.random() > 0.3; // 70%概率为在线状态
          var statusClass = isOnline ? 'status-online' : 'status-offline';
          var statusText = isOnline ? '在线' : '离线';
          var createTime = new Date().toISOString().slice(0, 19).replace('T', ' ');

          var row = `
              <tr data-ip="${middleware.ip}" data-online="${isOnline}">
                  <td>
                      <input type="checkbox" class="table-checkbox middleware-checkbox" value="${middleware.ip}">
                  </td>
                  <td>${middleware.ip}</td>
                  <td>${middleware.port}</td>
                  <td>${middleware.serviceType}</td>
                  <td>
                      <span class="status-indicator ${statusClass} toggle-status" title="点击切换状态">
                          <span class="status-dot"></span>
                          ${statusText}
                      </span>
                  </td>
                  <td>${middleware.remarks}</td>
                  <td>${createTime}</td>
                  <td>
                      <div class="action-buttons">
                          <button class="btn btn-primary btn-sm revise" title="编辑">
                              编辑
                          </button>
                          <button class="btn btn-danger btn-sm del" title="删除">
                              删除
                          </button>
                      </div>
                  </td>
              </tr>
          `;
          tbody.append(row);
      });
  }

</script>
{%endblock%}